// MIT License - Feel free to use, modify, and share.
// Â© Adaptive RSI Pro - Dynamic Thresholds + MTF + Divergence + Statistics

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ EMOJI LEGEND / ä¿¡å·å›¾ä¾‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ CHART SIGNALS / å›¾è¡¨ä¿¡å·                                                    â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ BUY / ä¹°å…¥ (æ˜¾ç¤ºåœ¨åº•éƒ¨)                                                     â”‚
// â”‚   ğŸŒŸ MTF Resonance + Extreme Oversold  å¤šå‘¨æœŸå…±æŒ¯+æç«¯è¶…å– (æœ€å¼ºä¹°å…¥ä¿¡å·)    â”‚
// â”‚   ğŸ’ Divergence + Extreme Oversold     èƒŒç¦»+æç«¯è¶…å– (å¼ºä¹°å…¥ä¿¡å·)            â”‚
// â”‚   ğŸ”¥ Extreme Oversold (P5)             æç«¯è¶…å– (ä¹°å…¥ä¿¡å·)                   â”‚
// â”‚   â¬†ï¸ Normal Oversold (P10)              æ™®é€šè¶…å– (å¼±ä¹°å…¥ï¼Œé»˜è®¤éšè—)          â”‚
// â”‚   â†—ï¸ Bullish Divergence Only            çœ‹æ¶¨èƒŒç¦» (æ½œåœ¨åº•éƒ¨ï¼Œéä¿¡å·)          â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ SELL / å–å‡º (æ˜¾ç¤ºåœ¨é¡¶éƒ¨)                                                    â”‚
// â”‚   ğŸŒŸ MTF Resonance + Extreme Overbought å¤šå‘¨æœŸå…±æŒ¯+æç«¯è¶…ä¹° (æœ€å¼ºå–å‡ºä¿¡å·)   â”‚
// â”‚   ğŸ’ Divergence + Extreme Overbought    èƒŒç¦»+æç«¯è¶…ä¹° (å¼ºå–å‡ºä¿¡å·)           â”‚
// â”‚   â„ï¸ Extreme Overbought (P95)           æç«¯è¶…ä¹° (å–å‡ºä¿¡å·)                  â”‚
// â”‚   â¬‡ï¸ Normal Overbought (P90)            æ™®é€šè¶…ä¹° (å¼±å–å‡ºï¼Œé»˜è®¤éšè—)          â”‚
// â”‚   â†˜ï¸ Bearish Divergence Only            çœ‹è·ŒèƒŒç¦» (æ½œåœ¨é¡¶éƒ¨ï¼Œéä¿¡å·)          â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ DASHBOARD STATUS / ä»ªè¡¨ç›˜çŠ¶æ€                                               â”‚
// â”‚   ğŸŸ¢ Bullish/Oversold  çœ‹æ¶¨/è¶…å–çŠ¶æ€                                        â”‚
// â”‚   ğŸ”´ Bearish/Overbought çœ‹è·Œ/è¶…ä¹°çŠ¶æ€                                       â”‚
// â”‚   ğŸŸ¡ Mild Oversold     è½»åº¦è¶…å–                                             â”‚
// â”‚   ğŸŸ  Mild Overbought   è½»åº¦è¶…ä¹°                                             â”‚
// â”‚   âšª Neutral           ä¸­æ€§çŠ¶æ€                                             â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ ALERTS / è­¦æŠ¥                                                               â”‚
// â”‚   ğŸ“ˆ Trend Shift Up    è¶‹åŠ¿å‘ä¸Š (RSIä¸Šç©¿P50)                                â”‚
// â”‚   ğŸ“‰ Trend Shift Down  è¶‹åŠ¿å‘ä¸‹ (RSIä¸‹ç©¿P50)                                â”‚
// â”‚   âš¡ Any Extreme       ä»»æ„æç«¯ä¿¡å·                                         â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

//@version=5
indicator("Adaptive RSI Pro", shorttitle="ARSI Pro", overlay=false, precision=2, max_lines_count=100, max_labels_count=100)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grp_rsi = "â•â•â• RSI Settings / RSIè®¾ç½® â•â•â•"
rsi_length = input.int(14, "RSI Length / RSIå‘¨æœŸ", minval=2, group=grp_rsi)
rsi_source = input.source(close, "RSI Source / æ•°æ®æº", group=grp_rsi)

grp_adaptive = "â•â•â• Adaptive Settings / è‡ªé€‚åº”è®¾ç½® â•â•â•"
lookback = input.int(252, "Lookback Period / å›çœ‹å‘¨æœŸ", minval=50, maxval=2000, tooltip="å»ºè®®ï¼šæ—¥çº¿252ï¼Œ4å°æ—¶1000ï¼Œ1å°æ—¶2000", group=grp_adaptive)

grp_visual = "â•â•â• Visual Settings / è§†è§‰è®¾ç½® â•â•â•"
show_fill = input.bool(true, "Show Gradient Fill / æ˜¾ç¤ºæ¸å˜å¡«å……", group=grp_visual)
show_dashboard = input.bool(true, "Show Dashboard / æ˜¾ç¤ºä»ªè¡¨ç›˜", group=grp_visual)
dashboard_size = input.string("Normal", "Dashboard Size / é¢æ¿å¤§å°", options=["Tiny", "Small", "Normal", "Large"], group=grp_visual)
dashboard_transparency = input.int(30, "Dashboard Transparency / é¢æ¿é€æ˜åº¦", minval=0, maxval=100, step=10, group=grp_visual)
color_bull = input.color(color.new(#00E676, 60), "Bullish Color / ç‰›å¸‚é¢œè‰²", group=grp_visual)
color_bear = input.color(color.new(#FF5252, 60), "Bearish Color / ç†Šå¸‚é¢œè‰²", group=grp_visual)
color_rsi = input.color(#FFEB3B, "RSI Line Color / RSIçº¿é¢œè‰²", group=grp_visual)

grp_alerts = "â•â•â• Alert Settings / è­¦æŠ¥è®¾ç½® â•â•â•"
enable_extreme_alerts = input.bool(true, "Extreme Alerts (P5/P95) / æç«¯è­¦æŠ¥", group=grp_alerts)
enable_normal_alerts = input.bool(false, "Normal Alerts (P10/P90) / æ™®é€šè­¦æŠ¥", group=grp_alerts)
show_normal_signals = input.bool(false, "Show Normal Signals (P10/P90) / æ˜¾ç¤ºæ™®é€šä¿¡å·", group=grp_alerts, tooltip="â¬†ï¸â¬‡ï¸ æ™®é€šè¶…ä¹°/è¶…å–ä¿¡å·ï¼Œé»˜è®¤å…³é—­")

grp_trend = "â•â•â• Trend Filter / è¶‹åŠ¿è¿‡æ»¤ â•â•â•"
enable_trend_filter = input.bool(false, "Enable Trend Filter / å¯ç”¨è¶‹åŠ¿è¿‡æ»¤", group=grp_trend, tooltip="ä»…åœ¨è¶‹åŠ¿æ–¹å‘è§¦å‘ä¿¡å·ï¼šä¸Šå‡è¶‹åŠ¿åªåšå¤šï¼Œä¸‹é™è¶‹åŠ¿åªåšç©º")
trend_filter_mode = input.string("Auto", "Filter Mode / è¿‡æ»¤æ¨¡å¼", options=["Auto", "Fixed 50", "Adaptive P50", "SMA(RSI)", "BB(RSI)"], group=grp_trend, tooltip="Auto: æ ¹æ®RSIæ³¢åŠ¨è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ¨¡å¼")

grp_mtf = "â•â•â• Multi-Timeframe / å¤šæ—¶é—´æ¡†æ¶ â•â•â•"
enable_mtf = input.bool(true, "Enable MTF RSI / å¯ç”¨å¤šæ—¶é—´æ¡†æ¶", group=grp_mtf)
mtf_tf1 = input.timeframe("60", "Timeframe 1 / æ—¶é—´æ¡†æ¶1", group=grp_mtf)
mtf_tf2 = input.timeframe("240", "Timeframe 2 / æ—¶é—´æ¡†æ¶2", group=grp_mtf)
mtf_tf3 = input.timeframe("D", "Timeframe 3 / æ—¶é—´æ¡†æ¶3", group=grp_mtf)

grp_stats = "â•â•â• Signal Statistics / ä¿¡å·ç»Ÿè®¡ â•â•â•"
enable_stats = input.bool(true, "Enable Statistics / å¯ç”¨ç»Ÿè®¡", group=grp_stats)
stats_forward_bars = input.int(20, "Forward Bars / å‰ç»Kçº¿æ•°", minval=5, maxval=100, group=grp_stats, tooltip="ä¿¡å·è§¦å‘åå¤šå°‘æ ¹Kçº¿è®¡ç®—æ”¶ç›Š")

grp_divergence = "â•â•â• Divergence Settings / èƒŒç¦»è®¾ç½® â•â•â•"
enable_divergence = input.bool(true, "Enable Divergence Detection / å¯ç”¨èƒŒç¦»æ£€æµ‹", group=grp_divergence)
div_lookback = input.int(5, "Pivot Lookback / æ¢è½´å›çœ‹", minval=2, maxval=20, group=grp_divergence, tooltip="ç”¨äºæ£€æµ‹é«˜ä½ç‚¹çš„å›çœ‹å‘¨æœŸ")
div_range = input.int(60, "Max Range / æœ€å¤§èŒƒå›´", minval=20, maxval=200, group=grp_divergence, tooltip="èƒŒç¦»æ£€æµ‹çš„æœ€å¤§Kçº¿èŒƒå›´")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ RSI CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rsi = ta.rsi(rsi_source, rsi_length)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ ADAPTIVE PERCENTILE CALCULATION (Nearest Rank - More Accurate)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ä½¿ç”¨ percentile_nearest_rank è·å¾—æ›´ç²¾å‡†çš„åˆ†å¸ƒ (ä¿ç•™ç”¨äºè§†è§‰å‚è€ƒ)
rsi_p5  = ta.percentile_nearest_rank(rsi, lookback, 5)
rsi_p10 = ta.percentile_nearest_rank(rsi, lookback, 10)
rsi_p25 = ta.percentile_nearest_rank(rsi, lookback, 25)
rsi_p50 = ta.percentile_nearest_rank(rsi, lookback, 50)
rsi_p75 = ta.percentile_nearest_rank(rsi, lookback, 75)
rsi_p90 = ta.percentile_nearest_rank(rsi, lookback, 90)
rsi_p95 = ta.percentile_nearest_rank(rsi, lookback, 95)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ RSI Z-SCORE CALCULATION (ç»Ÿè®¡å­¦æ–¹æ³•)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Z-Score = (å½“å‰å€¼ - å¹³å‡å€¼) / æ ‡å‡†å·®
rsi_mean = ta.sma(rsi, lookback)
rsi_stdev = ta.stdev(rsi, lookback)
rsi_zscore = rsi_stdev != 0 ? (rsi - rsi_mean) / rsi_stdev : 0

// Z-Score åŠ¨æ€é˜ˆå€¼çº¿ (ç”¨äºç»˜å›¾)
zscore_upper_2 = rsi_mean + rsi_stdev * 2    // +2Ïƒ æç«¯è¶…ä¹°
zscore_upper_1_5 = rsi_mean + rsi_stdev * 1.5  // +1.5Ïƒ è¶…ä¹°
zscore_lower_1_5 = rsi_mean - rsi_stdev * 1.5  // -1.5Ïƒ è¶…å–
zscore_lower_2 = rsi_mean - rsi_stdev * 2    // -2Ïƒ æç«¯è¶…å–

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ TREND FILTER / è¶‹åŠ¿è¿‡æ»¤ (Auto-Adaptive)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// è®¡ç®—å„ç§è¿‡æ»¤åŸºå‡†çº¿
rsi_sma = ta.sma(rsi, 20)
rsi_bb_basis = ta.sma(rsi, 20)  // BB(RSI) ä¸­è½¨

// RSI æ³¢åŠ¨ç‡æ£€æµ‹ (ç”¨äºè‡ªåŠ¨æ¨¡å¼é€‰æ‹©)
rsi_volatility = ta.stdev(rsi, 50)

// è®¡ç®—æ³¢åŠ¨ç‡çš„å†å²åˆ†ä½æ•° (è‡ªé€‚åº”é˜ˆå€¼)
rsi_vol_p25 = ta.percentile_nearest_rank(rsi_volatility, 100, 25)  // ä½æ³¢åŠ¨é˜ˆå€¼
rsi_vol_p75 = ta.percentile_nearest_rank(rsi_volatility, 100, 75)  // é«˜æ³¢åŠ¨é˜ˆå€¼

// è‡ªåŠ¨æ¨¡å¼é€‰æ‹©é€»è¾‘ (å®Œå…¨è‡ªé€‚åº”):
// - ä½æ³¢åŠ¨ (< P25): Fixed 50 è¶³å¤Ÿç¨³å®š
// - ä¸­æ³¢åŠ¨ (P25-P75): Adaptive P50 é€‚åº”æ€§æ›´å¥½  
// - é«˜æ³¢åŠ¨ (> P75): BB(RSI) æ›´èƒ½å¤„ç†å‰§çƒˆæ³¢åŠ¨
auto_selected_mode = rsi_volatility < rsi_vol_p25 ? "Fixed 50" :
                     rsi_volatility > rsi_vol_p75 ? "BB(RSI)" : "Adaptive P50"

// å®é™…ä½¿ç”¨çš„æ¨¡å¼
active_mode = trend_filter_mode == "Auto" ? auto_selected_mode : trend_filter_mode

// æ ¹æ®æ´»åŠ¨æ¨¡å¼è®¡ç®—è¶‹åŠ¿æ–¹å‘
trend_up = active_mode == "Fixed 50" ? rsi > 50 :
           active_mode == "Adaptive P50" ? rsi > rsi_p50 :
           active_mode == "SMA(RSI)" ? rsi > rsi_sma :
           rsi > rsi_bb_basis  // BB(RSI)
trend_down = not trend_up

// æ˜¾ç¤ºæ–‡æœ¬ (åŒ…å«ä½¿ç”¨çš„æ¨¡å¼)
trend_mode_display = trend_filter_mode == "Auto" ? "[" + auto_selected_mode + "]" : ""
trend_text = trend_up ? "â†‘ UP " + trend_mode_display : "â†“ DOWN " + trend_mode_display
trend_color = trend_up ? color_bull : color_bear

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ MULTI-TIMEFRAME RSI / å¤šæ—¶é—´æ¡†æ¶RSI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// MTF RSI è®¡ç®—
f_rsi_mtf(_tf) =>
    request.security(syminfo.tickerid, _tf, rsi, lookahead=barmerge.lookahead_off)

f_percentiles_mtf(_tf) =>
    [request.security(syminfo.tickerid, _tf, rsi_p10, lookahead=barmerge.lookahead_off),
     request.security(syminfo.tickerid, _tf, rsi_p90, lookahead=barmerge.lookahead_off)]

rsi_tf1 = enable_mtf ? f_rsi_mtf(mtf_tf1) : na
rsi_tf2 = enable_mtf ? f_rsi_mtf(mtf_tf2) : na
rsi_tf3 = enable_mtf ? f_rsi_mtf(mtf_tf3) : na

// MTF percentiles - éœ€è¦åˆ†å¼€å¤„ç†å› ä¸º Pine Script ä¸æ”¯æŒä¸‰å…ƒæ“ä½œç¬¦è¿”å›å…ƒç»„
[p10_tf1_raw, p90_tf1_raw] = f_percentiles_mtf(mtf_tf1)
[p10_tf2_raw, p90_tf2_raw] = f_percentiles_mtf(mtf_tf2)
[p10_tf3_raw, p90_tf3_raw] = f_percentiles_mtf(mtf_tf3)

p10_tf1 = enable_mtf ? p10_tf1_raw : na
p90_tf1 = enable_mtf ? p90_tf1_raw : na
p10_tf2 = enable_mtf ? p10_tf2_raw : na
p90_tf2 = enable_mtf ? p90_tf2_raw : na
p10_tf3 = enable_mtf ? p10_tf3_raw : na
p90_tf3 = enable_mtf ? p90_tf3_raw : na

// è®¡ç®—å„æ—¶é—´æ¡†æ¶çŠ¶æ€
f_status(_rsi, _p10, _p90) =>
    _rsi < _p10 ? 1 : _rsi > _p90 ? -1 : 0  // 1=oversold, -1=overbought, 0=neutral

status_tf1 = f_status(rsi_tf1, p10_tf1, p90_tf1)
status_tf2 = f_status(rsi_tf2, p10_tf2, p90_tf2)
status_tf3 = f_status(rsi_tf3, p10_tf3, p90_tf3)
status_current = f_status(rsi, rsi_p10, rsi_p90)

// å…±æŒ¯æ£€æµ‹
oversold_count = (status_current == 1 ? 1 : 0) + (status_tf1 == 1 ? 1 : 0) + (status_tf2 == 1 ? 1 : 0) + (status_tf3 == 1 ? 1 : 0)
overbought_count = (status_current == -1 ? 1 : 0) + (status_tf1 == -1 ? 1 : 0) + (status_tf2 == -1 ? 1 : 0) + (status_tf3 == -1 ? 1 : 0)

oversold_resonance = oversold_count >= 3
overbought_resonance = overbought_count >= 3

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL STATISTICS / ä¿¡å·ç»Ÿè®¡ (åˆ†å±‚ç»Ÿè®¡)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸŒŸ MTF å…±æŒ¯ä¿¡å·ç»Ÿè®¡ (æœ€å¼º)
var int mtf_buy_count = 0
var float mtf_buy_return = 0.0
var int mtf_buy_wins = 0
var int mtf_sell_count = 0
var float mtf_sell_return = 0.0
var int mtf_sell_wins = 0

// ğŸ’ èƒŒç¦»+æç«¯ä¿¡å·ç»Ÿè®¡ (å¼º)
var int div_buy_count = 0
var float div_buy_return = 0.0
var int div_buy_wins = 0
var int div_sell_count = 0
var float div_sell_return = 0.0
var int div_sell_wins = 0

// ğŸ”¥ æç«¯ä¿¡å·ç»Ÿè®¡ (åŸºç¡€)
var int ext_buy_count = 0
var float ext_buy_return = 0.0
var int ext_buy_wins = 0
var int ext_sell_count = 0
var float ext_sell_return = 0.0
var int ext_sell_wins = 0

// å¹³å‡æ”¶ç›Šå’Œèƒœç‡è®¡ç®— (å£°æ˜å˜é‡ï¼Œç¨ååœ¨ä¿¡å·å®šä¹‰åè®¡ç®—)
var float mtf_buy_avg = 0.0
var float mtf_sell_avg = 0.0
var float div_buy_avg = 0.0
var float div_sell_avg = 0.0
var float ext_buy_avg = 0.0
var float ext_sell_avg = 0.0
var float mtf_buy_winrate = 0.0
var float mtf_sell_winrate = 0.0
var float div_buy_winrate = 0.0
var float div_sell_winrate = 0.0
var float ext_buy_winrate = 0.0
var float ext_sell_winrate = 0.0


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ DIVERGENCE DETECTION / èƒŒç¦»æ£€æµ‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Pivot æ£€æµ‹
price_pivot_low = ta.pivotlow(low, div_lookback, div_lookback)
price_pivot_high = ta.pivothigh(high, div_lookback, div_lookback)
rsi_pivot_low = ta.pivotlow(rsi, div_lookback, div_lookback)
rsi_pivot_high = ta.pivothigh(rsi, div_lookback, div_lookback)

// å­˜å‚¨ä¸Šä¸€ä¸ª Pivot ç‚¹
var float prev_price_low = na
var float prev_rsi_low = na
var int prev_low_bar = na
var float prev_price_high = na
var float prev_rsi_high = na
var int prev_high_bar = na

// èƒŒç¦»ä¿¡å·
var bool bullish_divergence = false
var bool bearish_divergence = false

if enable_divergence
    // æ£€æµ‹æ–°çš„ä½ç‚¹
    if not na(price_pivot_low) and not na(rsi_pivot_low)
        current_bar = bar_index - div_lookback
        if not na(prev_price_low) and not na(prev_rsi_low)
            bars_since = current_bar - prev_low_bar
            // çœ‹æ¶¨èƒŒç¦»: ä»·æ ¼åˆ›æ–°ä½ï¼ŒRSIæœªåˆ›æ–°ä½
            if bars_since <= div_range and low[div_lookback] < prev_price_low and rsi[div_lookback] > prev_rsi_low
                bullish_divergence := true
            else
                bullish_divergence := false
        else
            bullish_divergence := false
        prev_price_low := low[div_lookback]
        prev_rsi_low := rsi[div_lookback]
        prev_low_bar := current_bar
    else
        bullish_divergence := false
    
    // æ£€æµ‹æ–°çš„é«˜ç‚¹
    if not na(price_pivot_high) and not na(rsi_pivot_high)
        current_bar = bar_index - div_lookback
        if not na(prev_price_high) and not na(prev_rsi_high)
            bars_since = current_bar - prev_high_bar
            // çœ‹è·ŒèƒŒç¦»: ä»·æ ¼åˆ›æ–°é«˜ï¼ŒRSIæœªåˆ›æ–°é«˜
            if bars_since <= div_range and high[div_lookback] > prev_price_high and rsi[div_lookback] < prev_rsi_high
                bearish_divergence := true
            else
                bearish_divergence := false
        else
            bearish_divergence := false
        prev_price_high := high[div_lookback]
        prev_rsi_high := rsi[div_lookback]
        prev_high_bar := current_bar
    else
        bearish_divergence := false

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ VISUAL PLOTTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ç»˜åˆ¶ç™¾åˆ†ä½çº¿
p95_line = plot(rsi_p95, "P95 æç«¯è¶…ä¹°", color=color.new(color_bear, 70), linewidth=1)
p90_line = plot(rsi_p90, "P90 è¶…ä¹°", color=color.new(color_bear, 80), linewidth=1, style=plot.style_circles)
p75_line = plot(rsi_p75, "P75", color=color.new(color.gray, 85), linewidth=1)
p50_line = plot(rsi_p50, "P50 ä¸­ä½æ•°", color=color.new(color.white, 50), linewidth=2, style=plot.style_stepline)
p25_line = plot(rsi_p25, "P25", color=color.new(color.gray, 85), linewidth=1)
p10_line = plot(rsi_p10, "P10 è¶…å–", color=color.new(color_bull, 80), linewidth=1, style=plot.style_circles)
p5_line  = plot(rsi_p5, "P5 æç«¯è¶…å–", color=color.new(color_bull, 70), linewidth=1)

// RSI ä¸»çº¿
rsi_line = plot(rsi, "RSI", color=color_rsi, linewidth=2)

// æ¸å˜å¡«å…… - ä½¿ç”¨æ¡ä»¶é¢œè‰²æ§åˆ¶æ˜¾ç¤º/éšè—
// ä¸ŠåŠéƒ¨åˆ†æ¸å˜ (ç†Šå¸‚åŒºåŸŸ)
fill(p95_line, p90_line, color=show_fill ? color.new(color_bear, 75) : na, title="æç«¯è¶…ä¹°åŒº")
fill(p90_line, p75_line, color=show_fill ? color.new(color_bear, 88) : na, title="è¶…ä¹°åŒº")
fill(p75_line, p50_line, color=show_fill ? color.new(color_bear, 95) : na, title="åå¼ºåŒº")

// ä¸‹åŠéƒ¨åˆ†æ¸å˜ (ç‰›å¸‚åŒºåŸŸ)
fill(p50_line, p25_line, color=show_fill ? color.new(color_bull, 95) : na, title="åå¼±åŒº")
fill(p25_line, p10_line, color=show_fill ? color.new(color_bull, 88) : na, title="è¶…å–åŒº")
fill(p10_line, p5_line, color=show_fill ? color.new(color_bull, 75) : na, title="æç«¯è¶…å–åŒº")

// å›ºå®šè¾¹ç•Œå‚è€ƒçº¿
hline(0, "0", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(100, "100", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(50, "50 å›ºå®šä¸­çº¿", color=color.new(color.gray, 90), linestyle=hline.style_dotted)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// åŸºç¡€ä¿¡å· - ä½¿ç”¨ Z-Score åˆ¤æ–­æç«¯åŒºåŸŸ
// æç«¯ä¿¡å·: Z-Score Â±2Ïƒ (ç»Ÿè®¡å­¦ä¸Šçº¦ 95% ç½®ä¿¡åŒºé—´å¤–)
// æ™®é€šä¿¡å·: Z-Score Â±1.5Ïƒ
raw_extreme_oversold = ta.crossunder(rsi_zscore, -2)
raw_extreme_overbought = ta.crossover(rsi_zscore, 2)
raw_normal_oversold = ta.crossunder(rsi_zscore, -1.5) and not raw_extreme_oversold
raw_normal_overbought = ta.crossover(rsi_zscore, 1.5) and not raw_extreme_overbought

// åº”ç”¨è¶‹åŠ¿è¿‡æ»¤
extreme_oversold = enable_trend_filter ? (raw_extreme_oversold and trend_down) : raw_extreme_oversold
extreme_overbought = enable_trend_filter ? (raw_extreme_overbought and trend_up) : raw_extreme_overbought
normal_oversold = enable_trend_filter ? (raw_normal_oversold and trend_down) : raw_normal_oversold
normal_overbought = enable_trend_filter ? (raw_normal_overbought and trend_up) : raw_normal_overbought

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ CONSOLIDATED SIGNALS (ä¼˜å…ˆçº§åˆå¹¶ä¿¡å·)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æç«¯åŒºåŸŸåˆ¤æ–­ - å½“å‰Kçº¿ (ä½¿ç”¨ Z-Score)
bool in_extreme_oversold = rsi_zscore < -2
bool in_extreme_overbought = rsi_zscore > 2

// æç«¯åŒºåŸŸåˆ¤æ–­ - èƒŒç¦»å‘ç”Ÿæ—¶ (div_lookback æ ¹Kçº¿å‰)
float zscore_at_div = rsi_stdev[div_lookback] != 0 ? (rsi[div_lookback] - rsi_mean[div_lookback]) / rsi_stdev[div_lookback] : 0
bool was_extreme_oversold = zscore_at_div < -2
bool was_extreme_overbought = zscore_at_div > 2

// ä¹°å…¥ä¿¡å·ä¼˜å…ˆçº§ (é«˜åˆ°ä½): MTFå…±æŒ¯ > èƒŒç¦»+æç«¯åŒº > æç«¯ > æ™®é€š
bool sig_buy_mtf = enable_mtf and oversold_resonance and extreme_oversold
bool sig_buy_div = enable_divergence and bullish_divergence and was_extreme_oversold and not sig_buy_mtf
bool sig_buy_extreme = extreme_oversold and not sig_buy_mtf and not sig_buy_div
bool sig_buy_normal = normal_oversold and not sig_buy_mtf and not sig_buy_div and not sig_buy_extreme

// å–å‡ºä¿¡å·ä¼˜å…ˆçº§ (é«˜åˆ°ä½): MTFå…±æŒ¯ > èƒŒç¦»+æç«¯åŒº > æç«¯ > æ™®é€š
bool sig_sell_mtf = enable_mtf and overbought_resonance and extreme_overbought
bool sig_sell_div = enable_divergence and bearish_divergence and was_extreme_overbought and not sig_sell_mtf
bool sig_sell_extreme = extreme_overbought and not sig_sell_mtf and not sig_sell_div
bool sig_sell_normal = normal_overbought and not sig_sell_mtf and not sig_sell_div and not sig_sell_extreme

// èƒŒç¦»å•ç‹¬æ˜¾ç¤º (èƒŒç¦»æ—¶ä¸åœ¨æç«¯åŒºåŸŸ)
bool sig_div_bull_only = enable_divergence and bullish_divergence and not was_extreme_oversold
bool sig_div_bear_only = enable_divergence and bearish_divergence and not was_extreme_overbought

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ STATISTICS CALCULATION (ä½¿ç”¨å®é™…è§¦å‘çš„ä¿¡å·)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if enable_stats and bar_index > stats_forward_bars
    forward_return_long = (close - close[stats_forward_bars]) / close[stats_forward_bars] * 100
    forward_return_short = (close[stats_forward_bars] - close) / close[stats_forward_bars] * 100
    
    // ğŸŒŸ MTF å…±æŒ¯ä¹°å…¥
    if sig_buy_mtf[stats_forward_bars]
        mtf_buy_count := mtf_buy_count + 1
        mtf_buy_return := mtf_buy_return + forward_return_long
        if forward_return_long > 0
            mtf_buy_wins := mtf_buy_wins + 1
    
    // ğŸŒŸ MTF å…±æŒ¯å–å‡º
    if sig_sell_mtf[stats_forward_bars]
        mtf_sell_count := mtf_sell_count + 1
        mtf_sell_return := mtf_sell_return + forward_return_short
        if forward_return_short > 0
            mtf_sell_wins := mtf_sell_wins + 1
    
    // ğŸ’ èƒŒç¦»+æç«¯ä¹°å…¥
    if sig_buy_div[stats_forward_bars]
        div_buy_count := div_buy_count + 1
        div_buy_return := div_buy_return + forward_return_long
        if forward_return_long > 0
            div_buy_wins := div_buy_wins + 1
    
    // ğŸ’ èƒŒç¦»+æç«¯å–å‡º
    if sig_sell_div[stats_forward_bars]
        div_sell_count := div_sell_count + 1
        div_sell_return := div_sell_return + forward_return_short
        if forward_return_short > 0
            div_sell_wins := div_sell_wins + 1
    
    // ğŸ”¥ æç«¯ä¹°å…¥
    if sig_buy_extreme[stats_forward_bars]
        ext_buy_count := ext_buy_count + 1
        ext_buy_return := ext_buy_return + forward_return_long
        if forward_return_long > 0
            ext_buy_wins := ext_buy_wins + 1
    
    // ğŸ”¥ æç«¯å–å‡º
    if sig_sell_extreme[stats_forward_bars]
        ext_sell_count := ext_sell_count + 1
        ext_sell_return := ext_sell_return + forward_return_short
        if forward_return_short > 0
            ext_sell_wins := ext_sell_wins + 1

// è®¡ç®—å¹³å‡æ”¶ç›Šå’Œèƒœç‡
mtf_buy_avg := mtf_buy_count > 0 ? mtf_buy_return / mtf_buy_count : 0.0
mtf_sell_avg := mtf_sell_count > 0 ? mtf_sell_return / mtf_sell_count : 0.0
div_buy_avg := div_buy_count > 0 ? div_buy_return / div_buy_count : 0.0
div_sell_avg := div_sell_count > 0 ? div_sell_return / div_sell_count : 0.0
ext_buy_avg := ext_buy_count > 0 ? ext_buy_return / ext_buy_count : 0.0
ext_sell_avg := ext_sell_count > 0 ? ext_sell_return / ext_sell_count : 0.0

mtf_buy_winrate := mtf_buy_count > 0 ? mtf_buy_wins / mtf_buy_count * 100 : 0.0
mtf_sell_winrate := mtf_sell_count > 0 ? mtf_sell_wins / mtf_sell_count * 100 : 0.0
div_buy_winrate := div_buy_count > 0 ? div_buy_wins / div_buy_count * 100 : 0.0
div_sell_winrate := div_sell_count > 0 ? div_sell_wins / div_sell_count * 100 : 0.0
ext_buy_winrate := ext_buy_count > 0 ? ext_buy_wins / ext_buy_count * 100 : 0.0
ext_sell_winrate := ext_sell_count > 0 ? ext_sell_wins / ext_sell_count * 100 : 0.0


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL DISPLAY (ä¿¡å·æ˜¾ç¤º)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ä¹°å…¥ä¿¡å· (åº•éƒ¨)
plotshape(sig_buy_mtf, title="ğŸŒŸ MTF+æç«¯è¶…å–", style=shape.labelup, location=location.bottom, color=#00E676, size=size.normal, text="ğŸŒŸ", textcolor=color.white)
plotshape(sig_buy_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…å–", style=shape.labelup, location=location.bottom, color=#00BCD4, size=size.normal, text="ğŸ’", textcolor=color.white)
plotshape(sig_buy_extreme, title="ğŸ”¥ æç«¯è¶…å–", style=shape.triangleup, location=location.bottom, color=color_bull, size=size.small, text="ğŸ”¥")
plotshape(show_normal_signals and sig_buy_normal, title="â¬†ï¸ æ™®é€šè¶…å–", style=shape.circle, location=location.bottom, color=color.new(color_bull, 30), size=size.tiny, text="â¬†ï¸")

// å–å‡ºä¿¡å· (é¡¶éƒ¨)
plotshape(sig_sell_mtf, title="ğŸŒŸ MTF+æç«¯è¶…ä¹°", style=shape.labeldown, location=location.top, color=#FF5252, size=size.normal, text="ğŸŒŸ", textcolor=color.white)
plotshape(sig_sell_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…ä¹°", style=shape.labeldown, location=location.top, color=#FF9800, size=size.normal, text="ğŸ’", textcolor=color.white)
plotshape(sig_sell_extreme, title="â„ï¸ æç«¯è¶…ä¹°", style=shape.triangledown, location=location.top, color=color_bear, size=size.small, text="â„ï¸")
plotshape(show_normal_signals and sig_sell_normal, title="â¬‡ï¸ æ™®é€šè¶…ä¹°", style=shape.circle, location=location.top, color=color.new(color_bear, 30), size=size.tiny, text="â¬‡ï¸")

// èƒŒç¦»å•ç‹¬æ ‡è®° (ä½¿ç”¨offsetå›é€€åˆ°å®é™…èƒŒç¦»ä½ç½®)
plotshape(sig_div_bull_only, title="â†—ï¸ çœ‹æ¶¨èƒŒç¦»", style=shape.circle, location=location.bottom, color=#00BCD4, size=size.tiny, text="â†—ï¸", offset=-div_lookback)
plotshape(sig_div_bear_only, title="â†˜ï¸ çœ‹è·ŒèƒŒç¦»", style=shape.circle, location=location.top, color=#FF9800, size=size.tiny, text="â†˜ï¸", offset=-div_lookback)

// èƒŒæ™¯è‰²é«˜äº®
bgcolor(rsi < rsi_p5 ? color.new(color_bull, 90) : rsi > rsi_p95 ? color.new(color_bear, 90) : na, title="æç«¯åŒºèƒŒæ™¯")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// MTF çŠ¶æ€è½¬æ–‡å­— (å®šä¹‰åœ¨ if å—å¤–éƒ¨)
f_status_text(_status) =>
    _status == 1 ? "ğŸŸ¢" : _status == -1 ? "ğŸ”´" : "âšª"

if show_dashboard
    // è®¡ç®—å½“å‰RSIåœ¨åˆ†å¸ƒä¸­çš„ä½ç½®
    rsi_percentile = 0.0
    if rsi <= rsi_p5
        rsi_percentile := 5.0
    else if rsi <= rsi_p10
        rsi_percentile := 10.0
    else if rsi <= rsi_p25
        rsi_percentile := 25.0
    else if rsi <= rsi_p50
        rsi_percentile := 50.0
    else if rsi <= rsi_p75
        rsi_percentile := 75.0
    else if rsi <= rsi_p90
        rsi_percentile := 90.0
    else if rsi <= rsi_p95
        rsi_percentile := 95.0
    else
        rsi_percentile := 99.0

    // çŠ¶æ€åˆ¤æ–­ (ä½¿ç”¨ Z-Score)
    status_text = rsi_zscore < -2 ? "ğŸŸ¢ EXTREME OVERSOLD (Ïƒ<-2)" :
                  rsi_zscore < -1.5 ? "ğŸŸ¡ OVERSOLD (Ïƒ<-1.5)" :
                  rsi_zscore > 2 ? "ğŸ”´ EXTREME OVERBOUGHT (Ïƒ>2)" :
                  rsi_zscore > 1.5 ? "ğŸŸ  OVERBOUGHT (Ïƒ>1.5)" : "âšª NEUTRAL"
    
    status_color = rsi_zscore < -1.5 ? color_bull : rsi_zscore > 1.5 ? color_bear : color.gray

    // å­—ä½“å¤§å°è½¬æ¢
    txt_size_title = dashboard_size == "Tiny" ? size.tiny : dashboard_size == "Small" ? size.small : dashboard_size == "Normal" ? size.normal : size.large
    txt_size_body = dashboard_size == "Tiny" ? size.tiny : dashboard_size == "Small" ? size.tiny : dashboard_size == "Normal" ? size.small : size.normal
    
    // èƒŒç¦»çŠ¶æ€
    div_text = bullish_divergence ? "ğŸŸ¢ BULL DIV" : bearish_divergence ? "ğŸ”´ BEAR DIV" : "â€”"
    div_color = bullish_divergence ? #00BCD4 : bearish_divergence ? #FF9800 : color.gray
    
    // å…±æŒ¯çŠ¶æ€
    resonance_text = oversold_resonance ? "ğŸŸ¢ " + str.tostring(oversold_count) + "/4 OVERSOLD" : 
                     overbought_resonance ? "ğŸ”´ " + str.tostring(overbought_count) + "/4 OVERBOUGHT" : 
                     "âšª " + str.tostring(math.max(oversold_count, overbought_count)) + "/4"
    resonance_color = oversold_resonance ? color_bull : overbought_resonance ? color_bear : color.gray

    // è®¡ç®—è¡Œæ•° (åˆ†å±‚ç»Ÿè®¡éœ€è¦7è¡Œ: æ ‡é¢˜ + 3ç±»ä¿¡å· x Buy/Sell)
    total_rows = 8 + (enable_mtf ? 3 : 0) + (enable_divergence ? 1 : 0) + (enable_stats ? 7 : 0)

    // åˆ›å»ºè¡¨æ ¼ - æ·±è“ç°è‰²èƒŒæ™¯æ›´æ˜“è¯»
    var table dashboard = table.new(position.top_right, 2, total_rows, 
                                     bgcolor=color.new(#1a1a2e, dashboard_transparency),
                                     border_width=1, border_color=color.new(#4a4a6a, 50))
    
    if barstate.islast
        row = 0
        
        // æ ‡é¢˜è¡Œ
        table.cell(dashboard, 0, row, "ADAPTIVE RSI PRO", text_color=color.white, text_size=txt_size_title, bgcolor=color.new(#2962FF, dashboard_transparency))
        table.cell(dashboard, 1, row, str.tostring(rsi, "#.0"), text_color=color_rsi, text_size=txt_size_title, bgcolor=color.new(#2962FF, dashboard_transparency))
        row += 1
        
        // çŠ¶æ€
        table.cell(dashboard, 0, row, "Status", text_color=color.gray, text_size=txt_size_body)
        table.cell(dashboard, 1, row, status_text, text_color=status_color, text_size=txt_size_body)
        row += 1
        
        // ç™¾åˆ†ä½ + è¶‹åŠ¿
        table.cell(dashboard, 0, row, "Percentile", text_color=color.gray, text_size=txt_size_body)
        table.cell(dashboard, 1, row, "P" + str.tostring(rsi_percentile, "#") + " " + trend_text, text_color=trend_color, text_size=txt_size_body)
        row += 1
        
        // Z-Score
        zscore_color = rsi_zscore < -2 ? color_bull : rsi_zscore < -1.5 ? #90EE90 : rsi_zscore > 2 ? color_bear : rsi_zscore > 1.5 ? #FFB6C1 : color.gray
        table.cell(dashboard, 0, row, "Z-Score", text_color=color.gray, text_size=txt_size_body)
        table.cell(dashboard, 1, row, str.tostring(rsi_zscore, "#.2") + "Ïƒ", text_color=zscore_color, text_size=txt_size_body)
        row += 1
        
        // åˆ†éš”çº¿
        table.cell(dashboard, 0, row, "â”€â”€â”€â”€â”€â”€â”€", text_color=color.gray, text_size=txt_size_body)
        table.cell(dashboard, 1, row, "â”€â”€â”€â”€â”€â”€â”€", text_color=color.gray, text_size=txt_size_body)
        row += 1
        
        // é˜ˆå€¼
        table.cell(dashboard, 0, row, "Overbought P90", text_color=color.new(color_bear, 30), text_size=txt_size_body)
        table.cell(dashboard, 1, row, str.tostring(rsi_p90, "#.0"), text_color=color_bear, text_size=txt_size_body)
        row += 1
        
        table.cell(dashboard, 0, row, "Median P50", text_color=color.gray, text_size=txt_size_body)
        table.cell(dashboard, 1, row, str.tostring(rsi_p50, "#.0"), text_color=color.white, text_size=txt_size_body)
        row += 1
        
        table.cell(dashboard, 0, row, "Oversold P10", text_color=color.new(color_bull, 30), text_size=txt_size_body)
        table.cell(dashboard, 1, row, str.tostring(rsi_p10, "#.0"), text_color=color_bull, text_size=txt_size_body)
        row += 1
        
        // MTF éƒ¨åˆ†
        if enable_mtf
            table.cell(dashboard, 0, row, "â”€â”€ MTF RSI â”€â”€", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, "â”€â”€â”€â”€â”€â”€â”€", text_color=color.gray, text_size=txt_size_body)
            row += 1
            
            table.cell(dashboard, 0, row, mtf_tf1 + " | " + mtf_tf2 + " | " + mtf_tf3, text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, f_status_text(status_tf1) + " | " + f_status_text(status_tf2) + " | " + f_status_text(status_tf3), text_color=color.white, text_size=txt_size_body)
            row += 1
            
            table.cell(dashboard, 0, row, "Resonance", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, resonance_text, text_color=resonance_color, text_size=txt_size_body)
            row += 1
        
        // èƒŒç¦»éƒ¨åˆ†
        if enable_divergence
            table.cell(dashboard, 0, row, "Divergence", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, div_text, text_color=div_color, text_size=txt_size_body)
            row += 1
        
        // ç»Ÿè®¡éƒ¨åˆ† (åˆ†å±‚æ˜¾ç¤º Buy/Sell)
        if enable_stats
            table.cell(dashboard, 0, row, "â”€â”€ STATS â”€â”€", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, "(" + str.tostring(stats_forward_bars) + " bars)", text_color=color.gray, text_size=txt_size_body)
            row += 1
            
            // ğŸŒŸ MTF å…±æŒ¯
            mtf_buy_color = mtf_buy_avg >= 0 ? color_bull : color_bear
            table.cell(dashboard, 0, row, "ğŸŒŸ MTF Buy(" + str.tostring(mtf_buy_count) + ")", text_color=#FFD700, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.tostring(mtf_buy_avg, "#.1") + "% | " + str.tostring(mtf_buy_winrate, "#") + "%", text_color=mtf_buy_color, text_size=txt_size_body)
            row += 1
            
            mtf_sell_color = mtf_sell_avg >= 0 ? color_bull : color_bear
            table.cell(dashboard, 0, row, "ğŸŒŸ MTF Sell(" + str.tostring(mtf_sell_count) + ")", text_color=#FFD700, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.tostring(mtf_sell_avg, "#.1") + "% | " + str.tostring(mtf_sell_winrate, "#") + "%", text_color=mtf_sell_color, text_size=txt_size_body)
            row += 1
            
            // ğŸ’ èƒŒç¦»+æç«¯
            div_buy_color = div_buy_avg >= 0 ? color_bull : color_bear
            table.cell(dashboard, 0, row, "ğŸ’ Div Buy(" + str.tostring(div_buy_count) + ")", text_color=#00BCD4, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.tostring(div_buy_avg, "#.1") + "% | " + str.tostring(div_buy_winrate, "#") + "%", text_color=div_buy_color, text_size=txt_size_body)
            row += 1
            
            div_sell_color = div_sell_avg >= 0 ? color_bull : color_bear
            table.cell(dashboard, 0, row, "ğŸ’ Div Sell(" + str.tostring(div_sell_count) + ")", text_color=#00BCD4, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.tostring(div_sell_avg, "#.1") + "% | " + str.tostring(div_sell_winrate, "#") + "%", text_color=div_sell_color, text_size=txt_size_body)
            row += 1
            
            // ğŸ”¥ æç«¯
            ext_buy_color = ext_buy_avg >= 0 ? color_bull : color_bear
            table.cell(dashboard, 0, row, "ğŸ”¥ Ext Buy(" + str.tostring(ext_buy_count) + ")", text_color=color_bull, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.tostring(ext_buy_avg, "#.1") + "% | " + str.tostring(ext_buy_winrate, "#") + "%", text_color=ext_buy_color, text_size=txt_size_body)
            row += 1
            
            ext_sell_color = ext_sell_avg >= 0 ? color_bull : color_bear
            table.cell(dashboard, 0, row, "ğŸ”¥ Ext Sell(" + str.tostring(ext_sell_count) + ")", text_color=color_bear, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.tostring(ext_sell_avg, "#.1") + "% | " + str.tostring(ext_sell_winrate, "#") + "%", text_color=ext_sell_color, text_size=txt_size_body)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æç«¯è­¦æŠ¥
alertcondition(extreme_oversold and enable_extreme_alerts, 
               title="ğŸŸ¢ Extreme Oversold / æç«¯è¶…å–", 
               message="{{ticker}}: RSI crossed below P5 ({{plot_0}}). Extreme oversold condition detected!")

alertcondition(extreme_overbought and enable_extreme_alerts, 
               title="ğŸ”´ Extreme Overbought / æç«¯è¶…ä¹°", 
               message="{{ticker}}: RSI crossed above P95 ({{plot_0}}). Extreme overbought condition detected!")

// æ™®é€šè­¦æŠ¥
alertcondition(normal_oversold and enable_normal_alerts, 
               title="ğŸŸ¡ Oversold / è¶…å–", 
               message="{{ticker}}: RSI crossed below P10 ({{plot_0}}). Oversold condition detected.")

alertcondition(normal_overbought and enable_normal_alerts, 
               title="ğŸŸ  Overbought / è¶…ä¹°", 
               message="{{ticker}}: RSI crossed above P90 ({{plot_0}}). Overbought condition detected.")

// ç»¼åˆè­¦æŠ¥
alertcondition(extreme_oversold or extreme_overbought, 
               title="âš¡ Any Extreme Signal / ä»»æ„æç«¯ä¿¡å·", 
               message="{{ticker}}: Extreme RSI signal detected at {{plot_0}}")

// MTF å…±æŒ¯è­¦æŠ¥
alertcondition(enable_mtf and oversold_resonance and raw_extreme_oversold, 
               title="ğŸŒŸ MTF Oversold Resonance / å¤šå‘¨æœŸè¶…å–å…±æŒ¯", 
               message="{{ticker}}: Multiple timeframes showing oversold condition - Strong buy signal!")

alertcondition(enable_mtf and overbought_resonance and raw_extreme_overbought, 
               title="ğŸŒŸ MTF Overbought Resonance / å¤šå‘¨æœŸè¶…ä¹°å…±æŒ¯", 
               message="{{ticker}}: Multiple timeframes showing overbought condition - Strong sell signal!")

// èƒŒç¦»è­¦æŠ¥
alertcondition(enable_divergence and bullish_divergence, 
               title="ğŸ’ Bullish Divergence / çœ‹æ¶¨èƒŒç¦»", 
               message="{{ticker}}: RSI bullish divergence detected - Price making lower low but RSI making higher low")

alertcondition(enable_divergence and bearish_divergence, 
               title="ğŸ’ Bearish Divergence / çœ‹è·ŒèƒŒç¦»", 
               message="{{ticker}}: RSI bearish divergence detected - Price making higher high but RSI making lower high")

// è¶‹åŠ¿å˜åŒ–è­¦æŠ¥
alertcondition(ta.crossover(rsi, rsi_p50), 
               title="ğŸ“ˆ Trend Shift Bullish / è¶‹åŠ¿è½¬å¤š", 
               message="{{ticker}}: RSI crossed above adaptive median (P50) - Trend shift to bullish")

alertcondition(ta.crossunder(rsi, rsi_p50), 
               title="ğŸ“‰ Trend Shift Bearish / è¶‹åŠ¿è½¬ç©º", 
               message="{{ticker}}: RSI crossed below adaptive median (P50) - Trend shift to bearish")
