// Adaptive RSI Pro v6.8 - Dynamic Thresholds + MTF + Divergence + Statistics
// MIT License - https://github.com/user/adaptive-rsi-pro
//
// ä¿¡å·å›¾ä¾‹ / Signal Legend:
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ä¹°å…¥ BUY (åº•éƒ¨):  ğŸŒŸ MTFå…±æŒ¯ | ğŸ’ èƒŒç¦»+æç«¯ | ğŸ”¥ æç«¯è¶…å– | â¬†ï¸ æ™®é€šè¶…å– | â†—ï¸ çœ‹æ¶¨èƒŒç¦»
// å–å‡º SELL (é¡¶éƒ¨): ğŸŒŸ MTFå…±æŒ¯ | ğŸ’ èƒŒç¦»+æç«¯ | â„ï¸ æç«¯è¶…ä¹° | â¬‡ï¸ æ™®é€šè¶…ä¹° | â†˜ï¸ çœ‹è·ŒèƒŒç¦»
// çŠ¶æ€ STATUS:      ğŸŸ¢ è¶…å– | ğŸŸ¡ è½»åº¦è¶…å– | âšª ä¸­æ€§ | ğŸŸ  è½»åº¦è¶…ä¹° | ğŸ”´ è¶…ä¹°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

//@version=6
indicator("Adaptive RSI Pro", shorttitle="ARSI Pro", overlay=false, precision=2, max_lines_count=100, max_labels_count=100, max_bars_back=4500)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INPUTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

grp_rsi = "â•â•â• RSI Settings / RSIè®¾ç½® â•â•â•"
rsi_length = input.int(14, "RSI Length / RSIå‘¨æœŸ", minval=2, group=grp_rsi)
rsi_source = input.source(close, "RSI Source / æ•°æ®æº", group=grp_rsi)

grp_adaptive = "â•â•â• Adaptive Settings / è‡ªé€‚åº”è®¾ç½® â•â•â•"
lookback_mode = input.string("Auto", "Lookback Mode / å›çœ‹æ¨¡å¼", options=["Auto", "Custom"], group=grp_adaptive, tooltip="Auto: æ ¹æ®æ—¶é—´æ¡†æ¶å’ŒRSIæ³¢åŠ¨ç‡è‡ªåŠ¨è®¡ç®—\nCustom: ä½¿ç”¨è‡ªå®šä¹‰å€¼")
lookback_custom = input.int(252, "Custom Lookback / è‡ªå®šä¹‰å›çœ‹", minval=50, maxval=2000, group=grp_adaptive, tooltip="ä»…åœ¨ Custom æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚å»ºè®®ï¼šæ—¥çº¿252ï¼Œ4å°æ—¶500ï¼Œ1å°æ—¶750")
lookback_precision = input.string("Normal", "Precision / ç²¾åº¦", options=["High", "Normal", "Low"], group=grp_adaptive, tooltip="High(é«˜ç²¾åº¦): éœ€è¦æ›´å¤šæ•°æ®ï¼Œæ›´å‡†ç¡®\nNormal(å¹³è¡¡): æ¨èè®¾ç½®\nLow(å¿«é€‚åº”): æ›´å°‘æ•°æ®ï¼Œæ›´å¿«å“åº”")
vol_history_mode = input.string("1 Year", "History Depth / å†å²æ·±åº¦", options=["6 Months", "1 Year", "2 Years"], group=grp_adaptive, tooltip="æ³¢åŠ¨ç‡å‚è€ƒçš„å†å²æ—¶é—´é•¿åº¦\nè‡ªåŠ¨æ ¹æ®æ—¶é—´æ¡†æ¶è½¬æ¢ä¸ºKçº¿æ•°é‡")

grp_visual = "â•â•â• Visual Settings / è§†è§‰è®¾ç½® â•â•â•"
visual_line_mode = input.string("Unified", "Threshold Line Mode / é˜ˆå€¼çº¿æ¨¡å¼", options=["Unified", "Z-Score", "Percentile", "Both"], group=grp_visual, tooltip="Unified(æ¨è): Z-Scoreçº¿+ç™¾åˆ†ä½æ ‡æ³¨ï¼Œå…¼é¡¾ä¸¥è°¨æ€§å’Œç›´è§‚æ€§\nZ-Score: ä»…ç»Ÿè®¡å­¦é˜ˆå€¼çº¿(Â±2Ïƒ, Â±1.5Ïƒ)\nPercentile: ä»…ç™¾åˆ†ä½çº¿(P5-P95)\nBoth: åŒæ—¶æ˜¾ç¤ºä¸¤ç§")
show_fill = input.bool(true, "Show Gradient Fill / æ˜¾ç¤ºæ¸å˜å¡«å……", group=grp_visual)
show_dashboard = input.bool(true, "Show Dashboard / æ˜¾ç¤ºä»ªè¡¨ç›˜", group=grp_visual)
dashboard_mode = input.string("Full", "Dashboard Mode / é¢æ¿æ¨¡å¼", options=["Mobile", "Lite", "Full"], group=grp_visual, tooltip="Mobile: æç®€æ¨¡å¼(3è¡Œ)ï¼Œä»…RSI+ä¿¡å·+çŠ¶æ€ï¼Œé€‚åˆæ‰‹æœº\\nLite: æ ¸å¿ƒä¿¡æ¯(5è¡Œ) | Full: å®Œæ•´ä¿¡æ¯")
dashboard_size = input.string("Normal", "Dashboard Size / é¢æ¿å¤§å°", options=["Tiny", "Small", "Normal", "Large"], group=grp_visual)
dashboard_transparency = input.int(30, "Dashboard Transparency / é¢æ¿é€æ˜åº¦", minval=0, maxval=100, step=10, group=grp_visual)
color_bull = input.color(color.new(#00E676, 60), "Bullish Color / ç‰›å¸‚é¢œè‰²", group=grp_visual)
color_bear = input.color(color.new(#FF5252, 60), "Bearish Color / ç†Šå¸‚é¢œè‰²", group=grp_visual)
color_rsi = input.color(#FFEB3B, "RSI Line Color / RSIçº¿é¢œè‰²", group=grp_visual)

grp_alerts = "â•â•â• Alert Settings / è­¦æŠ¥è®¾ç½® â•â•â•"
normal_signal_mode = input.string("Smart", "Normal Signal Mode / æ™®é€šä¿¡å·æ¨¡å¼", options=["Off", "On", "Smart"], group=grp_alerts, tooltip="Off: å…³é—­æ™®é€šä¿¡å·\nOn: æ€»æ˜¯æ˜¾ç¤ºï¼Œä½¿ç”¨æ‰‹åŠ¨é˜ˆå€¼\nSmart: è‡ªåŠ¨åˆ¤æ–­æ˜¾ç¤º+è‡ªåŠ¨é˜ˆå€¼")
normal_threshold_manual = input.float(1.5, "Manual Threshold / æ‰‹åŠ¨é˜ˆå€¼ (Onæ¨¡å¼)", minval=1.0, maxval=2.0, step=0.1, group=grp_alerts, tooltip="ä»…Onæ¨¡å¼ä½¿ç”¨\n1.5Ïƒ â‰ˆ P6.7/P93.3\n1.28Ïƒ â‰ˆ P10/P90")
enable_signal_cooldown = input.bool(true, "Enable Signal Cooldown / å¯ç”¨ä¿¡å·å†·å´", group=grp_alerts, tooltip="é˜²æ­¢åŒä¸€åŒºåŸŸé‡å¤ä¿¡å·æ±¡æŸ“ç»Ÿè®¡æ•°æ®")
cooldown_mode = input.string("Smart", "Cooldown Mode / å†·å´æ¨¡å¼", options=["Smart", "Fixed"], group=grp_alerts, tooltip="Smart: æ ¹æ®å¸‚åœºæ³¢åŠ¨ç‡è‡ªåŠ¨è°ƒæ•´å†·å´æœŸ\nFixed: ä½¿ç”¨å›ºå®šå†·å´æœŸ")
cooldown_bars_fixed = input.int(5, "Fixed Cooldown (Bars) / å›ºå®šå†·å´æœŸ", minval=1, maxval=20, group=grp_alerts, tooltip="Fixedæ¨¡å¼ä¸‹çš„å†·å´æ—¶é—´ï¼ˆKçº¿æ•°ï¼‰")
enable_smart_alert = input.bool(true, "ğŸ¯ Smart Alert / æ™ºèƒ½è­¦æŠ¥", group=grp_alerts, tooltip="V6åŠ¨æ€è­¦æŠ¥ï¼šè‡ªåŠ¨èšåˆæ‰€æœ‰ä¿¡å·åˆ°ä¸€æ¡æ¶ˆæ¯\nåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆRSIå€¼ã€Z-Scoreã€ç™¾åˆ†ä½ï¼‰\nå®æ—¶è§¦å‘ï¼Œæ™ºèƒ½å»é‡")
include_risk_in_alerts = input.bool(false, "Include Risk Hints in Alerts / è­¦æŠ¥å«é£é™©æç¤º", group=grp_alerts, tooltip="åœ¨è­¦æŠ¥æ¶ˆæ¯ä¸­åŒ…å«ATRæ­¢æŸ/æ­¢ç›ˆå»ºè®®\né»˜è®¤å…³é—­ï¼Œé¿å…æ¶ˆæ¯è¿‡é•¿")
alert_rr_ratio = input.float(2.0, "Risk-Reward Ratio / é£é™©å›æŠ¥æ¯”", minval=1.5, maxval=3.0, step=0.5, group=grp_alerts, tooltip="æ­¢ç›ˆ/æ­¢æŸæ¯”ä¾‹\n2.0 = 1:2 é£é™©å›æŠ¥æ¯”")

grp_protection = "â•â•â• Trend Protection / è¶‹åŠ¿ä¿æŠ¤ â•â•â•"
enable_trend_protection = input.bool(true, "Enable Trend Protection / å¯ç”¨è¶‹åŠ¿ä¿æŠ¤", group=grp_protection, tooltip="ä½¿ç”¨å‘¨çº¿è¶‹åŠ¿è¿‡æ»¤æç«¯é£é™©ï¼šé¿å…åœ¨å‘¨çº¿æç«¯ä¸‹è·Œä¸­æŠ„åº•")
protection_level = input.string("Moderate", "Protection Level / ä¿æŠ¤çº§åˆ«", options=["Aggressive", "Moderate", "Loose"], group=grp_protection, tooltip="Aggressive: å‘¨çº¿å¿…é¡»ä¸Šå‡è¶‹åŠ¿\nModerate(æ¨è): æ’é™¤å‘¨çº¿æç«¯ä¸‹è·Œ\nLoose: ä»…æ’é™¤å‘¨çº¿RSI<20çš„æç«¯æƒ…å†µ")

grp_volume = "â•â•â• Volume Confirmation / æˆäº¤é‡ç¡®è®¤ â•â•â•"
enable_volume_scoring = input.bool(true, "Enable Volume Scoring / å¯ç”¨æˆäº¤é‡è¯„åˆ†", group=grp_volume, tooltip="æˆäº¤é‡ä½œä¸ºä¿¡å·è´¨é‡è¯„åˆ†é¡¹ï¼Œä¸å¼ºåˆ¶è¿‡æ»¤")
volume_surge_mult = input.float(1.5, "Volume Surge Multiplier / æ”¾é‡å€æ•°", minval=1.0, maxval=3.0, step=0.1, group=grp_volume, tooltip="é«˜äºå‡é‡Xå€è§†ä¸ºæ”¾é‡")

grp_mtf = "â•â•â• Multi-Timeframe / å¤šæ—¶é—´æ¡†æ¶ â•â•â•"
enable_mtf = input.bool(true, "Enable MTF RSI / å¯ç”¨å¤šæ—¶é—´æ¡†æ¶", group=grp_mtf)
mtf_mode = input.string("Auto", "MTF Mode / æ¨¡å¼", options=["Auto", "Manual"], group=grp_mtf, tooltip="Auto: æ ¹æ®åˆ†å½¢é€»è¾‘è‡ªåŠ¨é€‰æ‹©æ›´å°å‘¨æœŸ (å‘ä¸‹åˆ†å½¢)\nManual: ä½¿ç”¨ä¸‹æ–¹æ‰‹åŠ¨è®¾ç½®")
mtf_tf1_input = input.timeframe("60", "Manual TF1 / æ‰‹åŠ¨å‘¨æœŸ1", group=grp_mtf)
mtf_tf2_input = input.timeframe("240", "Manual TF2 / æ‰‹åŠ¨å‘¨æœŸ2", group=grp_mtf)
mtf_tf3_input = input.timeframe("D", "Manual TF3 / æ‰‹åŠ¨å‘¨æœŸ3", group=grp_mtf)

grp_stats = "â•â•â• Signal Statistics / ä¿¡å·ç»Ÿè®¡ â•â•â•"
enable_stats = input.bool(true, "Enable Statistics / å¯ç”¨ç»Ÿè®¡", group=grp_stats)
stats_mode = input.string("Ranking", "Stats Mode / ç»Ÿè®¡æ¨¡å¼", options=["Signal Type", "Grade", "Ranking"], group=grp_stats, tooltip="Signal Type: æŒ‰ä¿¡å·ç±»å‹ç»Ÿè®¡\nGrade: æŒ‰è´¨é‡ç­‰çº§ç»Ÿè®¡\nRanking: äº¤å‰æ’è¡Œæ¦œï¼ˆä¿¡å·Ã—ç­‰çº§ï¼‰")
stats_forward_bars = input.int(20, "Forward Bars / å‰ç»Kçº¿æ•°", minval=5, maxval=100, group=grp_stats, tooltip="ä¿¡å·è§¦å‘åå¤šå°‘æ ¹Kçº¿è®¡ç®—æ”¶ç›Š")
enable_stats_filter = input.bool(true, "Enable Stats Filter / å¯ç”¨ç»Ÿè®¡è¿‡æ»¤", group=grp_stats, tooltip="åŸºäºå†å²ç»Ÿè®¡æ•°æ®è¿‡æ»¤ä½è´¨é‡ä¿¡å·\næ ¹æ®æ ·æœ¬æ•°å’Œèƒœç‡è‡ªåŠ¨è¿‡æ»¤")
stats_min_samples = input.int(20, "Min Samples / æœ€å°æ ·æœ¬æ•°", minval=5, maxval=50, group=grp_stats, tooltip="ä¿¡å·ç»„åˆéœ€è¦çš„æœ€å°æ ·æœ¬æ•°\nâ‰¥20ä¸ºç»Ÿè®¡å¯é ")
stats_min_winrate = input.float(55.0, "Min Adjusted WinRate / æœ€å°è°ƒæ•´èƒœç‡", minval=50.0, maxval=70.0, step=1.0, group=grp_stats, tooltip="ä¿¡å·ç»„åˆéœ€è¦çš„æœ€å°è´å¶æ–¯è°ƒæ•´èƒœç‡\n55%ä¸ºå»ºè®®å€¼")
stats_filter_mode = input.string("Alert Only", "Filter Mode / è¿‡æ»¤æ¨¡å¼", options=["Alert Only", "Soft", "Hard"], group=grp_stats, tooltip="Alert Only: ä»…è¿‡æ»¤è­¦æŠ¥ï¼Œå›¾è¡¨æ˜¾ç¤ºæ‰€æœ‰ä¿¡å·\nSoft: ä½è´¨é‡ä¿¡å·é™çº§æ˜¾ç¤º\nHard: å®Œå…¨éšè—ä½è´¨é‡ä¿¡å·")
sell_stats_mode = input.string("Long Exit", "Sell Stats Mode / å–å‡ºç»Ÿè®¡æ¨¡å¼", options=["Long Exit", "Short Entry"], group=grp_stats, tooltip="Long Exit: å–å‡ºåä»·æ ¼ä¸‹è·Œæ¦‚ç‡ï¼ˆå¤šå¤´é€€å‡ºè§†è§’ï¼‰\nShort Entry: åšç©ºæ”¶ç›Šï¼ˆç©ºå¤´å…¥åœºè§†è§’ï¼‰")

grp_divergence = "â•â•â• Divergence Settings / èƒŒç¦»è®¾ç½® â•â•â•"
enable_divergence = input.bool(true, "Enable Divergence Detection / å¯ç”¨èƒŒç¦»æ£€æµ‹", group=grp_divergence)
div_mode = input.string("Auto", "Divergence Mode / èƒŒç¦»æ¨¡å¼", options=["Auto", "Low Vol", "Normal", "High Vol", "Crypto", "Custom"], group=grp_divergence, tooltip="Auto: æ ¹æ®ATRè‡ªåŠ¨åˆ¤æ–­\nLow Vol: è“ç­¹/ETF\nNormal: ä¸€èˆ¬è‚¡ç¥¨\nHigh Vol: æˆé•¿/å°ç›˜\nCrypto: åŠ å¯†è´§å¸")
div_lookback_custom = input.int(5, "Custom Lookback / è‡ªå®šä¹‰å›çœ‹", minval=2, maxval=20, group=grp_divergence, tooltip="ä»…åœ¨ Custom æ¨¡å¼ä¸‹ä½¿ç”¨")
div_range_custom = input.int(60, "Custom Range / è‡ªå®šä¹‰èŒƒå›´", minval=20, maxval=200, group=grp_divergence, tooltip="ä»…åœ¨ Custom æ¨¡å¼ä¸‹ä½¿ç”¨")

// æ³¢åŠ¨æ€§æ£€æµ‹
atr_20 = ta.atr(20)
avg_volatility = ta.sma(atr_20 / close * 100, 252)
auto_vol_type = avg_volatility > 6 ? "Crypto" : avg_volatility > 3 ? "High Vol" : avg_volatility > 1 ? "Normal" : "Low Vol"

// æ™ºèƒ½å†·å´æœŸåŸºç¡€å€¼
base_cooldown = avg_volatility > 6 ? 2 : avg_volatility > 3 ? 3 : avg_volatility > 1 ? 5 : 8
vol_short_term = ta.sma(atr_20 / close * 100, 20)

// æ™ºèƒ½æ™®é€šä¿¡å·é˜ˆå€¼ï¼ˆåŸºäºæ³¢åŠ¨ç‡ï¼‰
auto_normal_threshold = avg_volatility > 6 ? 1.0 : avg_volatility > 3 ? 1.28 : avg_volatility > 1 ? 1.5 : 1.8
normal_threshold = normal_signal_mode == "On" ? normal_threshold_manual : auto_normal_threshold

// èƒŒç¦»æ¨¡å¼å‚æ•°
active_div_mode = div_mode == "Auto" ? auto_vol_type : div_mode
div_lookback = div_mode == "Custom" ? div_lookback_custom : active_div_mode == "Low Vol" ? 3 : active_div_mode == "Normal" ? 5 : active_div_mode == "High Vol" ? 7 : 10
div_range = div_mode == "Custom" ? div_range_custom : active_div_mode == "Low Vol" ? 40 : active_div_mode == "Normal" ? 60 : active_div_mode == "High Vol" ? 80 : 120

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RSI CALCULATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rsi = ta.rsi(rsi_source, rsi_length)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DYNAMIC LOOKBACK CALCULATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

vol_short_period = rsi_length * 4
vol_history_days = vol_history_mode == "6 Months" ? 126 : vol_history_mode == "1 Year" ? 252 : 504
tf_minutes = timeframe.in_seconds(timeframe.period) / 60
// æ­£ç¡®è®¡ç®—æ¯æ—¥å¯¹åº”çš„Kçº¿æ•°ï¼šå‘¨çº¿=1/5å¤©ï¼Œæœˆçº¿=1/21å¤©
bars_per_day = timeframe.ismonthly ? 1.0 / 21 : timeframe.isweekly ? 1.0 / 5 : timeframe.isdaily ? 1 : math.ceil(1440 / tf_minutes)
vol_long_period = math.min(4500, int(vol_history_days * bars_per_day))

vol_short = nz(ta.stdev(rsi, vol_short_period), 10)
vol_long = nz(ta.stdev(rsi, vol_long_period), 10)
vol_base = vol_long * 0.7 + vol_short * 0.3
recent_high = vol_short > vol_long * 1.2
vol_dynamic = recent_high ? (vol_short * 0.6 + vol_long * 0.4) : vol_base

// æ™ºèƒ½å†·å´æœŸåŠ¨æ€è°ƒæ•´
price_vol_active = vol_short_term > avg_volatility * 1.2
rsi_vol_active = vol_short > vol_long * 1.2
market_active = price_vol_active or rsi_vol_active
smart_cooldown_bars = market_active ? math.max(base_cooldown - 1, 1) : base_cooldown
cooldown_bars = cooldown_mode == "Smart" ? smart_cooldown_bars : cooldown_bars_fixed

// ç»Ÿè®¡æ ·æœ¬é‡è®¡ç®—: n = (Z Ã— Ïƒ / E)Â²
rsi_vol_bootstrap = math.max(vol_dynamic, vol_long * 0.8)
stat_lookback = math.max(50, math.pow(1.96 * rsi_vol_bootstrap / 5, 2))
stat_error = lookback_precision == "High" ? 2.0 : lookback_precision == "Normal" ? 2.5 : 3.5
stat_required = math.pow(1.96 * rsi_vol_bootstrap / stat_error, 2)

// Smart Lookback: åŸºäºæ³¢åŠ¨ç‡å’Œç»Ÿè®¡éœ€æ±‚çš„åŠ¨æ€èŒƒå›´
// ä»·æ ¼æ³¢åŠ¨ç‡å†³å®šåŸºç¡€èŒƒå›´
price_based_min = avg_volatility > 6 ? 50 : avg_volatility > 3 ? 80 : avg_volatility > 1 ? 150 : 200
price_based_max = avg_volatility > 6 ? 400 : avg_volatility > 3 ? 600 : avg_volatility > 1 ? 800 : 1000
// ç»Ÿè®¡éœ€æ±‚å†³å®šæœ€å°å€¼ä¸‹é™ï¼ˆç¡®ä¿ lookback â‰ˆ stat_requiredï¼‰
stat_based_min = math.max(50, int(stat_required * 0.8))
// å–ä»·æ ¼æ³¢åŠ¨å’Œç»Ÿè®¡éœ€æ±‚ä¸­è¾ƒä½å€¼ä½œä¸ºæœ€ç»ˆæœ€å°å€¼
lookback_min = math.min(price_based_min, stat_based_min)
lookback_max = price_based_max

// åˆ†å¸ƒå®½åº¦åé¦ˆï¼ˆä½¿ç”¨å‰ä¸€ä¸ªbarçš„spreadï¼Œå½¢æˆåé¦ˆç¯ï¼‰
// åªåœ¨åˆ†å¸ƒçª„æ—¶å¢åŠ lookbackï¼Œåˆ†å¸ƒå®½æ—¶ä¸å‡å°‘ï¼ˆé¿å…ä½äºç»Ÿè®¡éœ€æ±‚ï¼‰
var float prev_spread = 30.0
spread_factor = prev_spread < 20 ? 1.3 : 1.0

// æœ€ç»ˆ lookback = ç»Ÿè®¡åŸºç¡€ Ã— åé¦ˆå› å­ï¼Œé™åˆ¶åœ¨åŠ¨æ€èŒƒå›´å†…
auto_lookback = int(math.max(lookback_min, math.min(lookback_max, stat_required * spread_factor)))
lookback = lookback_mode == "Custom" ? math.min(1000, lookback_custom) : auto_lookback

// å¥åº·åº¦æŒ‡æ ‡
health_sample_coverage = bar_index >= lookback * 0.8
health_stat_valid = lookback >= stat_required * 0.9
theoretical_lookback = int(math.max(100, math.min(2000, math.ceil(stat_lookback))))

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ADAPTIVE PERCENTILE CALCULATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rsi_p5  = ta.percentile_nearest_rank(rsi, lookback, 5)
rsi_p10 = ta.percentile_nearest_rank(rsi, lookback, 10)
rsi_p25 = ta.percentile_nearest_rank(rsi, lookback, 25)
rsi_p50 = ta.percentile_nearest_rank(rsi, lookback, 50)
rsi_p75 = ta.percentile_nearest_rank(rsi, lookback, 75)
rsi_p90 = ta.percentile_nearest_rank(rsi, lookback, 90)
rsi_p95 = ta.percentile_nearest_rank(rsi, lookback, 95)
current_spread = rsi_p95 - rsi_p5
health_distribution_spread = current_spread >= 15
prev_spread := current_spread

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RSI Z-SCORE CALCULATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rsi_mean = ta.sma(rsi, lookback)
rsi_stdev = ta.stdev(rsi, lookback)
rsi_zscore = rsi_stdev != 0 ? (rsi - rsi_mean) / rsi_stdev : 0

zscore_upper_2 = rsi_mean + rsi_stdev * 2
zscore_upper_1_5 = rsi_mean + rsi_stdev * 1.5
zscore_lower_1_5 = rsi_mean - rsi_stdev * 1.5
zscore_lower_2 = rsi_mean - rsi_stdev * 2

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Z-SCORE â†” PERCENTILE CONVERSION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

f_zscore_to_percentile(_zscore) =>
    _z = math.abs(_zscore)
    _pct = _z >= 3.0 ? 99.9 :
           _z >= 2.5 ? 99.4 :
           _z >= 2.0 ? 97.7 :
           _z >= 1.96 ? 97.5 :
           _z >= 1.5 ? 93.3 :
           _z >= 1.28 ? 90.0 :
           _z >= 1.0 ? 84.1 :
           _z >= 0.67 ? 75.0 :
           _z >= 0.5 ? 69.1 :
           _z >= 0.25 ? 59.9 : 50.0
    _zscore >= 0 ? _pct : 100 - _pct

f_percentile_zscore_range(_pct) =>
    _result = _pct < 2.3 ? " (< âˆ’2Ïƒ)" :
              _pct <= 6.7 ? " (âˆ’1.5Ïƒ ~ âˆ’2Ïƒ)" :
              _pct <= 15.9 ? " (âˆ’1Ïƒ ~ âˆ’1.5Ïƒ)" :
              _pct >= 97.7 ? " (> +2Ïƒ)" :
              _pct >= 93.3 ? " (+1.5Ïƒ ~ +2Ïƒ)" :
              _pct >= 84.1 ? " (+1Ïƒ ~ +1.5Ïƒ)" : ""
    _result

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TREND PROTECTION (Weekly-based)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

[weekly_rsi, weekly_close, weekly_sma20, weekly_sma50] = request.security(syminfo.tickerid, "W",
    [ta.rsi(close, 14), close, ta.sma(close, 20), ta.sma(close, 50)], lookahead=barmerge.lookahead_off)

weekly_uptrend = weekly_sma20 > weekly_sma50
weekly_extreme_bearish = weekly_rsi < 30 and weekly_sma20 < weekly_sma50
weekly_ultra_bearish = weekly_rsi < 20

trend_allows_buy = protection_level == "Aggressive" ? weekly_uptrend : protection_level == "Moderate" ? not weekly_extreme_bearish : not weekly_ultra_bearish

weekly_downtrend = weekly_sma20 < weekly_sma50
weekly_extreme_bullish = weekly_rsi > 70 and weekly_sma20 > weekly_sma50
weekly_ultra_bullish = weekly_rsi > 80

trend_allows_sell = protection_level == "Aggressive" ? weekly_downtrend : protection_level == "Moderate" ? not weekly_extreme_bullish : not weekly_ultra_bullish

protection_status = not enable_trend_protection ? "OFF" : trend_allows_buy and trend_allows_sell ? "âœ“" : trend_allows_buy ? "BUYâœ“" : trend_allows_sell ? "SELLâœ“" : "âš ï¸"

// æ™ºèƒ½æ™®é€šä¿¡å·æ˜¾ç¤ºé€»è¾‘
weekly_neutral = not weekly_extreme_bearish and not weekly_extreme_bullish
auto_show_normal = weekly_neutral
show_normal_signals = normal_signal_mode == "Off" ? false : normal_signal_mode == "On" ? true : auto_show_normal

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VOLUME CONFIRMATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

vol_sma20 = ta.sma(volume, 20)
volume_ratio = vol_sma20 > 0 ? volume / vol_sma20 : 1.0

volume_surge = volume_ratio >= volume_surge_mult
volume_normal = volume_ratio >= 0.8 and volume_ratio < volume_surge_mult
volume_low = volume_ratio < 0.8
volume_score = volume_surge ? 20 : volume_normal ? 10 : 0

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MULTI-TIMEFRAME RSI
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

f_get_auto_timeframes() =>
    string t1 = "60"
    string t2 = "240"
    string t3 = "D"

    if timeframe.isdaily
        t1 := "60"
        t2 := "240"
        t3 := "D"
    else if timeframe.in_seconds(timeframe.period) >= 14400
        t1 := "15"
        t2 := "60"
        t3 := "240"
    else if timeframe.in_seconds(timeframe.period) >= 3600
        t1 := "5"
        t2 := "15"
        t3 := "60"
    else if timeframe.in_seconds(timeframe.period) >= 900
        t1 := "1"
        t2 := "5"
        t3 := "15"
    else
        t1 := "1"
        t2 := "3"
        t3 := "5"

    [t1, t2, t3]

[auto_t1, auto_t2, auto_t3] = f_get_auto_timeframes()
active_tf1 = mtf_mode == "Auto" ? auto_t1 : mtf_tf1_input
active_tf2 = mtf_mode == "Auto" ? auto_t2 : mtf_tf2_input
active_tf3 = mtf_mode == "Auto" ? auto_t3 : mtf_tf3_input

f_rsi_data_mtf(_tf) =>
    request.security(syminfo.tickerid, _tf, [rsi, rsi_p10, rsi_p90], lookahead=barmerge.lookahead_off)

f_na_tuple() => [float(na), float(na), float(na)]
[rsi_tf1, p10_tf1_raw, p90_tf1_raw] = if enable_mtf 
    f_rsi_data_mtf(active_tf1) 
else 
    f_na_tuple()

[rsi_tf2, p10_tf2_raw, p90_tf2_raw] = if enable_mtf 
    f_rsi_data_mtf(active_tf2) 
else 
    f_na_tuple()

[rsi_tf3, p10_tf3_raw, p90_tf3_raw] = if enable_mtf 
    f_rsi_data_mtf(active_tf3) 
else 
    f_na_tuple()

p10_tf1 = p10_tf1_raw
p90_tf1 = p90_tf1_raw
p10_tf2 = p10_tf2_raw
p90_tf2 = p90_tf2_raw
p10_tf3 = p10_tf3_raw
p90_tf3 = p90_tf3_raw

f_status(_rsi, _p10, _p90) =>
    _rsi < _p10 ? 1 : _rsi > _p90 ? -1 : 0

f_tf_display(_tf) =>
    if str.contains(_tf, "D") or str.contains(_tf, "W") or str.contains(_tf, "M")
        _tf
    else
        int_tf = str.tonumber(_tf)
        if not na(int_tf)
            if int_tf < 60
                str.format("{0}m", int_tf)
            else if int_tf % 60 == 0
                str.format("{0}h", int_tf / 60)
            else
                str.format("{0}m", int_tf)
        else
            _tf

mtf_tf1_display = f_tf_display(active_tf1)
mtf_tf2_display = f_tf_display(active_tf2)
mtf_tf3_display = f_tf_display(active_tf3)
current_tf_display = f_tf_display(timeframe.period)

status_tf1 = f_status(rsi_tf1, p10_tf1, p90_tf1)
status_tf2 = f_status(rsi_tf2, p10_tf2, p90_tf2)
status_tf3 = f_status(rsi_tf3, p10_tf3, p90_tf3)
status_current = f_status(rsi, rsi_p10, rsi_p90)

tf1_is_current = mtf_tf1_display == current_tf_display
tf2_is_current = mtf_tf2_display == current_tf_display
tf3_is_current = mtf_tf3_display == current_tf_display

valid_tf_count = 1 + (tf1_is_current ? 0 : 1) + (tf2_is_current ? 0 : 1) + (tf3_is_current ? 0 : 1)

// ç®€å•è®¡æ•°ï¼ˆç”¨äºæ˜¾ç¤ºï¼‰
oversold_count = (status_current == 1 ? 1 : 0) + (not tf1_is_current and status_tf1 == 1 ? 1 : 0) + (not tf2_is_current and status_tf2 == 1 ? 1 : 0) + (not tf3_is_current and status_tf3 == 1 ? 1 : 0)
overbought_count = (status_current == -1 ? 1 : 0) + (not tf1_is_current and status_tf1 == -1 ? 1 : 0) + (not tf2_is_current and status_tf2 == -1 ? 1 : 0) + (not tf3_is_current and status_tf3 == -1 ? 1 : 0)

// v6.8: åŠ æƒå…±æŒ¯ - TF3æƒé‡2, å…¶ä»–æƒé‡1, æ»¡åˆ†5
oversold_weighted = (status_current == 1 ? 1 : 0) + (not tf1_is_current and status_tf1 == 1 ? 1 : 0) + (not tf2_is_current and status_tf2 == 1 ? 1 : 0) + (not tf3_is_current and status_tf3 == 1 ? 2 : 0)
overbought_weighted = (status_current == -1 ? 1 : 0) + (not tf1_is_current and status_tf1 == -1 ? 1 : 0) + (not tf2_is_current and status_tf2 == -1 ? 1 : 0) + (not tf3_is_current and status_tf3 == -1 ? 2 : 0)

// æœ€å¤§åŠ æƒåˆ†æ•°
max_weighted = 1 + (tf1_is_current ? 0 : 1) + (tf2_is_current ? 0 : 1) + (tf3_is_current ? 0 : 2)

// å…±æŒ¯è§¦å‘ï¼šåŠ æƒåˆ†æ•° >= 4ï¼ˆæ»¡åˆ†5ï¼‰ï¼Œæˆ–å½“å‘¨æœŸæ•°å°‘æ—¶å…¨éƒ¨ä¸€è‡´
oversold_resonance = oversold_weighted >= 4 or (valid_tf_count <= 3 and oversold_count == valid_tf_count)
overbought_resonance = overbought_weighted >= 4 or (valid_tf_count <= 3 and overbought_count == valid_tf_count)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SIGNAL STATISTICS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

type SignalStats
    int count = 0
    float total_return = 0.0
    int wins = 0

method update(SignalStats this, bool triggered, float ret) =>
    if triggered
        this.count += 1
        this.total_return += ret
        if ret > 0
            this.wins += 1

method get_avg(SignalStats this) =>
    this.count > 0 ? this.total_return / this.count : 0.0

method get_winrate(SignalStats this) =>
    this.count > 0 ? float(this.wins) / this.count * 100 : 0.0

method get_reliability(SignalStats this) =>
    this.count >= 20 ? "âœ“" : this.count >= 5 ? "âš ï¸" : "âŒ"

method get_adjusted_winrate(SignalStats this) =>
    if this.count < 5
        na
    else
        prior = 50.0
        confidence = math.min(1.0, float(this.count) / 20.0)
        raw_rate = this.get_winrate()
        prior * (1 - confidence) + raw_rate * confidence

// Signal Type Mode
var mtf_buy_stats = SignalStats.new()
var mtf_sell_stats = SignalStats.new()
var div_buy_stats = SignalStats.new()
var div_sell_stats = SignalStats.new()
var ext_buy_stats = SignalStats.new()
var ext_sell_stats = SignalStats.new()
var norm_buy_stats = SignalStats.new()
var norm_sell_stats = SignalStats.new()

// Grade Mode
var grade_a_buy_stats = SignalStats.new()
var grade_a_sell_stats = SignalStats.new()
var grade_b_buy_stats = SignalStats.new()
var grade_b_sell_stats = SignalStats.new()
var grade_c_buy_stats = SignalStats.new()
var grade_c_sell_stats = SignalStats.new()
var grade_d_buy_stats = SignalStats.new()
var grade_d_sell_stats = SignalStats.new()

// Ranking Mode (Signal Type Ã— Grade Ã— Direction)
var mtf_a_buy = SignalStats.new()
var mtf_a_sell = SignalStats.new()
var mtf_b_buy = SignalStats.new()
var mtf_b_sell = SignalStats.new()
var mtf_c_buy = SignalStats.new()
var mtf_c_sell = SignalStats.new()
var mtf_d_buy = SignalStats.new()
var mtf_d_sell = SignalStats.new()
var div_a_buy = SignalStats.new()
var div_a_sell = SignalStats.new()
var div_b_buy = SignalStats.new()
var div_b_sell = SignalStats.new()
var div_c_buy = SignalStats.new()
var div_c_sell = SignalStats.new()
var div_d_buy = SignalStats.new()
var div_d_sell = SignalStats.new()
var ext_a_buy = SignalStats.new()
var ext_a_sell = SignalStats.new()
var ext_b_buy = SignalStats.new()
var ext_b_sell = SignalStats.new()
var ext_c_buy = SignalStats.new()
var ext_c_sell = SignalStats.new()
var ext_d_buy = SignalStats.new()
var ext_d_sell = SignalStats.new()
var norm_a_buy = SignalStats.new()
var norm_a_sell = SignalStats.new()
var norm_b_buy = SignalStats.new()
var norm_b_sell = SignalStats.new()
var norm_c_buy = SignalStats.new()
var norm_c_sell = SignalStats.new()
var norm_d_buy = SignalStats.new()
var norm_d_sell = SignalStats.new()


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DIVERGENCE DETECTION (v6.8 é‡æ„: å•é”šç‚¹ + offsetç»˜åˆ¶)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// åªç”¨ price pivot ä½œä¸ºé”šç‚¹ï¼Œå–è¯¥ bar çš„ RSI å€¼è¿›è¡Œæ¯”è¾ƒ
// è¿™æ ·å¯ä»¥æ•è·æ›´å¤šæœ‰æ•ˆèƒŒç¦»ï¼Œé¿å…è¦æ±‚ RSI å’Œ price åŒæ—¶ pivot
price_pivot_low = ta.pivotlow(low, div_lookback, div_lookback)
price_pivot_high = ta.pivothigh(high, div_lookback, div_lookback)

var float prev_price_low = na
var float prev_rsi_at_low = na  // æ”¹åï¼šåœ¨ price pivot ç‚¹çš„ RSI å€¼
var int prev_low_bar = na
var float prev_price_high = na
var float prev_rsi_at_high = na  // æ”¹åï¼šåœ¨ price pivot ç‚¹çš„ RSI å€¼
var int prev_high_bar = na

var bool bullish_divergence = false
var bool bearish_divergence = false

if enable_divergence
    // çœ‹æ¶¨èƒŒç¦»ï¼šä»·æ ¼åˆ›æ–°ä½ï¼Œä½† RSI æœªåˆ›æ–°ä½ï¼ˆåªéœ€ price pivotï¼‰
    if not na(price_pivot_low)
        current_bar = bar_index - div_lookback
        current_rsi_at_pivot = rsi[div_lookback]  // å– price pivot ç‚¹çš„ RSI
        if not na(prev_price_low) and not na(prev_rsi_at_low)
            bars_since = current_bar - prev_low_bar
            // ä»·æ ¼æ›´ä½ï¼Œä½† RSI æ›´é«˜ = çœ‹æ¶¨èƒŒç¦»
            if bars_since <= div_range and low[div_lookback] < prev_price_low and current_rsi_at_pivot > prev_rsi_at_low
                bullish_divergence := true
            else
                bullish_divergence := false
        else
            bullish_divergence := false
        prev_price_low := low[div_lookback]
        prev_rsi_at_low := current_rsi_at_pivot
        prev_low_bar := current_bar
    else
        bullish_divergence := false

    // çœ‹è·ŒèƒŒç¦»ï¼šä»·æ ¼åˆ›æ–°é«˜ï¼Œä½† RSI æœªåˆ›æ–°é«˜ï¼ˆåªéœ€ price pivotï¼‰
    if not na(price_pivot_high)
        current_bar = bar_index - div_lookback
        current_rsi_at_pivot = rsi[div_lookback]  // å– price pivot ç‚¹çš„ RSI
        if not na(prev_price_high) and not na(prev_rsi_at_high)
            bars_since = current_bar - prev_high_bar
            // ä»·æ ¼æ›´é«˜ï¼Œä½† RSI æ›´ä½ = çœ‹è·ŒèƒŒç¦»
            if bars_since <= div_range and high[div_lookback] > prev_price_high and current_rsi_at_pivot < prev_rsi_at_high
                bearish_divergence := true
            else
                bearish_divergence := false
        else
            bearish_divergence := false
        prev_price_high := high[div_lookback]
        prev_rsi_at_high := current_rsi_at_pivot
        prev_high_bar := current_bar
    else
        bearish_divergence := false

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIRMATION & REVERSAL SIGNALS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

rsi_pivot_low_current = ta.pivotlow(rsi, 3, 1)
rsi_pivot_high_current = ta.pivothigh(rsi, 3, 1)

bool confirmation_buy = not na(rsi_pivot_low_current) and rsi_zscore[1] < -2
bool confirmation_sell = not na(rsi_pivot_high_current) and rsi_zscore[1] > 2

bool reversal_buy = ta.crossover(rsi_zscore, -2) and rsi_zscore[1] < -2
bool reversal_sell = ta.crossunder(rsi_zscore, 2) and rsi_zscore[1] > 2

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// REAL-TIME DIVERGENCE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

realtime_lookback = 20
lowest_price_20 = ta.lowest(low, realtime_lookback)
highest_price_20 = ta.highest(high, realtime_lookback)
lowest_rsi_20 = ta.lowest(rsi, realtime_lookback)
highest_rsi_20 = ta.highest(rsi, realtime_lookback)

price_near_low = low <= lowest_price_20 * 1.01
rsi_not_at_low = rsi > lowest_rsi_20 + 3
bool realtime_bullish_div = price_near_low and rsi_not_at_low and rsi_zscore < -1.5

price_near_high = high >= highest_price_20 * 0.99
rsi_not_at_high = rsi < highest_rsi_20 - 3
bool realtime_bearish_div = price_near_high and rsi_not_at_high and rsi_zscore > 1.5

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VISUAL PLOTTING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

show_unified = visual_line_mode == "Unified"
show_zscore_lines = show_unified or visual_line_mode == "Z-Score" or visual_line_mode == "Both"
show_percentile_lines = visual_line_mode == "Percentile" or visual_line_mode == "Both"

zscore_extreme_color = show_zscore_lines ? (visual_line_mode == "Both" ? 50 : 70) : 100
zscore_normal_color = show_zscore_lines ? (visual_line_mode == "Both" ? 60 : 80) : 100

plot(show_zscore_lines ? zscore_upper_2 : na, "Â±2Ïƒ (â‰ˆP98)", color=color.new(color_bear, zscore_extreme_color), linewidth=2, style=plot.style_line)
plot(show_zscore_lines ? zscore_upper_1_5 : na, "Â±1.5Ïƒ (â‰ˆP93)", color=color.new(color_bear, zscore_normal_color), linewidth=1, style=plot.style_circles)
plot(show_zscore_lines ? zscore_lower_1_5 : na, "Â±1.5Ïƒ (â‰ˆP7)", color=color.new(color_bull, zscore_normal_color), linewidth=1, style=plot.style_circles)
plot(show_zscore_lines ? zscore_lower_2 : na, "Â±2Ïƒ (â‰ˆP2)", color=color.new(color_bull, zscore_extreme_color), linewidth=2, style=plot.style_line)

percentile_line_transparency = show_percentile_lines ? (visual_line_mode == "Both" ? 85 : 70) : 100

p95_line = plot(rsi_p95, "P95", color=color.new(color_bear, percentile_line_transparency), linewidth=1)
p90_line = plot(rsi_p90, "P90", color=color.new(color_bear, percentile_line_transparency), linewidth=1, style=plot.style_circles)
p75_line = plot(rsi_p75, "P75", color=color.new(color.gray, percentile_line_transparency), linewidth=1)
p50_line = plot(rsi_p50, "P50", color=color.new(color.white, 50), linewidth=2, style=plot.style_stepline)
p25_line = plot(rsi_p25, "P25", color=color.new(color.gray, percentile_line_transparency), linewidth=1)
p10_line = plot(rsi_p10, "P10", color=color.new(color_bull, percentile_line_transparency), linewidth=1, style=plot.style_circles)
p5_line  = plot(rsi_p5, "P5", color=color.new(color_bull, percentile_line_transparency), linewidth=1)

rsi_line = plot(rsi, "RSI", color=color_rsi, linewidth=2)

fill(p95_line, p90_line, color=show_fill ? color.new(color_bear, 75) : na, title="Extreme Overbought")
fill(p90_line, p75_line, color=show_fill ? color.new(color_bear, 88) : na, title="Overbought")
fill(p75_line, p50_line, color=show_fill ? color.new(color_bear, 95) : na, title="Upper")
fill(p50_line, p25_line, color=show_fill ? color.new(color_bull, 95) : na, title="Lower")
fill(p25_line, p10_line, color=show_fill ? color.new(color_bull, 88) : na, title="Oversold")
fill(p10_line, p5_line, color=show_fill ? color.new(color_bull, 75) : na, title="Extreme Oversold")

hline(0, "0", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(100, "100", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(50, "50", color=color.new(color.gray, 90), linestyle=hline.style_dotted)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SIGNAL DETECTION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

raw_extreme_oversold = ta.crossunder(rsi_zscore, -2)
raw_extreme_overbought = ta.crossover(rsi_zscore, 2)
raw_normal_oversold = ta.crossunder(rsi_zscore, -normal_threshold) and not raw_extreme_oversold
raw_normal_overbought = ta.crossover(rsi_zscore, normal_threshold) and not raw_extreme_overbought

extreme_oversold = enable_trend_protection ? (raw_extreme_oversold and trend_allows_buy) : raw_extreme_oversold
extreme_overbought = enable_trend_protection ? (raw_extreme_overbought and trend_allows_sell) : raw_extreme_overbought
normal_oversold = enable_trend_protection ? (raw_normal_oversold and trend_allows_buy) : raw_normal_oversold
normal_overbought = enable_trend_protection ? (raw_normal_overbought and trend_allows_sell) : raw_normal_overbought

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SIGNAL COOLDOWN
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

var int last_mtf_buy_bar = na
var int last_mtf_sell_bar = na
var int last_div_buy_bar = na
var int last_div_sell_bar = na
var int last_ext_buy_bar = na
var int last_ext_sell_bar = na
var int last_norm_buy_bar = na
var int last_norm_sell_bar = na

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONSOLIDATED SIGNALS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

bool in_extreme_oversold = rsi_zscore < -2
bool in_extreme_overbought = rsi_zscore > 2

float zscore_at_div = rsi_stdev[div_lookback] != 0 ? (rsi[div_lookback] - rsi_mean[div_lookback]) / rsi_stdev[div_lookback] : 0
bool was_extreme_oversold = zscore_at_div < -2
bool was_extreme_overbought = zscore_at_div > 2

bool raw_sig_buy_mtf = enable_mtf and oversold_resonance and extreme_oversold
bool raw_sig_buy_div = enable_divergence and bullish_divergence and was_extreme_oversold and not raw_sig_buy_mtf
bool raw_sig_buy_extreme = extreme_oversold and not raw_sig_buy_mtf and not raw_sig_buy_div
bool raw_sig_buy_normal = normal_oversold and not raw_sig_buy_mtf and not raw_sig_buy_div and not raw_sig_buy_extreme

bool raw_sig_sell_mtf = enable_mtf and overbought_resonance and extreme_overbought
bool raw_sig_sell_div = enable_divergence and bearish_divergence and was_extreme_overbought and not raw_sig_sell_mtf
bool raw_sig_sell_extreme = extreme_overbought and not raw_sig_sell_mtf and not raw_sig_sell_div
bool raw_sig_sell_normal = normal_overbought and not raw_sig_sell_mtf and not raw_sig_sell_div and not raw_sig_sell_extreme

bool sig_buy_mtf = enable_signal_cooldown ? (raw_sig_buy_mtf and (na(last_mtf_buy_bar) or bar_index - last_mtf_buy_bar >= cooldown_bars)) : raw_sig_buy_mtf
bool sig_buy_div = enable_signal_cooldown ? (raw_sig_buy_div and (na(last_div_buy_bar) or bar_index - last_div_buy_bar >= cooldown_bars)) : raw_sig_buy_div
bool sig_buy_extreme = enable_signal_cooldown ? (raw_sig_buy_extreme and (na(last_ext_buy_bar) or bar_index - last_ext_buy_bar >= cooldown_bars)) : raw_sig_buy_extreme
bool sig_buy_normal = enable_signal_cooldown ? (raw_sig_buy_normal and (na(last_norm_buy_bar) or bar_index - last_norm_buy_bar >= cooldown_bars)) : raw_sig_buy_normal

bool sig_sell_mtf = enable_signal_cooldown ? (raw_sig_sell_mtf and (na(last_mtf_sell_bar) or bar_index - last_mtf_sell_bar >= cooldown_bars)) : raw_sig_sell_mtf
bool sig_sell_div = enable_signal_cooldown ? (raw_sig_sell_div and (na(last_div_sell_bar) or bar_index - last_div_sell_bar >= cooldown_bars)) : raw_sig_sell_div
bool sig_sell_extreme = enable_signal_cooldown ? (raw_sig_sell_extreme and (na(last_ext_sell_bar) or bar_index - last_ext_sell_bar >= cooldown_bars)) : raw_sig_sell_extreme
bool sig_sell_normal = enable_signal_cooldown ? (raw_sig_sell_normal and (na(last_norm_sell_bar) or bar_index - last_norm_sell_bar >= cooldown_bars)) : raw_sig_sell_normal

if sig_buy_mtf
    last_mtf_buy_bar := bar_index
if sig_buy_div
    last_div_buy_bar := bar_index
if sig_buy_extreme
    last_ext_buy_bar := bar_index
if sig_buy_normal
    last_norm_buy_bar := bar_index

if sig_sell_mtf
    last_mtf_sell_bar := bar_index
if sig_sell_div
    last_div_sell_bar := bar_index
if sig_sell_extreme
    last_ext_sell_bar := bar_index
if sig_sell_normal
    last_norm_sell_bar := bar_index

bool sig_div_bull_only = enable_divergence and bullish_divergence and not was_extreme_oversold
bool sig_div_bear_only = enable_divergence and bearish_divergence and not was_extreme_overbought

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SIGNAL QUALITY SCORING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

f_buy_quality() =>
    score = 0
    if rsi_zscore < -2
        score := 50
    if rsi_zscore < -2.5
        score += 20
    else if rsi_zscore < -2
        score += 10
    if bullish_divergence or oversold_resonance
        score += 25
    if weekly_uptrend
        score += 15
    if enable_volume_scoring and volume_surge
        score += 10
    if weekly_extreme_bearish
        score -= 20
    if enable_volume_scoring and volume_low
        score -= 10
    if not health_sample_coverage or not health_distribution_spread or not health_stat_valid
        score -= 15
    math.max(score, 0)

f_sell_quality() =>
    score = 0
    if rsi_zscore > 2
        score := 50
    if rsi_zscore > 2.5
        score += 20
    else if rsi_zscore > 2
        score += 10
    if bearish_divergence or overbought_resonance
        score += 25
    if weekly_downtrend
        score += 15
    if enable_volume_scoring and volume_surge
        score += 10
    if weekly_extreme_bullish
        score -= 20
    if enable_volume_scoring and volume_low
        score -= 10
    if not health_sample_coverage or not health_distribution_spread or not health_stat_valid
        score -= 15
    math.max(score, 0)

current_buy_quality = f_buy_quality()
current_sell_quality = f_sell_quality()

f_quality_grade(_score) =>
    _score >= 80 ? "A" : _score >= 60 ? "B" : _score >= 40 ? "C" : "D"

f_sig_emoji(_sig) =>
    _sig == 1 ? "ğŸŒŸ" : _sig == 2 ? "ğŸ’" : _sig == 3 ? "ğŸ”¥" : "â¬†ï¸"

f_dir_color(_dir, _bull, _bear) =>
    _dir == 1 ? _bull : _bear

buy_quality_grade = f_quality_grade(current_buy_quality)
sell_quality_grade = f_quality_grade(current_sell_quality)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ATR RISK CALCULATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

atr_14 = ta.atr(14)
atr_pct = atr_14 / close * 100

// æ­¢æŸå€æ•°æ ¹æ®ä¿¡å·è´¨é‡ç­‰çº§è°ƒæ•´
f_sl_multiplier(_grade) =>
    _grade == "A" ? 2.5 : _grade == "B" ? 2.0 : _grade == "C" ? 1.5 : 1.2

// è®¡ç®—æ­¢æŸ/æ­¢ç›ˆï¼ˆå¤šå¤´ï¼‰
buy_sl_mult = f_sl_multiplier(buy_quality_grade)
buy_sl_distance = atr_14 * buy_sl_mult
buy_sl_price = close - buy_sl_distance
buy_sl_pct = buy_sl_distance / close * 100
buy_tp_distance = buy_sl_distance * alert_rr_ratio
buy_tp_price = close + buy_tp_distance
buy_tp_pct = buy_tp_distance / close * 100

// è®¡ç®—æ­¢æŸ/æ­¢ç›ˆï¼ˆç©ºå¤´/é€€å‡ºå¤šå¤´ï¼‰
sell_sl_mult = f_sl_multiplier(sell_quality_grade)
sell_sl_distance = atr_14 * sell_sl_mult
sell_sl_price = close + sell_sl_distance  // ç©ºå¤´æ­¢æŸåœ¨ä¸Šæ–¹
sell_sl_pct = sell_sl_distance / close * 100
sell_tp_distance = sell_sl_distance * alert_rr_ratio
sell_tp_price = close - sell_tp_distance
sell_tp_pct = sell_tp_distance / close * 100

active_signal_grade = sig_buy_mtf or sig_buy_div or sig_buy_extreme or sig_buy_normal ? buy_quality_grade :
                      sig_sell_mtf or sig_sell_div or sig_sell_extreme or sig_sell_normal ? sell_quality_grade :
                      in_extreme_oversold ? buy_quality_grade :
                      in_extreme_overbought ? sell_quality_grade : ""

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATISTICS CALCULATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

has_buy_signal = sig_buy_mtf or sig_buy_div or sig_buy_extreme or sig_buy_normal
has_sell_signal = sig_sell_mtf or sig_sell_div or sig_sell_extreme or sig_sell_normal

if enable_stats and bar_index > stats_forward_bars
    forward_return_long = (close - close[stats_forward_bars]) / close[stats_forward_bars] * 100
    // Sellç»Ÿè®¡å£å¾„ï¼šLong Exit = ä»·æ ¼ä¸‹è·Œä¸ºæ­£ï¼ˆå–å‡ºæ­£ç¡®ï¼‰ï¼ŒShort Entry = åšç©ºæ”¶ç›Š
    // Long Exit: ä¿¡å·åä»·æ ¼ä¸‹è·Œ = å–å‡ºå†³ç­–æ­£ç¡®ï¼Œç”¨åŒæ ·çš„å…¬å¼ä½†ä»å¤šå¤´é€€å‡ºè§’åº¦è§£è¯»
    // Short Entry: åŸæœ‰é€»è¾‘ï¼Œåšç©ºæ”¶ç›Š
    forward_return_short = (close[stats_forward_bars] - close) / close[stats_forward_bars] * 100

    mtf_buy_stats.update(sig_buy_mtf[stats_forward_bars], forward_return_long)
    mtf_sell_stats.update(sig_sell_mtf[stats_forward_bars], forward_return_short)

    div_buy_stats.update(sig_buy_div[stats_forward_bars], forward_return_long)
    div_sell_stats.update(sig_sell_div[stats_forward_bars], forward_return_short)

    ext_buy_stats.update(sig_buy_extreme[stats_forward_bars], forward_return_long)
    ext_sell_stats.update(sig_sell_extreme[stats_forward_bars], forward_return_short)

    norm_buy_stats.update(sig_buy_normal[stats_forward_bars], forward_return_long)
    norm_sell_stats.update(sig_sell_normal[stats_forward_bars], forward_return_short)

    past_buy_signal = has_buy_signal[stats_forward_bars]
    past_buy_grade = buy_quality_grade[stats_forward_bars]
    if past_buy_signal
        if past_buy_grade == "A"
            grade_a_buy_stats.update(true, forward_return_long)
        else if past_buy_grade == "B"
            grade_b_buy_stats.update(true, forward_return_long)
        else if past_buy_grade == "C"
            grade_c_buy_stats.update(true, forward_return_long)
        else if past_buy_grade == "D"
            grade_d_buy_stats.update(true, forward_return_long)

    past_sell_signal = has_sell_signal[stats_forward_bars]
    past_sell_grade = sell_quality_grade[stats_forward_bars]
    if past_sell_signal
        if past_sell_grade == "A"
            grade_a_sell_stats.update(true, forward_return_short)
        else if past_sell_grade == "B"
            grade_b_sell_stats.update(true, forward_return_short)
        else if past_sell_grade == "C"
            grade_c_sell_stats.update(true, forward_return_short)
        else if past_sell_grade == "D"
            grade_d_sell_stats.update(true, forward_return_short)

    if sig_buy_mtf[stats_forward_bars]
        if past_buy_grade == "A"
            mtf_a_buy.update(true, forward_return_long)
        else if past_buy_grade == "B"
            mtf_b_buy.update(true, forward_return_long)
        else if past_buy_grade == "C"
            mtf_c_buy.update(true, forward_return_long)
        else if past_buy_grade == "D"
            mtf_d_buy.update(true, forward_return_long)
    if sig_sell_mtf[stats_forward_bars]
        if past_sell_grade == "A"
            mtf_a_sell.update(true, forward_return_short)
        else if past_sell_grade == "B"
            mtf_b_sell.update(true, forward_return_short)
        else if past_sell_grade == "C"
            mtf_c_sell.update(true, forward_return_short)
        else if past_sell_grade == "D"
            mtf_d_sell.update(true, forward_return_short)
    if sig_buy_div[stats_forward_bars]
        if past_buy_grade == "A"
            div_a_buy.update(true, forward_return_long)
        else if past_buy_grade == "B"
            div_b_buy.update(true, forward_return_long)
        else if past_buy_grade == "C"
            div_c_buy.update(true, forward_return_long)
        else if past_buy_grade == "D"
            div_d_buy.update(true, forward_return_long)
    if sig_sell_div[stats_forward_bars]
        if past_sell_grade == "A"
            div_a_sell.update(true, forward_return_short)
        else if past_sell_grade == "B"
            div_b_sell.update(true, forward_return_short)
        else if past_sell_grade == "C"
            div_c_sell.update(true, forward_return_short)
        else if past_sell_grade == "D"
            div_d_sell.update(true, forward_return_short)
    if sig_buy_extreme[stats_forward_bars]
        if past_buy_grade == "A"
            ext_a_buy.update(true, forward_return_long)
        else if past_buy_grade == "B"
            ext_b_buy.update(true, forward_return_long)
        else if past_buy_grade == "C"
            ext_c_buy.update(true, forward_return_long)
        else if past_buy_grade == "D"
            ext_d_buy.update(true, forward_return_long)
    if sig_sell_extreme[stats_forward_bars]
        if past_sell_grade == "A"
            ext_a_sell.update(true, forward_return_short)
        else if past_sell_grade == "B"
            ext_b_sell.update(true, forward_return_short)
        else if past_sell_grade == "C"
            ext_c_sell.update(true, forward_return_short)
        else if past_sell_grade == "D"
            ext_d_sell.update(true, forward_return_short)
    if sig_buy_normal[stats_forward_bars]
        if past_buy_grade == "A"
            norm_a_buy.update(true, forward_return_long)
        else if past_buy_grade == "B"
            norm_b_buy.update(true, forward_return_long)
        else if past_buy_grade == "C"
            norm_c_buy.update(true, forward_return_long)
        else if past_buy_grade == "D"
            norm_d_buy.update(true, forward_return_long)
    if sig_sell_normal[stats_forward_bars]
        if past_sell_grade == "A"
            norm_a_sell.update(true, forward_return_short)
        else if past_sell_grade == "B"
            norm_b_sell.update(true, forward_return_short)
        else if past_sell_grade == "C"
            norm_c_sell.update(true, forward_return_short)
        else if past_sell_grade == "D"
            norm_d_sell.update(true, forward_return_short)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATISTICS-DRIVEN FILTER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// è·å–å½“å‰ä¿¡å·å¯¹åº”çš„ç»Ÿè®¡æ•°æ®
f_get_signal_stats(_is_buy, _is_mtf, _is_div, _is_ext, _grade) =>
    SignalStats result = SignalStats.new()
    if _is_mtf
        result := _is_buy ? (_grade == "A" ? mtf_a_buy : _grade == "B" ? mtf_b_buy : _grade == "C" ? mtf_c_buy : mtf_d_buy) :
                           (_grade == "A" ? mtf_a_sell : _grade == "B" ? mtf_b_sell : _grade == "C" ? mtf_c_sell : mtf_d_sell)
    else if _is_div
        result := _is_buy ? (_grade == "A" ? div_a_buy : _grade == "B" ? div_b_buy : _grade == "C" ? div_c_buy : div_d_buy) :
                           (_grade == "A" ? div_a_sell : _grade == "B" ? div_b_sell : _grade == "C" ? div_c_sell : div_d_sell)
    else if _is_ext
        result := _is_buy ? (_grade == "A" ? ext_a_buy : _grade == "B" ? ext_b_buy : _grade == "C" ? ext_c_buy : ext_d_buy) :
                           (_grade == "A" ? ext_a_sell : _grade == "B" ? ext_b_sell : _grade == "C" ? ext_c_sell : ext_d_sell)
    else
        result := _is_buy ? (_grade == "A" ? norm_a_buy : _grade == "B" ? norm_b_buy : _grade == "C" ? norm_c_buy : norm_d_buy) :
                           (_grade == "A" ? norm_a_sell : _grade == "B" ? norm_b_sell : _grade == "C" ? norm_c_sell : norm_d_sell)
    result

// æ£€æŸ¥ä¿¡å·æ˜¯å¦é€šè¿‡ç»Ÿè®¡è¿‡æ»¤
f_passes_stats_filter(_stats) =>
    if not enable_stats_filter or not enable_stats
        true
    else
        _count = _stats.count
        _adj_wr = _stats.get_adjusted_winrate()
        _has_enough_samples = _count >= stats_min_samples
        _has_good_winrate = not na(_adj_wr) and _adj_wr >= stats_min_winrate
        _has_enough_samples and _has_good_winrate

// è®¡ç®—å„ä¿¡å·çš„è¿‡æ»¤çŠ¶æ€
buy_mtf_stats = f_get_signal_stats(true, true, false, false, buy_quality_grade)
buy_div_stats = f_get_signal_stats(true, false, true, false, buy_quality_grade)
buy_ext_stats = f_get_signal_stats(true, false, false, true, buy_quality_grade)
buy_norm_stats = f_get_signal_stats(true, false, false, false, buy_quality_grade)

sell_mtf_stats = f_get_signal_stats(false, true, false, false, sell_quality_grade)
sell_div_stats = f_get_signal_stats(false, false, true, false, sell_quality_grade)
sell_ext_stats = f_get_signal_stats(false, false, false, true, sell_quality_grade)
sell_norm_stats = f_get_signal_stats(false, false, false, false, sell_quality_grade)

// è¿‡æ»¤ç»“æœ
filter_buy_mtf = f_passes_stats_filter(buy_mtf_stats)
filter_buy_div = f_passes_stats_filter(buy_div_stats)
filter_buy_ext = f_passes_stats_filter(buy_ext_stats)
filter_buy_norm = f_passes_stats_filter(buy_norm_stats)

filter_sell_mtf = f_passes_stats_filter(sell_mtf_stats)
filter_sell_div = f_passes_stats_filter(sell_div_stats)
filter_sell_ext = f_passes_stats_filter(sell_ext_stats)
filter_sell_norm = f_passes_stats_filter(sell_norm_stats)

// æ ¹æ®è¿‡æ»¤æ¨¡å¼å†³å®šæ˜¾ç¤ºçš„ä¿¡å·
// Hard: åªæ˜¾ç¤ºé€šè¿‡çš„ä¿¡å·
// Soft: æ‰€æœ‰ä¿¡å·éƒ½æ˜¾ç¤ºï¼Œä½†é€šè¿‡çš„æ­£å¸¸æ˜¾ç¤ºï¼Œæœªé€šè¿‡çš„é™çº§æ˜¾ç¤º
// Alert Only: æ‰€æœ‰ä¿¡å·æ­£å¸¸æ˜¾ç¤ºï¼Œä»…Alertè¿‡æ»¤
show_buy_mtf = stats_filter_mode == "Hard" ? (sig_buy_mtf and filter_buy_mtf) : sig_buy_mtf
show_buy_div = stats_filter_mode == "Hard" ? (sig_buy_div and filter_buy_div) : sig_buy_div
show_buy_ext = stats_filter_mode == "Hard" ? (sig_buy_extreme and filter_buy_ext) : sig_buy_extreme
show_buy_norm = stats_filter_mode == "Hard" ? (sig_buy_normal and filter_buy_norm) : sig_buy_normal

show_sell_mtf = stats_filter_mode == "Hard" ? (sig_sell_mtf and filter_sell_mtf) : sig_sell_mtf
show_sell_div = stats_filter_mode == "Hard" ? (sig_sell_div and filter_sell_div) : sig_sell_div
show_sell_ext = stats_filter_mode == "Hard" ? (sig_sell_extreme and filter_sell_ext) : sig_sell_extreme
show_sell_norm = stats_filter_mode == "Hard" ? (sig_sell_normal and filter_sell_norm) : sig_sell_normal

// Softæ¨¡å¼ï¼šé™çº§æ˜¾ç¤ºï¼ˆæœªé€šè¿‡è¿‡æ»¤çš„ä¿¡å·ï¼‰
soft_degraded_buy_mtf = stats_filter_mode == "Soft" and sig_buy_mtf and not filter_buy_mtf
soft_degraded_buy_div = stats_filter_mode == "Soft" and sig_buy_div and not filter_buy_div
soft_degraded_buy_ext = stats_filter_mode == "Soft" and sig_buy_extreme and not filter_buy_ext
soft_degraded_buy_norm = stats_filter_mode == "Soft" and sig_buy_normal and not filter_buy_norm

soft_degraded_sell_mtf = stats_filter_mode == "Soft" and sig_sell_mtf and not filter_sell_mtf
soft_degraded_sell_div = stats_filter_mode == "Soft" and sig_sell_div and not filter_sell_div
soft_degraded_sell_ext = stats_filter_mode == "Soft" and sig_sell_extreme and not filter_sell_ext
soft_degraded_sell_norm = stats_filter_mode == "Soft" and sig_sell_normal and not filter_sell_norm

// Alertè¿‡æ»¤ï¼šæ‰€æœ‰æ¨¡å¼éƒ½åº”ç”¨
alert_buy_mtf = sig_buy_mtf and filter_buy_mtf
alert_buy_div = sig_buy_div and filter_buy_div
alert_buy_ext = sig_buy_extreme and filter_buy_ext
alert_buy_norm = sig_buy_normal and filter_buy_norm

alert_sell_mtf = sig_sell_mtf and filter_sell_mtf
alert_sell_div = sig_sell_div and filter_sell_div
alert_sell_ext = sig_sell_extreme and filter_sell_ext
alert_sell_norm = sig_sell_normal and filter_sell_norm

// å½“å‰ä¿¡å·çš„è¿‡æ»¤çŠ¶æ€ï¼ˆç”¨äºDashboardæ˜¾ç¤ºï¼‰
current_signal_passes_filter = sig_buy_mtf ? filter_buy_mtf :
                               sig_buy_div ? filter_buy_div :
                               sig_buy_extreme ? filter_buy_ext :
                               sig_buy_normal ? filter_buy_norm :
                               sig_sell_mtf ? filter_sell_mtf :
                               sig_sell_div ? filter_sell_div :
                               sig_sell_extreme ? filter_sell_ext :
                               sig_sell_normal ? filter_sell_norm : true

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SIGNAL DISPLAY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// æ­£å¸¸æ˜¾ç¤ºçš„ä¿¡å·ï¼ˆé€šè¿‡è¿‡æ»¤æˆ–éHardæ¨¡å¼ä¸”é€šè¿‡ï¼‰
plotshape(show_buy_mtf and not soft_degraded_buy_mtf, title="ğŸŒŸ MTF+æç«¯è¶…å–", style=shape.labelup, location=location.bottom, color=#00E676, size=size.normal, text="ğŸŒŸ", textcolor=color.white)
plotshape(show_buy_div and not soft_degraded_buy_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…å–", style=shape.labelup, location=location.bottom, color=#00BCD4, size=size.normal, text="ğŸ’", textcolor=color.white, offset=-div_lookback)
plotshape(show_buy_ext and not soft_degraded_buy_ext, title="ğŸ”¥ æç«¯è¶…å–", style=shape.triangleup, location=location.bottom, color=color_bull, size=size.small, text="ğŸ”¥")
plotshape(show_normal_signals and show_buy_norm and not soft_degraded_buy_norm, title="â¬†ï¸ æ™®é€šè¶…å–", style=shape.circle, location=location.bottom, color=color.new(color_bull, 30), size=size.tiny, text="â¬†ï¸")

// å–å‡ºä¿¡å· (é¡¶éƒ¨)
plotshape(show_sell_mtf and not soft_degraded_sell_mtf, title="ğŸŒŸ MTF+æç«¯è¶…ä¹°", style=shape.labeldown, location=location.top, color=#FF5252, size=size.normal, text="ğŸŒŸ", textcolor=color.white)
plotshape(show_sell_div and not soft_degraded_sell_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…ä¹°", style=shape.labeldown, location=location.top, color=#FF9800, size=size.normal, text="ğŸ’", textcolor=color.white, offset=-div_lookback)
plotshape(show_sell_ext and not soft_degraded_sell_ext, title="â„ï¸ æç«¯è¶…ä¹°", style=shape.triangledown, location=location.top, color=color_bear, size=size.small, text="â„ï¸")
plotshape(show_normal_signals and show_sell_norm and not soft_degraded_sell_norm, title="â¬‡ï¸ æ™®é€šè¶…ä¹°", style=shape.circle, location=location.top, color=color.new(color_bear, 30), size=size.tiny, text="â¬‡ï¸")

// Softæ¨¡å¼é™çº§æ˜¾ç¤ºï¼ˆåŠé€æ˜ã€æ›´å°ï¼‰
plotshape(soft_degraded_buy_mtf, title="ğŸŒŸ MTF+æç«¯è¶…å–(é™çº§)", style=shape.labelup, location=location.bottom, color=color.new(#00E676, 70), size=size.tiny, text="ğŸŒŸ", textcolor=color.new(color.white, 50))
plotshape(soft_degraded_buy_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…å–(é™çº§)", style=shape.labelup, location=location.bottom, color=color.new(#00BCD4, 70), size=size.tiny, text="ğŸ’", textcolor=color.new(color.white, 50), offset=-div_lookback)
plotshape(soft_degraded_buy_ext, title="ğŸ”¥ æç«¯è¶…å–(é™çº§)", style=shape.triangleup, location=location.bottom, color=color.new(color_bull, 70), size=size.tiny, text="ğŸ”¥")
plotshape(show_normal_signals and soft_degraded_buy_norm, title="â¬†ï¸ æ™®é€šè¶…å–(é™çº§)", style=shape.circle, location=location.bottom, color=color.new(color_bull, 80), size=size.tiny, text="â¬†ï¸")

plotshape(soft_degraded_sell_mtf, title="ğŸŒŸ MTF+æç«¯è¶…ä¹°(é™çº§)", style=shape.labeldown, location=location.top, color=color.new(#FF5252, 70), size=size.tiny, text="ğŸŒŸ", textcolor=color.new(color.white, 50))
plotshape(soft_degraded_sell_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…ä¹°(é™çº§)", style=shape.labeldown, location=location.top, color=color.new(#FF9800, 70), size=size.tiny, text="ğŸ’", textcolor=color.new(color.white, 50), offset=-div_lookback)
plotshape(soft_degraded_sell_ext, title="â„ï¸ æç«¯è¶…ä¹°(é™çº§)", style=shape.triangledown, location=location.top, color=color.new(color_bear, 70), size=size.tiny, text="â„ï¸")
plotshape(show_normal_signals and soft_degraded_sell_norm, title="â¬‡ï¸ æ™®é€šè¶…ä¹°(é™çº§)", style=shape.circle, location=location.top, color=color.new(color_bear, 80), size=size.tiny, text="â¬‡ï¸")

// çº¯èƒŒç¦»ä¿¡å·ï¼ˆå¸¦ offset ç»˜åˆ¶åˆ° pivot ç‚¹ï¼‰
plotshape(sig_div_bull_only, title="â†—ï¸ çœ‹æ¶¨èƒŒç¦»", style=shape.circle, location=location.bottom, color=#00BCD4, size=size.tiny, text="â†—ï¸", offset=-div_lookback)
plotshape(sig_div_bear_only, title="â†˜ï¸ çœ‹è·ŒèƒŒç¦»", style=shape.circle, location=location.top, color=#FF9800, size=size.tiny, text="â†˜ï¸", offset=-div_lookback)

// åŒå±‚èƒŒæ™¯ï¼šæ™®é€šåŒºåŸŸ(æµ…) + æç«¯åŒºåŸŸ(æ·±)
bgcolor(rsi_zscore < -normal_threshold ? color.new(color_bull, 93) : rsi_zscore > normal_threshold ? color.new(color_bear, 93) : na, title="Normal Zone")
bgcolor(rsi_zscore < -2 ? color.new(color_bull, 85) : rsi_zscore > 2 ? color.new(color_bear, 85) : na, title="Extreme Zone")

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// DASHBOARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

f_status_text(_status) =>
    _status == 1 ? "ğŸŸ¢" : _status == -1 ? "ğŸ”´" : "âšª"

if show_dashboard
    rsi_percentile = 0.0
    if rsi <= rsi_p5
        rsi_percentile := 5.0
    else if rsi <= rsi_p10
        rsi_percentile := 10.0
    else if rsi <= rsi_p25
        rsi_percentile := 25.0
    else if rsi <= rsi_p50
        rsi_percentile := 50.0
    else if rsi <= rsi_p75
        rsi_percentile := 75.0
    else if rsi <= rsi_p90
        rsi_percentile := 90.0
    else if rsi <= rsi_p95
        rsi_percentile := 95.0
    else
        rsi_percentile := 99.0

    status_text = rsi_zscore < -2 ? "ğŸŸ¢ EXTREME OVERSOLD" :
                  rsi_zscore < -1.5 ? "ğŸŸ¡ OVERSOLD" :
                  rsi_zscore > 2 ? "ğŸ”´ EXTREME OVERBOUGHT" :
                  rsi_zscore > 1.5 ? "ğŸŸ  OVERBOUGHT" : "âšª NEUTRAL"

    status_color = rsi_zscore < -1.5 ? color_bull : rsi_zscore > 1.5 ? color_bear : color.gray

    txt_size_title = dashboard_size == "Tiny" ? size.tiny : dashboard_size == "Small" ? size.small : dashboard_size == "Normal" ? size.normal : size.large
    txt_size_body = dashboard_size == "Tiny" ? size.tiny : dashboard_size == "Small" ? size.tiny : dashboard_size == "Normal" ? size.small : size.normal

    div_text = bullish_divergence ? "ğŸŸ¢ BULL" : bearish_divergence ? "ğŸ”´ BEAR" : "â€”"
    div_color = bullish_divergence ? #00BCD4 : bearish_divergence ? #FF9800 : color.gray

    resonance_text = oversold_resonance ? str.format("ğŸŸ¢ {0}/{1}", oversold_count, valid_tf_count) :
                     overbought_resonance ? str.format("ğŸ”´ {0}/{1}", overbought_count, valid_tf_count) :
                     str.format("âšª {0}/{1}", math.max(oversold_count, overbought_count), valid_tf_count)
    resonance_color = oversold_resonance ? color_bull : overbought_resonance ? color_bear : color.gray

    mobile_rows = 3
    lite_rows = 7
    full_rows = 7 + (enable_mtf and dashboard_mode == "Full" ? 2 : 0) + (enable_divergence and dashboard_mode == "Full" ? 1 : 0) + (enable_stats and dashboard_mode == "Full" ? 9 : 0)
    total_rows = dashboard_mode == "Mobile" ? mobile_rows : dashboard_mode == "Lite" ? lite_rows : full_rows

    var table dashboard = table.new(position.top_right, 2, 20,
                                     bgcolor=color.new(#1a1a2e, dashboard_transparency),
                                     border_width=1, border_color=color.new(#4a4a6a, 50))
    
    if barstate.islast
        row = 0

        if dashboard_mode == "Mobile"
            table.cell(dashboard, 0, row, "RSI", text_color=color.gray, text_size=txt_size_body, bgcolor=color.new(#2962FF, dashboard_transparency))
            table.cell(dashboard, 1, row, str.tostring(rsi, "#.1"), text_color=color_rsi, text_size=txt_size_body, bgcolor=color.new(#2962FF, dashboard_transparency))
            row += 1

            signal_text = "âšª"
            signal_color = color.gray
            mobile_filter_mark = enable_stats_filter and current_signal_passes_filter ? "âœ“" : enable_stats_filter ? "âš ï¸" : ""

            if sig_buy_mtf
                signal_text := "ğŸŒŸ [" + buy_quality_grade + "]" + (filter_buy_mtf ? "âœ“" : "âš ï¸")
                signal_color := color_bull
            else if sig_buy_div
                signal_text := "ğŸ’ [" + buy_quality_grade + "]" + (filter_buy_div ? "âœ“" : "âš ï¸")
                signal_color := color_bull
            else if sig_buy_extreme
                signal_text := "ğŸ”¥ [" + buy_quality_grade + "]" + (filter_buy_ext ? "âœ“" : "âš ï¸")
                signal_color := color_bull
            else if show_normal_signals and sig_buy_normal
                signal_text := "â¬†ï¸ [" + buy_quality_grade + "]" + (filter_buy_norm ? "âœ“" : "âš ï¸")
                signal_color := color_bull
            else if sig_sell_mtf
                signal_text := "ğŸŒŸ [" + sell_quality_grade + "]" + (filter_sell_mtf ? "âœ“" : "âš ï¸")
                signal_color := color_bear
            else if sig_sell_div
                signal_text := "ğŸ’ [" + sell_quality_grade + "]" + (filter_sell_div ? "âœ“" : "âš ï¸")
                signal_color := color_bear
            else if sig_sell_extreme
                signal_text := "â„ï¸ [" + sell_quality_grade + "]" + (filter_sell_ext ? "âœ“" : "âš ï¸")
                signal_color := color_bear
            else if show_normal_signals and sig_sell_normal
                signal_text := "â¬‡ï¸ [" + sell_quality_grade + "]" + (filter_sell_norm ? "âœ“" : "âš ï¸")
                signal_color := color_bear
            else if sig_div_bull_only
                signal_text := "â†—ï¸ [" + buy_quality_grade + "]"
                signal_color := #00BCD4
            else if sig_div_bear_only
                signal_text := "â†˜ï¸ [" + sell_quality_grade + "]"
                signal_color := #FF9800
            else if in_extreme_oversold
                signal_text := "ğŸ”¥æŒç»­ [" + buy_quality_grade + "]"
                signal_color := color.new(color_bull, 30)
            else if in_extreme_overbought
                signal_text := "â„ï¸æŒç»­ [" + sell_quality_grade + "]"
                signal_color := color.new(color_bear, 30)
            else if rsi_zscore < -normal_threshold
                signal_text := "â¬†ï¸åŒº"
                signal_color := color.new(color_bull, 50)
            else if rsi_zscore > normal_threshold
                signal_text := "â¬‡ï¸åŒº"
                signal_color := color.new(color_bear, 50)

            table.cell(dashboard, 0, row, "ä¿¡å·", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, signal_text, text_color=signal_color, text_size=txt_size_body)
            row += 1

            status_mobile = rsi_zscore < -2 ? "ğŸŸ¢æå–" : rsi_zscore < -1.5 ? "ğŸŸ¡è¶…å–" : rsi_zscore > 2 ? "ğŸ”´æä¹°" : rsi_zscore > 1.5 ? "ğŸŸ è¶…ä¹°" : "âšªä¸­æ€§"

            table.cell(dashboard, 0, row, "çŠ¶æ€", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, status_mobile, text_color=status_color, text_size=txt_size_body)
            row += 1

        else
            table.cell(dashboard, 0, row, "ADAPTIVE RSI", text_color=color.white, text_size=txt_size_title, bgcolor=color.new(#2962FF, dashboard_transparency))
            table.cell(dashboard, 1, row, str.tostring(rsi, "#.0"), text_color=color_rsi, text_size=txt_size_title, bgcolor=color.new(#2962FF, dashboard_transparency))
            row += 1

            zscore_approx_pct = f_zscore_to_percentile(rsi_zscore)
            zscore_display = str.format("{0,number,#.2}Ïƒ (â‰ˆP{1,number,#})", rsi_zscore, zscore_approx_pct)
            table.cell(dashboard, 0, row, "Z-Score", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, zscore_display, text_color=status_color, text_size=txt_size_body)
            row += 1

            pct_zscore_range = f_percentile_zscore_range(rsi_percentile)
            percentile_display = str.format("P{0,number,#}{1}", rsi_percentile, pct_zscore_range)
            table.cell(dashboard, 0, row, "Percentile", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, percentile_display, text_color=status_color, text_size=txt_size_body)
            row += 1

            // è¿‡æ»¤çŠ¶æ€æ ‡è®°
            filter_mark = ""
            if enable_stats_filter and active_signal_grade != ""
                filter_mark := current_signal_passes_filter ? "âœ“" : "âš ï¸"
            quality_display = active_signal_grade != "" ? str.format(" [{0}]{1}", active_signal_grade, filter_mark) : ""
            table.cell(dashboard, 0, row, "Status", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.format("{0}{1}", status_text, quality_display), text_color=status_color, text_size=txt_size_body)
            row += 1

            weekly_rsi_display = str.format("W.RSI:{0,number,#}", weekly_rsi)
            vol_display = volume_surge ? "ğŸ“Šâ†‘" : volume_low ? "ğŸ“Šâ†“" : "ğŸ“Š"
            protection_color = trend_allows_buy and trend_allows_sell ? color.white :
                              trend_allows_buy or trend_allows_sell ? color.yellow : color.red
            table.cell(dashboard, 0, row, str.format("Protection [{0}]", protection_level), text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.format("{0} {1} {2}", protection_status, weekly_rsi_display, vol_display), text_color=protection_color, text_size=txt_size_body)
            row += 1

            lookback_mode_display = lookback_mode == "Auto" ? "[Auto]" : "[Custom]"
            spread_indicator = spread_factor > 1.0 ? "â†‘" : spread_factor < 1.0 ? "â†“" : ""
            health_icons = (health_sample_coverage ? "âœ…" : "âš ï¸") + (health_distribution_spread ? "âœ…" : "âš ï¸") + (health_stat_valid ? "âœ…" : "âš ï¸")
            lookback_color = health_sample_coverage and health_distribution_spread and health_stat_valid ? color.white : color.yellow
            table.cell(dashboard, 0, row, str.format("Lookback {0}", lookback_mode_display), text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.format("{0}{1}({2}-{3}) {4}", lookback, spread_indicator, lookback_min, lookback_max, health_icons), text_color=lookback_color, text_size=txt_size_body)
            row += 1

            // Normal Signal è¡Œ
            normal_mode_display = normal_signal_mode == "Smart" ? "[Smart]" : normal_signal_mode == "On" ? "[On]" : "[Off]"
            normal_status = normal_signal_mode == "Off" ? "â€”" : show_normal_signals ? str.format("â¬†ï¸{0,number,#.2}Ïƒ âœ“", normal_threshold) : str.format("{0,number,#.2}Ïƒ âœ—", normal_threshold)
            normal_color = normal_signal_mode == "Off" ? color.gray : show_normal_signals ? color.white : color.new(color.gray, 50)
            table.cell(dashboard, 0, row, str.format("Normal {0}", normal_mode_display), text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, normal_status, text_color=normal_color, text_size=txt_size_body)
            row += 1

            if dashboard_mode == "Full"
                if enable_mtf
                    table.cell(dashboard, 0, row, str.format("MTF {0}|{1}|{2}", mtf_tf1_display, mtf_tf2_display, mtf_tf3_display), text_color=color.gray, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0}|{1}|{2}", f_status_text(status_tf1), f_status_text(status_tf2), f_status_text(status_tf3)), text_color=color.white, text_size=txt_size_body)
                    row += 1

                    table.cell(dashboard, 0, row, "Resonance", text_color=color.gray, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, resonance_text, text_color=resonance_color, text_size=txt_size_body)
                    row += 1

                if enable_divergence
                    div_mode_display = div_mode == "Auto" ? str.format("[{0}]", active_div_mode) : ""
                    table.cell(dashboard, 0, row, str.format("Divergence {0}", div_mode_display), text_color=color.gray, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0} ({1}/{2})", div_text, div_lookback, div_range), text_color=div_color, text_size=txt_size_body)
                    row += 1

                if enable_stats
                    stats_title = stats_mode == "Ranking" ? "â”€â”€ RANKING â”€â”€" : stats_mode == "Grade" ? "â”€â”€ GRADE STATS â”€â”€" : "â”€â”€ SIGNAL STATS â”€â”€"
                    sell_mode_hint = sell_stats_mode == "Long Exit" ? "Exit" : "Short"
                    table.cell(dashboard, 0, row, stats_title, text_color=color.gray, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("({0}b|{1})", stats_forward_bars, sell_mode_hint), text_color=color.gray, text_size=txt_size_body)
                    row += 1

                    if stats_mode == "Signal Type"
                        mtf_buy_wr = mtf_buy_stats.count >= 5 ? str.format("{0,number,#}%", mtf_buy_stats.get_adjusted_winrate()) : "--"
                        mtf_sell_wr = mtf_sell_stats.count >= 5 ? str.format("{0,number,#}%", mtf_sell_stats.get_adjusted_winrate()) : "--"
                        table.cell(dashboard, 0, row, str.format("ğŸŒŸMTF Buy({0}){1}", mtf_buy_stats.count, mtf_buy_stats.get_reliability()), text_color=#FFD700, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}%|{1}", mtf_buy_stats.get_avg(), mtf_buy_wr), text_color=color_bull, text_size=txt_size_body)
                        row += 1
                        table.cell(dashboard, 0, row, str.format("ğŸŒŸMTF Sell({0}){1}", mtf_sell_stats.count, mtf_sell_stats.get_reliability()), text_color=#FFD700, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}%|{1}", mtf_sell_stats.get_avg(), mtf_sell_wr), text_color=color_bear, text_size=txt_size_body)
                        row += 1

                        div_buy_wr = div_buy_stats.count >= 5 ? str.format("{0,number,#}%", div_buy_stats.get_adjusted_winrate()) : "--"
                        div_sell_wr = div_sell_stats.count >= 5 ? str.format("{0,number,#}%", div_sell_stats.get_adjusted_winrate()) : "--"
                        table.cell(dashboard, 0, row, str.format("ğŸ’Div Buy({0}){1}", div_buy_stats.count, div_buy_stats.get_reliability()), text_color=#00BCD4, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}%|{1}", div_buy_stats.get_avg(), div_buy_wr), text_color=color_bull, text_size=txt_size_body)
                        row += 1
                        table.cell(dashboard, 0, row, str.format("ğŸ’Div Sell({0}){1}", div_sell_stats.count, div_sell_stats.get_reliability()), text_color=#00BCD4, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}%|{1}", div_sell_stats.get_avg(), div_sell_wr), text_color=color_bear, text_size=txt_size_body)
                        row += 1

                        ext_buy_wr = ext_buy_stats.count >= 5 ? str.format("{0,number,#}%", ext_buy_stats.get_adjusted_winrate()) : "--"
                        ext_sell_wr = ext_sell_stats.count >= 5 ? str.format("{0,number,#}%", ext_sell_stats.get_adjusted_winrate()) : "--"
                        table.cell(dashboard, 0, row, str.format("ğŸ”¥Ext Buy({0}){1}", ext_buy_stats.count, ext_buy_stats.get_reliability()), text_color=color_bull, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}%|{1}", ext_buy_stats.get_avg(), ext_buy_wr), text_color=color_bull, text_size=txt_size_body)
                        row += 1
                        table.cell(dashboard, 0, row, str.format("â„ï¸Ext Sell({0}){1}", ext_sell_stats.count, ext_sell_stats.get_reliability()), text_color=color_bear, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}%|{1}", ext_sell_stats.get_avg(), ext_sell_wr), text_color=color_bear, text_size=txt_size_body)
                        row += 1

                        norm_buy_wr = norm_buy_stats.count >= 5 ? str.format("{0,number,#}%", norm_buy_stats.get_adjusted_winrate()) : "--"
                        norm_sell_wr = norm_sell_stats.count >= 5 ? str.format("{0,number,#}%", norm_sell_stats.get_adjusted_winrate()) : "--"
                        table.cell(dashboard, 0, row, str.format("â¬†ï¸Norm Buy({0}){1}", norm_buy_stats.count, norm_buy_stats.get_reliability()), text_color=color.new(color_bull, 30), text_size=txt_size_body)
                        table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}%|{1}", norm_buy_stats.get_avg(), norm_buy_wr), text_color=color_bull, text_size=txt_size_body)
                        row += 1
                        table.cell(dashboard, 0, row, str.format("â¬‡ï¸Norm Sell({0}){1}", norm_sell_stats.count, norm_sell_stats.get_reliability()), text_color=color.new(color_bear, 30), text_size=txt_size_body)
                        table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}%|{1}", norm_sell_stats.get_avg(), norm_sell_wr), text_color=color_bear, text_size=txt_size_body)
                        row += 1

                    else if stats_mode == "Grade"
                        a_buy_display = grade_a_buy_stats.count >= 5 ? str.format("{0,number,+#.1;-#.1}%|{1,number,#}%", grade_a_buy_stats.get_avg(), grade_a_buy_stats.get_adjusted_winrate()) : "--|--"
                        a_sell_display = grade_a_sell_stats.count >= 5 ? str.format("{0,number,+#.1;-#.1}%|{1,number,#}%", grade_a_sell_stats.get_avg(), grade_a_sell_stats.get_adjusted_winrate()) : "--|--"
                        table.cell(dashboard, 0, row, str.format("[A]ğŸ“ˆ({0}){1}", grade_a_buy_stats.count, grade_a_buy_stats.get_reliability()), text_color=#FFD700, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, a_buy_display, text_color=color_bull, text_size=txt_size_body)
                        row += 1
                        table.cell(dashboard, 0, row, str.format("[A]ğŸ“‰({0}){1}", grade_a_sell_stats.count, grade_a_sell_stats.get_reliability()), text_color=#FFD700, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, a_sell_display, text_color=color_bear, text_size=txt_size_body)
                        row += 1

                        b_buy_display = grade_b_buy_stats.count >= 5 ? str.format("{0,number,+#.1;-#.1}%|{1,number,#}%", grade_b_buy_stats.get_avg(), grade_b_buy_stats.get_adjusted_winrate()) : "--|--"
                        b_sell_display = grade_b_sell_stats.count >= 5 ? str.format("{0,number,+#.1;-#.1}%|{1,number,#}%", grade_b_sell_stats.get_avg(), grade_b_sell_stats.get_adjusted_winrate()) : "--|--"
                        table.cell(dashboard, 0, row, str.format("[B]ğŸ“ˆ({0}){1}", grade_b_buy_stats.count, grade_b_buy_stats.get_reliability()), text_color=#4CAF50, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, b_buy_display, text_color=color_bull, text_size=txt_size_body)
                        row += 1
                        table.cell(dashboard, 0, row, str.format("[B]ğŸ“‰({0}){1}", grade_b_sell_stats.count, grade_b_sell_stats.get_reliability()), text_color=#4CAF50, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, b_sell_display, text_color=color_bear, text_size=txt_size_body)
                        row += 1

                        c_buy_display = grade_c_buy_stats.count >= 5 ? str.format("{0,number,+#.1;-#.1}%|{1,number,#}%", grade_c_buy_stats.get_avg(), grade_c_buy_stats.get_adjusted_winrate()) : "--|--"
                        c_sell_display = grade_c_sell_stats.count >= 5 ? str.format("{0,number,+#.1;-#.1}%|{1,number,#}%", grade_c_sell_stats.get_avg(), grade_c_sell_stats.get_adjusted_winrate()) : "--|--"
                        table.cell(dashboard, 0, row, str.format("[C]ğŸ“ˆ({0}){1}", grade_c_buy_stats.count, grade_c_buy_stats.get_reliability()), text_color=#FF9800, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, c_buy_display, text_color=color_bull, text_size=txt_size_body)
                        row += 1
                        table.cell(dashboard, 0, row, str.format("[C]ğŸ“‰({0}){1}", grade_c_sell_stats.count, grade_c_sell_stats.get_reliability()), text_color=#FF9800, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, c_sell_display, text_color=color_bear, text_size=txt_size_body)
                        row += 1

                        d_buy_display = grade_d_buy_stats.count >= 5 ? str.format("{0,number,+#.1;-#.1}%|{1,number,#}%", grade_d_buy_stats.get_avg(), grade_d_buy_stats.get_adjusted_winrate()) : "--|--"
                        d_sell_display = grade_d_sell_stats.count >= 5 ? str.format("{0,number,+#.1;-#.1}%|{1,number,#}%", grade_d_sell_stats.get_avg(), grade_d_sell_stats.get_adjusted_winrate()) : "--|--"
                        table.cell(dashboard, 0, row, str.format("[D]ğŸ“ˆ({0}){1}", grade_d_buy_stats.count, grade_d_buy_stats.get_reliability()), text_color=#9E9E9E, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, d_buy_display, text_color=color_bull, text_size=txt_size_body)
                        row += 1
                        table.cell(dashboard, 0, row, str.format("[D]ğŸ“‰({0}){1}", grade_d_sell_stats.count, grade_d_sell_stats.get_reliability()), text_color=#9E9E9E, text_size=txt_size_body)
                        table.cell(dashboard, 1, row, d_sell_display, text_color=color_bear, text_size=txt_size_body)

                    else if stats_mode == "Ranking"
                        var ranking_wr = array.new_float(32, 0.0)
                        var ranking_ret = array.new_float(32, 0.0)
                        var ranking_cnt = array.new_int(32, 0)
                        var ranking_sig = array.new_int(32, 0)
                        var ranking_grd = array.new_string(32, "")
                        var ranking_dir = array.new_int(32, 0)

                        array.set(ranking_wr, 0, mtf_a_buy.count >= 5 ? mtf_a_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 0, mtf_a_buy.get_avg())
                        array.set(ranking_cnt, 0, mtf_a_buy.count)
                        array.set(ranking_sig, 0, 1)
                        array.set(ranking_grd, 0, "A")
                        array.set(ranking_dir, 0, 1)

                        array.set(ranking_wr, 1, mtf_a_sell.count >= 5 ? mtf_a_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 1, mtf_a_sell.get_avg())
                        array.set(ranking_cnt, 1, mtf_a_sell.count)
                        array.set(ranking_sig, 1, 1)
                        array.set(ranking_grd, 1, "A")
                        array.set(ranking_dir, 1, 2)

                        array.set(ranking_wr, 2, mtf_b_buy.count >= 5 ? mtf_b_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 2, mtf_b_buy.get_avg())
                        array.set(ranking_cnt, 2, mtf_b_buy.count)
                        array.set(ranking_sig, 2, 1)
                        array.set(ranking_grd, 2, "B")
                        array.set(ranking_dir, 2, 1)

                        array.set(ranking_wr, 3, mtf_b_sell.count >= 5 ? mtf_b_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 3, mtf_b_sell.get_avg())
                        array.set(ranking_cnt, 3, mtf_b_sell.count)
                        array.set(ranking_sig, 3, 1)
                        array.set(ranking_grd, 3, "B")
                        array.set(ranking_dir, 3, 2)

                        array.set(ranking_wr, 4, mtf_c_buy.count >= 5 ? mtf_c_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 4, mtf_c_buy.get_avg())
                        array.set(ranking_cnt, 4, mtf_c_buy.count)
                        array.set(ranking_sig, 4, 1)
                        array.set(ranking_grd, 4, "C")
                        array.set(ranking_dir, 4, 1)

                        array.set(ranking_wr, 5, mtf_c_sell.count >= 5 ? mtf_c_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 5, mtf_c_sell.get_avg())
                        array.set(ranking_cnt, 5, mtf_c_sell.count)
                        array.set(ranking_sig, 5, 1)
                        array.set(ranking_grd, 5, "C")
                        array.set(ranking_dir, 5, 2)

                        array.set(ranking_wr, 6, mtf_d_buy.count >= 5 ? mtf_d_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 6, mtf_d_buy.get_avg())
                        array.set(ranking_cnt, 6, mtf_d_buy.count)
                        array.set(ranking_sig, 6, 1)
                        array.set(ranking_grd, 6, "D")
                        array.set(ranking_dir, 6, 1)

                        array.set(ranking_wr, 7, mtf_d_sell.count >= 5 ? mtf_d_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 7, mtf_d_sell.get_avg())
                        array.set(ranking_cnt, 7, mtf_d_sell.count)
                        array.set(ranking_sig, 7, 1)
                        array.set(ranking_grd, 7, "D")
                        array.set(ranking_dir, 7, 2)

                        // Div Ã— Grade (index 8-15)
                        array.set(ranking_wr, 8, div_a_buy.count >= 5 ? div_a_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 8, div_a_buy.get_avg())
                        array.set(ranking_cnt, 8, div_a_buy.count)
                        array.set(ranking_sig, 8, 2)
                        array.set(ranking_grd, 8, "A")
                        array.set(ranking_dir, 8, 1)

                        array.set(ranking_wr, 9, div_a_sell.count >= 5 ? div_a_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 9, div_a_sell.get_avg())
                        array.set(ranking_cnt, 9, div_a_sell.count)
                        array.set(ranking_sig, 9, 2)
                        array.set(ranking_grd, 9, "A")
                        array.set(ranking_dir, 9, 2)

                        array.set(ranking_wr, 10, div_b_buy.count >= 5 ? div_b_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 10, div_b_buy.get_avg())
                        array.set(ranking_cnt, 10, div_b_buy.count)
                        array.set(ranking_sig, 10, 2)
                        array.set(ranking_grd, 10, "B")
                        array.set(ranking_dir, 10, 1)

                        array.set(ranking_wr, 11, div_b_sell.count >= 5 ? div_b_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 11, div_b_sell.get_avg())
                        array.set(ranking_cnt, 11, div_b_sell.count)
                        array.set(ranking_sig, 11, 2)
                        array.set(ranking_grd, 11, "B")
                        array.set(ranking_dir, 11, 2)

                        array.set(ranking_wr, 12, div_c_buy.count >= 5 ? div_c_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 12, div_c_buy.get_avg())
                        array.set(ranking_cnt, 12, div_c_buy.count)
                        array.set(ranking_sig, 12, 2)
                        array.set(ranking_grd, 12, "C")
                        array.set(ranking_dir, 12, 1)

                        array.set(ranking_wr, 13, div_c_sell.count >= 5 ? div_c_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 13, div_c_sell.get_avg())
                        array.set(ranking_cnt, 13, div_c_sell.count)
                        array.set(ranking_sig, 13, 2)
                        array.set(ranking_grd, 13, "C")
                        array.set(ranking_dir, 13, 2)

                        array.set(ranking_wr, 14, div_d_buy.count >= 5 ? div_d_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 14, div_d_buy.get_avg())
                        array.set(ranking_cnt, 14, div_d_buy.count)
                        array.set(ranking_sig, 14, 2)
                        array.set(ranking_grd, 14, "D")
                        array.set(ranking_dir, 14, 1)

                        array.set(ranking_wr, 15, div_d_sell.count >= 5 ? div_d_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 15, div_d_sell.get_avg())
                        array.set(ranking_cnt, 15, div_d_sell.count)
                        array.set(ranking_sig, 15, 2)
                        array.set(ranking_grd, 15, "D")
                        array.set(ranking_dir, 15, 2)

                        // Ext Ã— Grade (index 16-23)
                        array.set(ranking_wr, 16, ext_a_buy.count >= 5 ? ext_a_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 16, ext_a_buy.get_avg())
                        array.set(ranking_cnt, 16, ext_a_buy.count)
                        array.set(ranking_sig, 16, 3)
                        array.set(ranking_grd, 16, "A")
                        array.set(ranking_dir, 16, 1)

                        array.set(ranking_wr, 17, ext_a_sell.count >= 5 ? ext_a_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 17, ext_a_sell.get_avg())
                        array.set(ranking_cnt, 17, ext_a_sell.count)
                        array.set(ranking_sig, 17, 3)
                        array.set(ranking_grd, 17, "A")
                        array.set(ranking_dir, 17, 2)

                        array.set(ranking_wr, 18, ext_b_buy.count >= 5 ? ext_b_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 18, ext_b_buy.get_avg())
                        array.set(ranking_cnt, 18, ext_b_buy.count)
                        array.set(ranking_sig, 18, 3)
                        array.set(ranking_grd, 18, "B")
                        array.set(ranking_dir, 18, 1)

                        array.set(ranking_wr, 19, ext_b_sell.count >= 5 ? ext_b_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 19, ext_b_sell.get_avg())
                        array.set(ranking_cnt, 19, ext_b_sell.count)
                        array.set(ranking_sig, 19, 3)
                        array.set(ranking_grd, 19, "B")
                        array.set(ranking_dir, 19, 2)

                        array.set(ranking_wr, 20, ext_c_buy.count >= 5 ? ext_c_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 20, ext_c_buy.get_avg())
                        array.set(ranking_cnt, 20, ext_c_buy.count)
                        array.set(ranking_sig, 20, 3)
                        array.set(ranking_grd, 20, "C")
                        array.set(ranking_dir, 20, 1)

                        array.set(ranking_wr, 21, ext_c_sell.count >= 5 ? ext_c_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 21, ext_c_sell.get_avg())
                        array.set(ranking_cnt, 21, ext_c_sell.count)
                        array.set(ranking_sig, 21, 3)
                        array.set(ranking_grd, 21, "C")
                        array.set(ranking_dir, 21, 2)

                        array.set(ranking_wr, 22, ext_d_buy.count >= 5 ? ext_d_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 22, ext_d_buy.get_avg())
                        array.set(ranking_cnt, 22, ext_d_buy.count)
                        array.set(ranking_sig, 22, 3)
                        array.set(ranking_grd, 22, "D")
                        array.set(ranking_dir, 22, 1)

                        array.set(ranking_wr, 23, ext_d_sell.count >= 5 ? ext_d_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 23, ext_d_sell.get_avg())
                        array.set(ranking_cnt, 23, ext_d_sell.count)
                        array.set(ranking_sig, 23, 3)
                        array.set(ranking_grd, 23, "D")
                        array.set(ranking_dir, 23, 2)

                        // Norm Ã— Grade (index 24-31)
                        array.set(ranking_wr, 24, norm_a_buy.count >= 5 ? norm_a_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 24, norm_a_buy.get_avg())
                        array.set(ranking_cnt, 24, norm_a_buy.count)
                        array.set(ranking_sig, 24, 4)
                        array.set(ranking_grd, 24, "A")
                        array.set(ranking_dir, 24, 1)

                        array.set(ranking_wr, 25, norm_a_sell.count >= 5 ? norm_a_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 25, norm_a_sell.get_avg())
                        array.set(ranking_cnt, 25, norm_a_sell.count)
                        array.set(ranking_sig, 25, 4)
                        array.set(ranking_grd, 25, "A")
                        array.set(ranking_dir, 25, 2)

                        array.set(ranking_wr, 26, norm_b_buy.count >= 5 ? norm_b_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 26, norm_b_buy.get_avg())
                        array.set(ranking_cnt, 26, norm_b_buy.count)
                        array.set(ranking_sig, 26, 4)
                        array.set(ranking_grd, 26, "B")
                        array.set(ranking_dir, 26, 1)

                        array.set(ranking_wr, 27, norm_b_sell.count >= 5 ? norm_b_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 27, norm_b_sell.get_avg())
                        array.set(ranking_cnt, 27, norm_b_sell.count)
                        array.set(ranking_sig, 27, 4)
                        array.set(ranking_grd, 27, "B")
                        array.set(ranking_dir, 27, 2)

                        array.set(ranking_wr, 28, norm_c_buy.count >= 5 ? norm_c_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 28, norm_c_buy.get_avg())
                        array.set(ranking_cnt, 28, norm_c_buy.count)
                        array.set(ranking_sig, 28, 4)
                        array.set(ranking_grd, 28, "C")
                        array.set(ranking_dir, 28, 1)

                        array.set(ranking_wr, 29, norm_c_sell.count >= 5 ? norm_c_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 29, norm_c_sell.get_avg())
                        array.set(ranking_cnt, 29, norm_c_sell.count)
                        array.set(ranking_sig, 29, 4)
                        array.set(ranking_grd, 29, "C")
                        array.set(ranking_dir, 29, 2)

                        array.set(ranking_wr, 30, norm_d_buy.count >= 5 ? norm_d_buy.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 30, norm_d_buy.get_avg())
                        array.set(ranking_cnt, 30, norm_d_buy.count)
                        array.set(ranking_sig, 30, 4)
                        array.set(ranking_grd, 30, "D")
                        array.set(ranking_dir, 30, 1)

                        array.set(ranking_wr, 31, norm_d_sell.count >= 5 ? norm_d_sell.get_adjusted_winrate() : 0)
                        array.set(ranking_ret, 31, norm_d_sell.get_avg())
                        array.set(ranking_cnt, 31, norm_d_sell.count)
                        array.set(ranking_sig, 31, 4)
                        array.set(ranking_grd, 31, "D")
                        array.set(ranking_dir, 31, 2)

                        // åˆ›å»ºç´¢å¼•æ•°ç»„ç”¨äºæ’åº
                        var ranking_idx = array.new_int(32)
                        for i = 0 to 31
                            array.set(ranking_idx, i, i)

                        for i = 0 to 30
                            for j = 0 to 30 - i
                                idx_j = array.get(ranking_idx, j)
                                idx_j1 = array.get(ranking_idx, j + 1)
                                if array.get(ranking_wr, idx_j) < array.get(ranking_wr, idx_j1)
                                    array.set(ranking_idx, j, idx_j1)
                                    array.set(ranking_idx, j + 1, idx_j)

                        display_count = 0
                        for i = 0 to 31
                            if display_count >= 8
                                break
                            idx = array.get(ranking_idx, i)
                            wr = array.get(ranking_wr, idx)
                            if wr > 0  // åªæ˜¾ç¤ºæœ‰æ•°æ®çš„
                                sig = array.get(ranking_sig, idx)
                                grd = array.get(ranking_grd, idx)
                                dir = array.get(ranking_dir, idx)
                                ret = array.get(ranking_ret, idx)
                                cnt = array.get(ranking_cnt, idx)
                                rel = cnt >= 20 ? "âœ“" : cnt >= 5 ? "âš ï¸" : "âŒ"
                                dir_text = dir == 1 ? "ğŸ“ˆ" : "ğŸ“‰"
                                dir_clr = f_dir_color(dir, color_bull, color_bear)

                                label_text = str.format("{0}[{1}]{2}({3}){4}", f_sig_emoji(sig), grd, dir_text, cnt, rel)
                                value_text = str.format("{0,number,+#.1;-#.1}%|{1,number,#}%", ret, wr)

                                table.cell(dashboard, 0, row, label_text, text_color=dir_clr, text_size=txt_size_body)
                                table.cell(dashboard, 1, row, value_text, text_color=dir_clr, text_size=txt_size_body)
                                row += 1
                                display_count += 1

                        // å¦‚æœæ²¡æœ‰æ•°æ®æ˜¾ç¤ºæç¤º
                        if display_count == 0
                            table.cell(dashboard, 0, row, "No data yet", text_color=color.gray, text_size=txt_size_body)
                            table.cell(dashboard, 1, row, "Need â‰¥5 signals", text_color=color.gray, text_size=txt_size_body)

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SMART ALERT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

varip int buy_alert_level_sent = 0
varip int sell_alert_level_sent = 0

f_signal_level(_mtf, _div, _ext, _norm) =>
    _mtf ? 4 : _div ? 3 : _ext ? 2 : _norm ? 1 : 0

if barstate.isnew
    buy_alert_level_sent := 0
    sell_alert_level_sent := 0

if enable_smart_alert
    // ä½¿ç”¨ç»Ÿè®¡è¿‡æ»¤åçš„ä¿¡å·ï¼ˆæ‰€æœ‰æ¨¡å¼éƒ½è¿‡æ»¤Alertï¼‰
    filtered_buy_normal = show_normal_signals and alert_buy_norm
    filtered_sell_normal = show_normal_signals and alert_sell_norm
    alert_has_buy = alert_buy_mtf or alert_buy_div or alert_buy_ext or filtered_buy_normal
    alert_has_sell = alert_sell_mtf or alert_sell_div or alert_sell_ext or filtered_sell_normal

    has_buy_signal_prev = alert_buy_mtf[1] or alert_buy_div[1] or alert_buy_ext[1] or (show_normal_signals[1] and alert_buy_norm[1])
    current_buy_level = f_signal_level(alert_buy_mtf, alert_buy_div, alert_buy_ext, filtered_buy_normal)
    should_alert_buy = alert_has_buy and not has_buy_signal_prev and current_buy_level > buy_alert_level_sent

    if should_alert_buy
        msg = str.format("{0}: ğŸŸ¢ BUY SIGNALS â†’ ", syminfo.ticker)

        if alert_buy_mtf
            msg := msg + "ğŸŒŸMTFå…±æŒ¯ "
        if alert_buy_div
            msg := msg + "ğŸ’èƒŒç¦» "
        if alert_buy_ext
            msg := msg + "ğŸ”¥æç«¯ "
        if filtered_buy_normal
            msg := msg + "â¬†ï¸è¶…å– "

        if confirmation_buy
            msg := msg + "âœ“ç¡®è®¤ "
        if reversal_buy
            msg := msg + "â†©åè½¬ "
        if realtime_bullish_div
            msg := msg + "âš¡å®æ—¶èƒŒç¦» "

        // æ·»åŠ è¿‡æ»¤çŠ¶æ€æ ‡è®°
        filter_status = current_signal_passes_filter ? "âœ“" : "âš ï¸"
        zscore_pct = f_zscore_to_percentile(rsi_zscore)
        msg := msg + str.format("| RSI:{0,number,#.1} Z:{1,number,#.2}Ïƒ (â‰ˆP{2,number,#}) [{3}]{4}", rsi, rsi_zscore, zscore_pct, buy_quality_grade, filter_status)

        // å¯é€‰ï¼šæ·»åŠ é£é™©æç¤º
        if include_risk_in_alerts
            msg := msg + str.format(" | SL:-{0,number,#.1}% TP:+{1,number,#.1}%", buy_sl_pct, buy_tp_pct)

        alert(msg, alert.freq_once_per_bar)
        buy_alert_level_sent := current_buy_level

    has_sell_signal_prev = alert_sell_mtf[1] or alert_sell_div[1] or alert_sell_ext[1] or (show_normal_signals[1] and alert_sell_norm[1])
    current_sell_level = f_signal_level(alert_sell_mtf, alert_sell_div, alert_sell_ext, filtered_sell_normal)
    should_alert_sell = alert_has_sell and not has_sell_signal_prev and current_sell_level > sell_alert_level_sent

    if should_alert_sell
        msg = str.format("{0}: ğŸ”´ SELL SIGNALS â†’ ", syminfo.ticker)

        if alert_sell_mtf
            msg := msg + "ğŸŒŸMTFå…±æŒ¯ "
        if alert_sell_div
            msg := msg + "ğŸ’èƒŒç¦» "
        if alert_sell_ext
            msg := msg + "â„ï¸æç«¯ "
        if filtered_sell_normal
            msg := msg + "â¬‡ï¸è¶…ä¹° "

        if confirmation_sell
            msg := msg + "âœ“ç¡®è®¤ "
        if reversal_sell
            msg := msg + "â†©åè½¬ "
        if realtime_bearish_div
            msg := msg + "âš¡å®æ—¶èƒŒç¦» "

        // æ·»åŠ è¿‡æ»¤çŠ¶æ€æ ‡è®°
        filter_status = current_signal_passes_filter ? "âœ“" : "âš ï¸"
        zscore_pct = f_zscore_to_percentile(rsi_zscore)
        msg := msg + str.format("| RSI:{0,number,#.1} Z:{1,number,#.2}Ïƒ (â‰ˆP{2,number,#}) [{3}]{4}", rsi, rsi_zscore, zscore_pct, sell_quality_grade, filter_status)

        // å¯é€‰ï¼šæ·»åŠ é£é™©æç¤º
        if include_risk_in_alerts
            msg := msg + str.format(" | SL:+{0,number,#.1}% TP:-{1,number,#.1}%", sell_sl_pct, sell_tp_pct)

        alert(msg, alert.freq_once_per_bar)
        sell_alert_level_sent := current_sell_level
