// MIT License - Feel free to use, modify, and share.
// Â© Adaptive RSI Pro - Dynamic Thresholds + MTF + Divergence + Statistics

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ EMOJI LEGEND / ä¿¡å·å›¾ä¾‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ CHART SIGNALS / å›¾è¡¨ä¿¡å·                                                    â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ BUY / ä¹°å…¥ (æ˜¾ç¤ºåœ¨åº•éƒ¨)                                                     â”‚
// â”‚   ğŸŒŸ MTF Resonance + Extreme Oversold  å¤šå‘¨æœŸå…±æŒ¯+æç«¯è¶…å– (æœ€å¼ºä¹°å…¥ä¿¡å·)    â”‚
// â”‚   ğŸ’ Divergence + Extreme Oversold     èƒŒç¦»+æç«¯è¶…å– (å¼ºä¹°å…¥ä¿¡å·)            â”‚
// â”‚   ğŸ”¥ Extreme Oversold (Z<âˆ’2Ïƒâ‰ˆP2)       æç«¯è¶…å– (ä¹°å…¥ä¿¡å·)                   â”‚
// â”‚   â¬†ï¸ Normal Oversold (Z<âˆ’1.5Ïƒâ‰ˆP7)       æ™®é€šè¶…å– (å¼±ä¹°å…¥ï¼Œé»˜è®¤éšè—)          â”‚
// â”‚   â†—ï¸ Bullish Divergence Only            çœ‹æ¶¨èƒŒç¦» (æ½œåœ¨åº•éƒ¨ï¼Œéä¿¡å·)          â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ SELL / å–å‡º (æ˜¾ç¤ºåœ¨é¡¶éƒ¨)                                                    â”‚
// â”‚   ğŸŒŸ MTF Resonance + Extreme Overbought å¤šå‘¨æœŸå…±æŒ¯+æç«¯è¶…ä¹° (æœ€å¼ºå–å‡ºä¿¡å·)   â”‚
// â”‚   ğŸ’ Divergence + Extreme Overbought    èƒŒç¦»+æç«¯è¶…ä¹° (å¼ºå–å‡ºä¿¡å·)           â”‚
// â”‚   â„ï¸ Extreme Overbought (Z>+2Ïƒâ‰ˆP98)     æç«¯è¶…ä¹° (å–å‡ºä¿¡å·)                  â”‚
// â”‚   â¬‡ï¸ Normal Overbought (Z>+1.5Ïƒâ‰ˆP93)    æ™®é€šè¶…ä¹° (å¼±å–å‡ºï¼Œé»˜è®¤éšè—)          â”‚
// â”‚   â†˜ï¸ Bearish Divergence Only            çœ‹è·ŒèƒŒç¦» (æ½œåœ¨é¡¶éƒ¨ï¼Œéä¿¡å·)          â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ DASHBOARD STATUS / ä»ªè¡¨ç›˜çŠ¶æ€                                               â”‚
// â”‚   ğŸŸ¢ Bullish/Oversold  çœ‹æ¶¨/è¶…å–çŠ¶æ€                                        â”‚
// â”‚   ğŸ”´ Bearish/Overbought çœ‹è·Œ/è¶…ä¹°çŠ¶æ€                                       â”‚
// â”‚   ğŸŸ¡ Mild Oversold     è½»åº¦è¶…å–                                             â”‚
// â”‚   ğŸŸ  Mild Overbought   è½»åº¦è¶…ä¹°                                             â”‚
// â”‚   âšª Neutral           ä¸­æ€§çŠ¶æ€                                             â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ MOBILE DASHBOARD æŒç»­çŠ¶æ€ / Persistent Zone Status (æ— æ–°ä¿¡å·æ—¶æ˜¾ç¤º)         â”‚
// â”‚   ğŸ”¥æŒç»­  Extreme Oversold Zone   æŒç»­å¤„äºæç«¯è¶…å–åŒº                        â”‚
// â”‚   â„ï¸æŒç»­  Extreme Overbought Zone æŒç»­å¤„äºæç«¯è¶…ä¹°åŒº                        â”‚
// â”‚   â¬†ï¸åŒº   Oversold Zone           æŒç»­å¤„äºè¶…å–åŒº                             â”‚
// â”‚   â¬‡ï¸åŒº   Overbought Zone         æŒç»­å¤„äºè¶…ä¹°åŒº                             â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ SMART ALERT / æ™ºèƒ½è­¦æŠ¥ (V6 Unified)                                         â”‚
// â”‚   ğŸ¯ Smart Alert  ç»Ÿä¸€è­¦æŠ¥å…¥å£ (è‡ªåŠ¨èšåˆæ‰€æœ‰ä¿¡å·+ä¸Šä¸‹æ–‡)                     â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

//@version=6
indicator("Adaptive RSI Pro", shorttitle="ARSI Pro", overlay=false, precision=2, max_lines_count=100, max_labels_count=100, max_bars_back=4500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grp_rsi = "â•â•â• RSI Settings / RSIè®¾ç½® â•â•â•"
rsi_length = input.int(14, "RSI Length / RSIå‘¨æœŸ", minval=2, group=grp_rsi)
rsi_source = input.source(close, "RSI Source / æ•°æ®æº", group=grp_rsi)

grp_adaptive = "â•â•â• Adaptive Settings / è‡ªé€‚åº”è®¾ç½® â•â•â•"
lookback_mode = input.string("Auto", "Lookback Mode / å›çœ‹æ¨¡å¼", options=["Auto", "Custom"], group=grp_adaptive, tooltip="Auto: æ ¹æ®æ—¶é—´æ¡†æ¶å’ŒRSIæ³¢åŠ¨ç‡è‡ªåŠ¨è®¡ç®—\nCustom: ä½¿ç”¨è‡ªå®šä¹‰å€¼")
lookback_custom = input.int(252, "Custom Lookback / è‡ªå®šä¹‰å›çœ‹", minval=50, maxval=2000, group=grp_adaptive, tooltip="ä»…åœ¨ Custom æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚å»ºè®®ï¼šæ—¥çº¿252ï¼Œ4å°æ—¶500ï¼Œ1å°æ—¶750")
lookback_precision = input.string("Normal", "Precision / ç²¾åº¦", options=["High", "Normal", "Low"], group=grp_adaptive, tooltip="High(é«˜ç²¾åº¦): éœ€è¦æ›´å¤šæ•°æ®ï¼Œæ›´å‡†ç¡®\nNormal(å¹³è¡¡): æ¨èè®¾ç½®\nLow(å¿«é€‚åº”): æ›´å°‘æ•°æ®ï¼Œæ›´å¿«å“åº”")
vol_history_mode = input.string("1 Year", "History Depth / å†å²æ·±åº¦", options=["6 Months", "1 Year", "2 Years"], group=grp_adaptive, tooltip="æ³¢åŠ¨ç‡å‚è€ƒçš„å†å²æ—¶é—´é•¿åº¦\nè‡ªåŠ¨æ ¹æ®æ—¶é—´æ¡†æ¶è½¬æ¢ä¸ºKçº¿æ•°é‡")

grp_visual = "â•â•â• Visual Settings / è§†è§‰è®¾ç½® â•â•â•"
visual_line_mode = input.string("Unified", "Threshold Line Mode / é˜ˆå€¼çº¿æ¨¡å¼", options=["Unified", "Z-Score", "Percentile", "Both"], group=grp_visual, tooltip="Unified(æ¨è): Z-Scoreçº¿+ç™¾åˆ†ä½æ ‡æ³¨ï¼Œå…¼é¡¾ä¸¥è°¨æ€§å’Œç›´è§‚æ€§\nZ-Score: ä»…ç»Ÿè®¡å­¦é˜ˆå€¼çº¿(Â±2Ïƒ, Â±1.5Ïƒ)\nPercentile: ä»…ç™¾åˆ†ä½çº¿(P5-P95)\nBoth: åŒæ—¶æ˜¾ç¤ºä¸¤ç§")
show_fill = input.bool(true, "Show Gradient Fill / æ˜¾ç¤ºæ¸å˜å¡«å……", group=grp_visual)
show_dashboard = input.bool(true, "Show Dashboard / æ˜¾ç¤ºä»ªè¡¨ç›˜", group=grp_visual)
dashboard_mode = input.string("Full", "Dashboard Mode / é¢æ¿æ¨¡å¼", options=["Mobile", "Lite", "Full"], group=grp_visual, tooltip="Mobile: æç®€æ¨¡å¼(3è¡Œ)ï¼Œä»…RSI+ä¿¡å·+çŠ¶æ€ï¼Œé€‚åˆæ‰‹æœº\\nLite: æ ¸å¿ƒä¿¡æ¯(5è¡Œ) | Full: å®Œæ•´ä¿¡æ¯")
dashboard_size = input.string("Normal", "Dashboard Size / é¢æ¿å¤§å°", options=["Tiny", "Small", "Normal", "Large"], group=grp_visual)
dashboard_transparency = input.int(30, "Dashboard Transparency / é¢æ¿é€æ˜åº¦", minval=0, maxval=100, step=10, group=grp_visual)
color_bull = input.color(color.new(#00E676, 60), "Bullish Color / ç‰›å¸‚é¢œè‰²", group=grp_visual)
color_bear = input.color(color.new(#FF5252, 60), "Bearish Color / ç†Šå¸‚é¢œè‰²", group=grp_visual)
color_rsi = input.color(#FFEB3B, "RSI Line Color / RSIçº¿é¢œè‰²", group=grp_visual)

grp_alerts = "â•â•â• Alert Settings / è­¦æŠ¥è®¾ç½® â•â•â•"
show_normal_signals = input.bool(false, "Show Normal Signals / æ˜¾ç¤ºæ™®é€šä¿¡å·", group=grp_alerts, tooltip="â¬†ï¸â¬‡ï¸ æ™®é€šè¶…ä¹°/è¶…å–ä¿¡å·ï¼Œé»˜è®¤å…³é—­")
normal_threshold = input.float(1.5, "Normal Signal Threshold / æ™®é€šä¿¡å·é˜ˆå€¼", minval=1.0, maxval=2.0, step=0.1, group=grp_alerts, tooltip="Z-Score é˜ˆå€¼\n1.5Ïƒ â‰ˆ P6.7/P93.3\n1.28Ïƒ â‰ˆ P10/P90")
enable_signal_cooldown = input.bool(true, "Enable Signal Cooldown / å¯ç”¨ä¿¡å·å†·å´", group=grp_alerts, tooltip="é˜²æ­¢åŒä¸€åŒºåŸŸé‡å¤ä¿¡å·æ±¡æŸ“ç»Ÿè®¡æ•°æ®")
cooldown_mode = input.string("Smart", "Cooldown Mode / å†·å´æ¨¡å¼", options=["Smart", "Fixed"], group=grp_alerts, tooltip="Smart: æ ¹æ®å¸‚åœºæ³¢åŠ¨ç‡è‡ªåŠ¨è°ƒæ•´å†·å´æœŸ\nFixed: ä½¿ç”¨å›ºå®šå†·å´æœŸ")
cooldown_bars_fixed = input.int(5, "Fixed Cooldown (Bars) / å›ºå®šå†·å´æœŸ", minval=1, maxval=20, group=grp_alerts, tooltip="Fixedæ¨¡å¼ä¸‹çš„å†·å´æ—¶é—´ï¼ˆKçº¿æ•°ï¼‰")
enable_smart_alert = input.bool(true, "ğŸ¯ Smart Alert / æ™ºèƒ½è­¦æŠ¥", group=grp_alerts, tooltip="V6åŠ¨æ€è­¦æŠ¥ï¼šè‡ªåŠ¨èšåˆæ‰€æœ‰ä¿¡å·åˆ°ä¸€æ¡æ¶ˆæ¯\nåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡ï¼ˆRSIå€¼ã€Z-Scoreã€ç™¾åˆ†ä½ï¼‰\nå®æ—¶è§¦å‘ï¼Œæ™ºèƒ½å»é‡")

grp_protection = "â•â•â• Trend Protection / è¶‹åŠ¿ä¿æŠ¤ â•â•â•"
enable_trend_protection = input.bool(true, "Enable Trend Protection / å¯ç”¨è¶‹åŠ¿ä¿æŠ¤", group=grp_protection, tooltip="ä½¿ç”¨å‘¨çº¿è¶‹åŠ¿è¿‡æ»¤æç«¯é£é™©ï¼šé¿å…åœ¨å‘¨çº¿æç«¯ä¸‹è·Œä¸­æŠ„åº•")
protection_level = input.string("Moderate", "Protection Level / ä¿æŠ¤çº§åˆ«", options=["Aggressive", "Moderate", "Loose"], group=grp_protection, tooltip="Aggressive: å‘¨çº¿å¿…é¡»ä¸Šå‡è¶‹åŠ¿\nModerate(æ¨è): æ’é™¤å‘¨çº¿æç«¯ä¸‹è·Œ\nLoose: ä»…æ’é™¤å‘¨çº¿RSI<20çš„æç«¯æƒ…å†µ")

grp_volume = "â•â•â• Volume Confirmation / æˆäº¤é‡ç¡®è®¤ â•â•â•"
enable_volume_scoring = input.bool(true, "Enable Volume Scoring / å¯ç”¨æˆäº¤é‡è¯„åˆ†", group=grp_volume, tooltip="æˆäº¤é‡ä½œä¸ºä¿¡å·è´¨é‡è¯„åˆ†é¡¹ï¼Œä¸å¼ºåˆ¶è¿‡æ»¤")
volume_surge_mult = input.float(1.5, "Volume Surge Multiplier / æ”¾é‡å€æ•°", minval=1.0, maxval=3.0, step=0.1, group=grp_volume, tooltip="é«˜äºå‡é‡Xå€è§†ä¸ºæ”¾é‡")

grp_mtf = "â•â•â• Multi-Timeframe / å¤šæ—¶é—´æ¡†æ¶ â•â•â•"
enable_mtf = input.bool(true, "Enable MTF RSI / å¯ç”¨å¤šæ—¶é—´æ¡†æ¶", group=grp_mtf)
mtf_mode = input.string("Auto", "MTF Mode / æ¨¡å¼", options=["Auto", "Manual"], group=grp_mtf, tooltip="Auto: æ ¹æ®åˆ†å½¢é€»è¾‘è‡ªåŠ¨é€‰æ‹©æ›´å°å‘¨æœŸ (å‘ä¸‹åˆ†å½¢)\nManual: ä½¿ç”¨ä¸‹æ–¹æ‰‹åŠ¨è®¾ç½®")
mtf_tf1_input = input.timeframe("60", "Manual TF1 / æ‰‹åŠ¨å‘¨æœŸ1", group=grp_mtf)
mtf_tf2_input = input.timeframe("240", "Manual TF2 / æ‰‹åŠ¨å‘¨æœŸ2", group=grp_mtf)
mtf_tf3_input = input.timeframe("D", "Manual TF3 / æ‰‹åŠ¨å‘¨æœŸ3", group=grp_mtf)

grp_stats = "â•â•â• Signal Statistics / ä¿¡å·ç»Ÿè®¡ â•â•â•"
enable_stats = input.bool(true, "Enable Statistics / å¯ç”¨ç»Ÿè®¡", group=grp_stats)
stats_forward_bars = input.int(20, "Forward Bars / å‰ç»Kçº¿æ•°", minval=5, maxval=100, group=grp_stats, tooltip="ä¿¡å·è§¦å‘åå¤šå°‘æ ¹Kçº¿è®¡ç®—æ”¶ç›Š")

grp_divergence = "â•â•â• Divergence Settings / èƒŒç¦»è®¾ç½® â•â•â•"
enable_divergence = input.bool(true, "Enable Divergence Detection / å¯ç”¨èƒŒç¦»æ£€æµ‹", group=grp_divergence)
div_mode = input.string("Auto", "Divergence Mode / èƒŒç¦»æ¨¡å¼", options=["Auto", "Low Vol", "Normal", "High Vol", "Crypto", "Custom"], group=grp_divergence, tooltip="Auto: æ ¹æ®ATRè‡ªåŠ¨åˆ¤æ–­\nLow Vol: è“ç­¹/ETF\nNormal: ä¸€èˆ¬è‚¡ç¥¨\nHigh Vol: æˆé•¿/å°ç›˜\nCrypto: åŠ å¯†è´§å¸")
div_lookback_custom = input.int(5, "Custom Lookback / è‡ªå®šä¹‰å›çœ‹", minval=2, maxval=20, group=grp_divergence, tooltip="ä»…åœ¨ Custom æ¨¡å¼ä¸‹ä½¿ç”¨")
div_range_custom = input.int(60, "Custom Range / è‡ªå®šä¹‰èŒƒå›´", minval=20, maxval=200, group=grp_divergence, tooltip="ä»…åœ¨ Custom æ¨¡å¼ä¸‹ä½¿ç”¨")

// æ³¢åŠ¨æ€§æ£€æµ‹ (ç”¨äº Auto æ¨¡å¼)
// ä½¿ç”¨é•¿æœŸå¹³å‡æ³¢åŠ¨ç‡ç¡®ä¿æ¨¡å¼ç¨³å®š (simple int)
atr_20 = ta.atr(20)
avg_volatility = ta.sma(atr_20 / close * 100, 252)  // 252å‘¨æœŸå¹³å‡ç›¸å¯¹æ³¢åŠ¨ç‡

// æ ¹æ®é•¿æœŸå¹³å‡æ³¢åŠ¨ç‡åˆ¤æ–­æ ‡çš„ç±»å‹ (Auto æ¨¡å¼)
// ä½äº1%: ä½æ³¢åŠ¨ (è“ç­¹/ETF), 1-3%: æ­£å¸¸, 3-6%: é«˜æ³¢åŠ¨, è¶…è¿‡6%: åŠ å¯†è´§å¸çº§åˆ«
auto_vol_type = avg_volatility > 6 ? "Crypto" : avg_volatility > 3 ? "High Vol" : avg_volatility > 1 ? "Normal" : "Low Vol"

// â•â•â• æ™ºèƒ½å†·å´æœŸ - åŸºç¡€å€¼ï¼ˆæ ¹æ®æ ‡çš„ç±»å‹ï¼‰â•â•â•
// é«˜æ³¢åŠ¨å¸‚åœºå˜åŒ–å¿«ï¼Œå†·å´æœŸçŸ­ï¼›ä½æ³¢åŠ¨å¸‚åœºå˜åŒ–æ…¢ï¼Œå†·å´æœŸé•¿
base_cooldown = avg_volatility > 6 ? 2 : avg_volatility > 3 ? 3 : avg_volatility > 1 ? 5 : 8

// çŸ­æœŸä»·æ ¼æ³¢åŠ¨ç‡ï¼ˆç”¨äºåŠ¨æ€è°ƒæ•´ï¼‰
vol_short_term = ta.sma(atr_20 / close * 100, 20)

// å®é™…ä½¿ç”¨çš„æ¨¡å¼
active_div_mode = div_mode == "Auto" ? auto_vol_type : div_mode

// æ ¹æ®æ¨¡å¼è®¾ç½®å‚æ•° (é¢„è®¾å€¼)
// Low Vol: 3/40, Normal: 5/60, High Vol: 7/80, Crypto: 10/120
div_lookback = div_mode == "Custom" ? div_lookback_custom : active_div_mode == "Low Vol" ? 3 : active_div_mode == "Normal" ? 5 : active_div_mode == "High Vol" ? 7 : 10
div_range = div_mode == "Custom" ? div_range_custom : active_div_mode == "Low Vol" ? 40 : active_div_mode == "Normal" ? 60 : active_div_mode == "High Vol" ? 80 : 120

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ RSI CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rsi = ta.rsi(rsi_source, rsi_length)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ DYNAMIC LOOKBACK CALCULATION / åŠ¨æ€å›çœ‹å‘¨æœŸè®¡ç®—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Step 1: Timeframe-normalized volatility periods
// æ ¹æ®æ—¶é—´æ¡†æ¶æ ‡å‡†åŒ–é•¿æœŸå‘¨æœŸï¼Œç¡®ä¿è¦†ç›–ç›¸åŒçš„æ—¶é—´è·¨åº¦
vol_short_period = rsi_length * 4  // çŸ­æœŸï¼š~56æ ¹Kçº¿ï¼ˆçº¦4ä¸ªRSIå‘¨æœŸï¼‰

// å°†å†å²æ·±åº¦é€‰é¡¹è½¬æ¢ä¸ºå¤©æ•°
vol_history_days = vol_history_mode == "6 Months" ? 126 : vol_history_mode == "1 Year" ? 252 : 504

// é•¿æœŸå‘¨æœŸæ ¹æ®æ—¶é—´æ¡†æ¶è°ƒæ•´ï¼ˆç›®æ ‡ï¼šè¦†ç›–ç›¸åŒå¤©æ•°ï¼‰
// åŠ¨æ€è®¡ç®—æ¯å¤©çš„Kçº¿æ•°é‡ï¼ˆä½¿ç”¨ timeframe.in_seconds è·å–ç²¾ç¡®åˆ†é’Ÿæ•°ï¼‰
tf_minutes = timeframe.in_seconds(timeframe.period) / 60
bars_per_day = timeframe.isdaily or timeframe.isweekly or timeframe.ismonthly ? 1 :
               math.ceil(1440 / tf_minutes)  // 1440åˆ†é’Ÿ = 1å¤©
vol_long_period = math.min(4500, vol_history_days * bars_per_day)  // ä¸Šé™4500ï¼ˆä¸max_bars_backåŒ¹é…ï¼‰

vol_short = nz(ta.stdev(rsi, vol_short_period), 10)  // è¿‘æœŸæ³¢åŠ¨
vol_long = nz(ta.stdev(rsi, vol_long_period), 10)    // é•¿æœŸæ³¢åŠ¨

// Step 2: Dynamic weighted combination
// åŠ¨æ€åŠ æƒç»„åˆï¼šä¸æ˜¯ç®€å•å–æœ€å¤§å€¼
// - åŸºç¡€ï¼š70%é•¿æœŸ + 30%è¿‘æœŸï¼ˆåå‘ç¨³å®šï¼‰
// - åŠ¨æ€è°ƒæ•´ï¼šå¦‚æœè¿‘æœŸ > é•¿æœŸï¼Œå¢åŠ è¿‘æœŸæƒé‡
vol_base = vol_long * 0.7 + vol_short * 0.3

// è¿‘æœŸæ³¢åŠ¨æ˜¾è‘—é«˜äºé•¿æœŸæ—¶ï¼ˆ>1.2å€ï¼‰ï¼ŒåŠ¨æ€åˆ‡æ¢åˆ°è¿‘æœŸä¸»å¯¼
recent_high = vol_short > vol_long * 1.2
vol_dynamic = recent_high ? (vol_short * 0.6 + vol_long * 0.4) : vol_base

// â•â•â• æ™ºèƒ½å†·å´æœŸ - åŠ¨æ€è°ƒæ•´ï¼ˆåŸºäºå¸‚åœºæ´»è·ƒåº¦ï¼‰â•â•â•
// ç»¼åˆä»·æ ¼æ³¢åŠ¨ç‡å’ŒRSIæ³¢åŠ¨ç‡åˆ¤æ–­å¸‚åœºæ´»è·ƒåº¦
price_vol_active = vol_short_term > avg_volatility * 1.2  // çŸ­æœŸä»·æ ¼æ³¢åŠ¨ > é•¿æœŸå‡å€¼1.2å€
rsi_vol_active = vol_short > vol_long * 1.2               // è¿‘æœŸRSIæ³¢åŠ¨ > é•¿æœŸ1.2å€ï¼ˆå¤ç”¨ recent_highï¼‰

// å¸‚åœºæ´»è·ƒ = ä»·æ ¼æˆ–RSIä»»ä¸€æ´»è·ƒ
market_active = price_vol_active or rsi_vol_active

// åŠ¨æ€å†·å´æœŸï¼šæ´»è·ƒæ—¶ç¼©çŸ­1æ ¹Kçº¿ï¼Œä½†ä¸ä½äº1
smart_cooldown_bars = market_active ? math.max(base_cooldown - 1, 1) : base_cooldown

// å®é™…ä½¿ç”¨çš„å†·å´æœŸ
cooldown_bars = cooldown_mode == "Smart" ? smart_cooldown_bars : cooldown_bars_fixed

// ç¡®ä¿ä¸ä½äºé•¿æœŸæ³¢åŠ¨ï¼ˆä¿å®ˆï¼‰
rsi_vol_bootstrap = math.max(vol_dynamic, vol_long * 0.8)

// Step 2: Statistical sample size formula: n = (Z Ã— Ïƒ / E)Â²
// ç»Ÿè®¡å­¦æ ·æœ¬é‡å…¬å¼ï¼šZ=1.96 (95%ç½®ä¿¡åº¦), E=5 (å¯æ¥å—è¯¯å·®)
// This is the THEORETICAL optimal lookback (for display/health check only)
stat_lookback = math.max(50, math.pow(1.96 * rsi_vol_bootstrap / 5, 2))

// Step 3: Use exact statistical formula n = (Z Ã— Ïƒ / E)Â²
// Z = 1.96 (95% confidence), Ïƒ = RSI stdev, E = acceptable error
// ä½¿ç”¨ç²¾ç¡®ç»Ÿè®¡å…¬å¼è®¡ç®—æ‰€éœ€æ ·æœ¬é‡
// E æ ¹æ®ç²¾åº¦è®¾ç½®ï¼šHigh=2.0, Normal=2.5, Low=3.5
stat_error = lookback_precision == "High" ? 2.0 : lookback_precision == "Normal" ? 2.5 : 3.5
stat_required = math.pow(1.96 * rsi_vol_bootstrap / stat_error, 2)

// Step 4: Apply limits (min 100, max 1000)
// è®¾ç½®åˆç†çš„ä¸Šä¸‹é™
auto_lookback = int(math.max(100, math.min(1000, stat_required)))

// Step 5: Apply mode selection
lookback = lookback_mode == "Custom" ? math.min(1000, lookback_custom) : auto_lookback

// Step 6: Health indicators / å¥åº·åº¦æŒ‡æ ‡
health_sample_coverage = bar_index >= lookback * 0.8  // æœ‰è¶³å¤Ÿå†å²æ•°æ®
health_stat_valid = lookback >= stat_required * 0.9   // å®é™…å€¼æ»¡è¶³ç»Ÿè®¡éœ€æ±‚

// Display values for dashboard
theoretical_lookback = int(math.max(100, math.min(2000, math.ceil(stat_lookback))))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ ADAPTIVE PERCENTILE CALCULATION (Nearest Rank - More Accurate)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ä½¿ç”¨ percentile_nearest_rank è·å¾—æ›´ç²¾å‡†çš„åˆ†å¸ƒ (ä¿ç•™ç”¨äºè§†è§‰å‚è€ƒ)
rsi_p5  = ta.percentile_nearest_rank(rsi, lookback, 5)
rsi_p10 = ta.percentile_nearest_rank(rsi, lookback, 10)
rsi_p25 = ta.percentile_nearest_rank(rsi, lookback, 25)
rsi_p50 = ta.percentile_nearest_rank(rsi, lookback, 50)
rsi_p75 = ta.percentile_nearest_rank(rsi, lookback, 75)
rsi_p90 = ta.percentile_nearest_rank(rsi, lookback, 90)
rsi_p95 = ta.percentile_nearest_rank(rsi, lookback, 95)

// Health indicator: Distribution spread check / åˆ†å¸ƒå®½åº¦æ£€æŸ¥
health_distribution_spread = (rsi_p95 - rsi_p5) >= 15  // P95-P5 è‡³å°‘15ç‚¹

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ RSI Z-SCORE CALCULATION (ç»Ÿè®¡å­¦æ–¹æ³•)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Z-Score = (å½“å‰å€¼ - å¹³å‡å€¼) / æ ‡å‡†å·®
rsi_mean = ta.sma(rsi, lookback)
rsi_stdev = ta.stdev(rsi, lookback)
rsi_zscore = rsi_stdev != 0 ? (rsi - rsi_mean) / rsi_stdev : 0


// Z-Score åŠ¨æ€é˜ˆå€¼çº¿ (ç”¨äºç»˜å›¾)
zscore_upper_2 = rsi_mean + rsi_stdev * 2    // +2Ïƒ æç«¯è¶…ä¹°
zscore_upper_1_5 = rsi_mean + rsi_stdev * 1.5  // +1.5Ïƒ è¶…ä¹°
zscore_lower_1_5 = rsi_mean - rsi_stdev * 1.5  // -1.5Ïƒ è¶…å–
zscore_lower_2 = rsi_mean - rsi_stdev * 2    // -2Ïƒ æç«¯è¶…å–

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ Z-SCORE â†” PERCENTILE è½¬æ¢å·¥å…· / CONVERSION UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Z-Score â†’ è¿‘ä¼¼ç™¾åˆ†ä½ï¼ˆä½¿ç”¨æŸ¥æ‰¾è¡¨æ–¹æ³•ï¼‰
// Pine Script ä¸æ”¯æŒ math.erfï¼Œä½¿ç”¨æŸ¥æ‰¾è¡¨è¿‘ä¼¼
f_zscore_to_percentile(_zscore) =>
    // æŸ¥æ‰¾è¡¨ï¼šå¸¸è§ Z-Score å¯¹åº”çš„ç™¾åˆ†ä½
    _z = math.abs(_zscore)
    _pct = _z >= 3.0 ? 99.9 :
           _z >= 2.5 ? 99.4 :
           _z >= 2.0 ? 97.7 :
           _z >= 1.96 ? 97.5 :
           _z >= 1.5 ? 93.3 :
           _z >= 1.28 ? 90.0 :
           _z >= 1.0 ? 84.1 :
           _z >= 0.67 ? 75.0 :
           _z >= 0.5 ? 69.1 :
           _z >= 0.25 ? 59.9 : 50.0
    // æ ¹æ®æ­£è´Ÿè¿”å›å¯¹åº”ç™¾åˆ†ä½
    _zscore >= 0 ? _pct : 100 - _pct

// ç™¾åˆ†ä½èŒƒå›´ â†’ Z-ScoreåŒºé—´æ–‡æœ¬ï¼ˆç”¨äºDashboardæ˜¾ç¤ºï¼‰
f_percentile_zscore_range(_pct) =>
    _pct < 2.3 ? " (< âˆ’2Ïƒ)" : _pct <= 6.7 ? " (âˆ’1.5Ïƒ ~ âˆ’2Ïƒ)" : _pct <= 15.9 ? " (âˆ’1Ïƒ ~ âˆ’1.5Ïƒ)" : _pct >= 97.7 ? " (> +2Ïƒ)" : _pct >= 93.3 ? " (+1.5Ïƒ ~ +2Ïƒ)" : _pct >= 84.1 ? " (+1Ïƒ ~ +1.5Ïƒ)" : ""

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ TREND PROTECTION / å¤§å‘¨æœŸè¶‹åŠ¿ä¿æŠ¤ (Weekly-based)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å‘¨çº¿æ•°æ®è¯·æ±‚ (ç”¨äºè¶‹åŠ¿ä¿æŠ¤)
[weekly_rsi, weekly_close, weekly_sma20, weekly_sma50] = request.security(syminfo.tickerid, "W",
    [ta.rsi(close, 14), close, ta.sma(close, 20), ta.sma(close, 50)], lookahead=barmerge.lookahead_off)

// å‘¨çº¿è¶‹åŠ¿çŠ¶æ€åˆ¤æ–­
weekly_uptrend = weekly_sma20 > weekly_sma50           // å‘¨çº¿ä¸Šå‡è¶‹åŠ¿
weekly_extreme_bearish = weekly_rsi < 30 and weekly_sma20 < weekly_sma50  // å‘¨çº¿æç«¯ä¸‹è·Œ
weekly_ultra_bearish = weekly_rsi < 20                 // å‘¨çº¿è¶…çº§ç†Šå¸‚

// æ ¹æ®ä¿æŠ¤çº§åˆ«å†³å®šæ˜¯å¦å…è®¸ä¹°å…¥
trend_allows_buy = protection_level == "Aggressive" ? weekly_uptrend : protection_level == "Moderate" ? not weekly_extreme_bearish : not weekly_ultra_bearish

// æ ¹æ®ä¿æŠ¤çº§åˆ«å†³å®šæ˜¯å¦å…è®¸å–å‡º (å¯¹ç§°é€»è¾‘)
weekly_downtrend = weekly_sma20 < weekly_sma50
weekly_extreme_bullish = weekly_rsi > 70 and weekly_sma20 > weekly_sma50
weekly_ultra_bullish = weekly_rsi > 80

trend_allows_sell = protection_level == "Aggressive" ? weekly_downtrend : protection_level == "Moderate" ? not weekly_extreme_bullish : not weekly_ultra_bullish

// ä¿æŠ¤çŠ¶æ€æ˜¾ç¤ºæ–‡æœ¬
protection_status = not enable_trend_protection ? "OFF" : trend_allows_buy and trend_allows_sell ? "âœ“" : trend_allows_buy ? "BUYâœ“" : trend_allows_sell ? "SELLâœ“" : "âš ï¸"

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ VOLUME CONFIRMATION / æˆäº¤é‡ç¡®è®¤
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

vol_sma20 = ta.sma(volume, 20)
volume_ratio = vol_sma20 > 0 ? volume / vol_sma20 : 1.0

// æˆäº¤é‡çŠ¶æ€
volume_surge = volume_ratio >= volume_surge_mult       // æ”¾é‡
volume_normal = volume_ratio >= 0.8 and volume_ratio < volume_surge_mult  // æ­£å¸¸é‡
volume_low = volume_ratio < 0.8                        // ç¼©é‡

// æˆäº¤é‡è¯„åˆ† (ç”¨äºä¿¡å·è´¨é‡)
volume_score = volume_surge ? 20 : volume_normal ? 10 : 0

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ MULTI-TIMEFRAME RSI / å¤šæ—¶é—´æ¡†æ¶RSI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// åŠ¨æ€æ—¶é—´æ¡†æ¶é€‰æ‹©å‡½æ•° (Classic Pine v6 Auto-TF Logic)
f_get_auto_timeframes() =>
    // è·å–å½“å‰æ—¶é—´æ¡†æ¶çš„åˆ†é’Ÿæ•° (Daily=1440)
    // æ³¨æ„: timeframe.isseconds éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œè¿™é‡Œç®€åŒ–ä¸º < 5m ç»Ÿä¸€å¤„ç†
    // é€»è¾‘æ ¹æ® Implementation Plan çš„ Fractal Breakdown è®¾è®¡
    
    // Default fallback
    string t1 = "60"
    string t2 = "240"
    string t3 = "D"
    
    if timeframe.isdaily
        // Daily: Check 1h, 4h, Daily
        t1 := "60"
        t2 := "240"
        t3 := "D"
    else if timeframe.in_seconds(timeframe.period) >= 14400 // >= 4h
        // 4h: Check 15m, 1h, 4h
        t1 := "15"
        t2 := "60"
        t3 := "240"
    else if timeframe.in_seconds(timeframe.period) >= 3600 // >= 1h
        // 1h: Check 5m, 15m, 1h
        t1 := "5"
        t2 := "15"
        t3 := "60"
    else if timeframe.in_seconds(timeframe.period) >= 900 // >= 15m
        // 15m: Check 1m, 5m, 15m
        t1 := "1"
        t2 := "5"
        t3 := "15"
    else
        // < 15m: Check 1m, 3m, 5m
        t1 := "1"
        t2 := "3"
        t3 := "5"
    
    [t1, t2, t3]

// è·å–æ—¶é—´æ¡†æ¶ (Manual or Auto)
[auto_t1, auto_t2, auto_t3] = f_get_auto_timeframes()
active_tf1 = mtf_mode == "Auto" ? auto_t1 : mtf_tf1_input
active_tf2 = mtf_mode == "Auto" ? auto_t2 : mtf_tf2_input
active_tf3 = mtf_mode == "Auto" ? auto_t3 : mtf_tf3_input

// MTF RSI è®¡ç®—
// MTF RSI è®¡ç®—
// V6 Best Practice: Tuple Request (Single security call for multiple values)
f_rsi_data_mtf(_tf) =>
    request.security(syminfo.tickerid, _tf, [rsi, rsi_p10, rsi_p90], lookahead=barmerge.lookahead_off)

// Helper to returns NAs tuple (to satisfy ternary operator syntax)
f_na_tuple() => [float(na), float(na), float(na)]

// Fetch all data in tuple form
[rsi_tf1, p10_tf1_raw, p90_tf1_raw] = if enable_mtf 
    f_rsi_data_mtf(active_tf1) 
else 
    f_na_tuple()

[rsi_tf2, p10_tf2_raw, p90_tf2_raw] = if enable_mtf 
    f_rsi_data_mtf(active_tf2) 
else 
    f_na_tuple()

[rsi_tf3, p10_tf3_raw, p90_tf3_raw] = if enable_mtf 
    f_rsi_data_mtf(active_tf3) 
else 
    f_na_tuple()

p10_tf1 = p10_tf1_raw
p90_tf1 = p90_tf1_raw
p10_tf2 = p10_tf2_raw
p90_tf2 = p90_tf2_raw
p10_tf3 = p10_tf3_raw
p90_tf3 = p90_tf3_raw

// è®¡ç®—å„æ—¶é—´æ¡†æ¶çŠ¶æ€
f_status(_rsi, _p10, _p90) =>
    _rsi < _p10 ? 1 : _rsi > _p90 ? -1 : 0  // 1=oversold, -1=overbought, 0=neutral

// æ—¶é—´æ¡†æ¶æ ¼å¼åŒ–å‡½æ•° (ç»Ÿä¸€æ˜¾ç¤ºä¸º 1h/4h/D ç­‰æ ¼å¼)
f_tf_display(_tf) =>
    // V6 clean formatting: Handle minutes, hours, days
    // Note: This manual mapping is still often clearer than automated logic for specific labels like "4h"
    if str.contains(_tf, "D") or str.contains(_tf, "W") or str.contains(_tf, "M")
        _tf
    else
        // Try to parse as int
        int_tf = str.tonumber(_tf)
        if not na(int_tf)
            if int_tf < 60
                str.format("{0}m", int_tf)
            else if int_tf % 60 == 0
                str.format("{0}h", int_tf / 60)
            else
                // Mixed hours/minutes, keep as minutes or format? Usually scripts stick to "Xm"
                str.format("{0}m", int_tf)
        else
            _tf

// æ ¼å¼åŒ–åçš„æ—¶é—´æ¡†æ¶æ˜¾ç¤º
mtf_tf1_display = f_tf_display(active_tf1)
mtf_tf2_display = f_tf_display(active_tf2)
mtf_tf3_display = f_tf_display(active_tf3)
current_tf_display = f_tf_display(timeframe.period)

status_tf1 = f_status(rsi_tf1, p10_tf1, p90_tf1)
status_tf2 = f_status(rsi_tf2, p10_tf2, p90_tf2)
status_tf3 = f_status(rsi_tf3, p10_tf3, p90_tf3)
status_current = f_status(rsi, rsi_p10, rsi_p90)

// å…±æŒ¯æ£€æµ‹ (è·³è¿‡ä¸å½“å‰å›¾è¡¨é‡å¤çš„æ—¶é—´æ¡†æ¶)
// æ¯”è¾ƒæ ¼å¼åŒ–åçš„æ—¶é—´æ¡†æ¶ï¼Œé¿å… "60" vs "1h" çš„é—®é¢˜
tf1_is_current = mtf_tf1_display == current_tf_display
tf2_is_current = mtf_tf2_display == current_tf_display
tf3_is_current = mtf_tf3_display == current_tf_display

// è®¡ç®—æœ‰æ•ˆçš„æ—¶é—´æ¡†æ¶æ•°é‡ (ä¸åŒ…æ‹¬å½“å‰å›¾è¡¨é‡å¤çš„)
valid_tf_count = 1 + (tf1_is_current ? 0 : 1) + (tf2_is_current ? 0 : 1) + (tf3_is_current ? 0 : 1)

// è¶…å–/è¶…ä¹°è®¡æ•° (è·³è¿‡é‡å¤çš„æ—¶é—´æ¡†æ¶)
oversold_count = (status_current == 1 ? 1 : 0) + 
                 (not tf1_is_current and status_tf1 == 1 ? 1 : 0) + 
                 (not tf2_is_current and status_tf2 == 1 ? 1 : 0) + 
                 (not tf3_is_current and status_tf3 == 1 ? 1 : 0)
overbought_count = (status_current == -1 ? 1 : 0) + 
                   (not tf1_is_current and status_tf1 == -1 ? 1 : 0) + 
                   (not tf2_is_current and status_tf2 == -1 ? 1 : 0) + 
                   (not tf3_is_current and status_tf3 == -1 ? 1 : 0)

// å…±æŒ¯æ¡ä»¶: è‡³å°‘ 3/4 æˆ–è€…æ‰€æœ‰æœ‰æ•ˆæ—¶é—´æ¡†æ¶éƒ½å¤„äºåŒä¸€çŠ¶æ€
oversold_resonance = oversold_count >= 3 or (valid_tf_count <= 3 and oversold_count == valid_tf_count)
overbought_resonance = overbought_count >= 3 or (valid_tf_count <= 3 and overbought_count == valid_tf_count)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL STATISTICS / ä¿¡å·ç»Ÿè®¡ (åˆ†å±‚ç»Ÿè®¡)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸŒŸ MTF å…±æŒ¯ä¿¡å·ç»Ÿè®¡ (æœ€å¼º)
// UDT Definition for Signal Statistics
type SignalStats
    int count = 0
    float total_return = 0.0
    int wins = 0

// Method to update stats
method update(SignalStats this, bool triggered, float ret) =>
    if triggered
        this.count += 1
        this.total_return += ret
        if ret > 0
            this.wins += 1

// Method to get average return
method get_avg(SignalStats this) =>
    this.count > 0 ? this.total_return / this.count : 0.0

// Method to get win rate
method get_winrate(SignalStats this) =>
    this.count > 0 ? float(this.wins) / this.count * 100 : 0.0

// Initialize Stats Objects
var mtf_buy_stats = SignalStats.new()
var mtf_sell_stats = SignalStats.new()
var div_buy_stats = SignalStats.new()
var div_sell_stats = SignalStats.new()
var ext_buy_stats = SignalStats.new()
var ext_sell_stats = SignalStats.new()
var norm_buy_stats = SignalStats.new()
var norm_sell_stats = SignalStats.new()

// Legacy variables removed (replaced by UDTs)
// var int mtf_buy_count = 0 ... (removed)


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ DIVERGENCE DETECTION / èƒŒç¦»æ£€æµ‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Pivot æ£€æµ‹
price_pivot_low = ta.pivotlow(low, div_lookback, div_lookback)
price_pivot_high = ta.pivothigh(high, div_lookback, div_lookback)
rsi_pivot_low = ta.pivotlow(rsi, div_lookback, div_lookback)
rsi_pivot_high = ta.pivothigh(rsi, div_lookback, div_lookback)

// å­˜å‚¨ä¸Šä¸€ä¸ª Pivot ç‚¹
var float prev_price_low = na
var float prev_rsi_low = na
var int prev_low_bar = na
var float prev_price_high = na
var float prev_rsi_high = na
var int prev_high_bar = na

// èƒŒç¦»ä¿¡å·
var bool bullish_divergence = false
var bool bearish_divergence = false

if enable_divergence
    // æ£€æµ‹æ–°çš„ä½ç‚¹
    if not na(price_pivot_low) and not na(rsi_pivot_low)
        current_bar = bar_index - div_lookback
        if not na(prev_price_low) and not na(prev_rsi_low)
            bars_since = current_bar - prev_low_bar
            // çœ‹æ¶¨èƒŒç¦»: ä»·æ ¼åˆ›æ–°ä½ï¼ŒRSIæœªåˆ›æ–°ä½
            if bars_since <= div_range and low[div_lookback] < prev_price_low and rsi[div_lookback] > prev_rsi_low
                bullish_divergence := true
            else
                bullish_divergence := false
        else
            bullish_divergence := false
        prev_price_low := low[div_lookback]
        prev_rsi_low := rsi[div_lookback]
        prev_low_bar := current_bar
    else
        bullish_divergence := false
    
    // æ£€æµ‹æ–°çš„é«˜ç‚¹
    if not na(price_pivot_high) and not na(rsi_pivot_high)
        current_bar = bar_index - div_lookback
        if not na(prev_price_high) and not na(prev_rsi_high)
            bars_since = current_bar - prev_high_bar
            // çœ‹è·ŒèƒŒç¦»: ä»·æ ¼åˆ›æ–°é«˜ï¼ŒRSIæœªåˆ›æ–°é«˜
            if bars_since <= div_range and high[div_lookback] > prev_price_high and rsi[div_lookback] < prev_rsi_high
                bearish_divergence := true
            else
                bearish_divergence := false
        else
            bearish_divergence := false
        prev_price_high := high[div_lookback]
        prev_rsi_high := rsi[div_lookback]
        prev_high_bar := current_bar
    else
        bearish_divergence := false

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ CONFIRMATION & REVERSAL SIGNALS / ç¡®è®¤ä¿¡å·ä¸åè½¬ä¿¡å·
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ç¡®è®¤ä¿¡å·: RSIåœ¨æç«¯åŒºå†…å½¢æˆpivot (åº•éƒ¨/é¡¶éƒ¨å½¢æ€)
// å½“å¤„äºæç«¯è¶…å–ä¸”RSIå¼€å§‹å›å‡æ—¶ï¼Œè¯´æ˜åº•éƒ¨æ­£åœ¨å½¢æˆ
rsi_pivot_low_current = ta.pivotlow(rsi, 3, 1)  // å¿«é€Ÿpivotæ£€æµ‹ (3æ ¹Kçº¿å›çœ‹, 1æ ¹ç¡®è®¤)
rsi_pivot_high_current = ta.pivothigh(rsi, 3, 1)

// æç«¯åŒºå†…çš„pivotç¡®è®¤ (ç”¨äºè¯„åˆ†)
bool confirmation_buy = not na(rsi_pivot_low_current) and rsi_zscore[1] < -2    // RSIåœ¨æç«¯è¶…å–åŒºå½¢æˆä½ç‚¹
bool confirmation_sell = not na(rsi_pivot_high_current) and rsi_zscore[1] > 2  // RSIåœ¨æç«¯è¶…ä¹°åŒºå½¢æˆé«˜ç‚¹

// åè½¬ä¿¡å·: Z-Scoreä»æç«¯åŒºå›å½’ (åŠ¨é‡è½¬å‘)
bool reversal_buy = ta.crossover(rsi_zscore, -2) and rsi_zscore[1] < -2     // Zä»<-2å›å‡åˆ°>-2
bool reversal_sell = ta.crossunder(rsi_zscore, 2) and rsi_zscore[1] > 2     // Zä»>2å›è½åˆ°<2

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ REAL-TIME DIVERGENCE / å®æ—¶èƒŒç¦»æ£€æµ‹ (é¢†å…ˆæŒ‡æ ‡)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å®æ—¶èƒŒç¦»: ä¸ç­‰å¾…pivotç¡®è®¤ï¼Œä½œä¸ºæ—©æœŸé¢„è­¦
// æ£€æµ‹é€»è¾‘: å½“å‰ä»·æ ¼æ¥è¿‘è¿‘æœŸä½ç‚¹/é«˜ç‚¹ï¼Œä½†RSIæ²¡æœ‰

// è®¡ç®—è¿‘æœŸä»·æ ¼å’ŒRSIçš„æå€¼ (ä½¿ç”¨20æ ¹Kçº¿çª—å£)
realtime_lookback = 20
lowest_price_20 = ta.lowest(low, realtime_lookback)
highest_price_20 = ta.highest(high, realtime_lookback)
lowest_rsi_20 = ta.lowest(rsi, realtime_lookback)
highest_rsi_20 = ta.highest(rsi, realtime_lookback)

// å®æ—¶çœ‹æ¶¨èƒŒç¦»: ä»·æ ¼æ¥è¿‘è¿‘æœŸä½ç‚¹(è¯¯å·®1%), RSIæ˜æ˜¾é«˜äºè¿‘æœŸä½ç‚¹
price_near_low = low <= lowest_price_20 * 1.01
rsi_not_at_low = rsi > lowest_rsi_20 + 3  // RSIè‡³å°‘é«˜äºä½ç‚¹3ä¸ªå•ä½
bool realtime_bullish_div = price_near_low and rsi_not_at_low and rsi_zscore < -1.5

// å®æ—¶çœ‹è·ŒèƒŒç¦»: ä»·æ ¼æ¥è¿‘è¿‘æœŸé«˜ç‚¹(è¯¯å·®1%), RSIæ˜æ˜¾ä½äºè¿‘æœŸé«˜ç‚¹
price_near_high = high >= highest_price_20 * 0.99
rsi_not_at_high = rsi < highest_rsi_20 - 3
bool realtime_bearish_div = price_near_high and rsi_not_at_high and rsi_zscore > 1.5

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ VISUAL PLOTTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ ¹æ®ç”¨æˆ·é€‰æ‹©å†³å®šæ˜¾ç¤ºå“ªç§é˜ˆå€¼çº¿
show_unified = visual_line_mode == "Unified"
show_zscore_lines = show_unified or visual_line_mode == "Z-Score" or visual_line_mode == "Both"  // Unifiedä¹Ÿä½¿ç”¨Z-Scoreçº¿
show_percentile_lines = visual_line_mode == "Percentile" or visual_line_mode == "Both"



// Z-Score é˜ˆå€¿çº¿ (ç»Ÿä¸€ä½¿ç”¨åŒ…å«ç™¾åˆ†ä½çš„æ ‡ç­¾ï¼Œæ›´ç›´è§‚)
zscore_extreme_color = show_zscore_lines ? (visual_line_mode == "Both" ? 50 : 70) : 100
zscore_normal_color = show_zscore_lines ? (visual_line_mode == "Both" ? 60 : 80) : 100

plot(show_zscore_lines ? zscore_upper_2 : na, "Â±2Ïƒ (â‰ˆP98)", color=color.new(color_bear, zscore_extreme_color), linewidth=2, style=plot.style_line)
plot(show_zscore_lines ? zscore_upper_1_5 : na, "Â±1.5Ïƒ (â‰ˆP93)", color=color.new(color_bear, zscore_normal_color), linewidth=1, style=plot.style_circles)
plot(show_zscore_lines ? zscore_lower_1_5 : na, "Â±1.5Ïƒ (â‰ˆP7)", color=color.new(color_bull, zscore_normal_color), linewidth=1, style=plot.style_circles)
plot(show_zscore_lines ? zscore_lower_2 : na, "Â±2Ïƒ (â‰ˆP2)", color=color.new(color_bull, zscore_extreme_color), linewidth=2, style=plot.style_line)

// ç™¾åˆ†ä½çº¿ (ä½œä¸ºè¾…åŠ©å‚è€ƒ)
// æ³¨æ„ï¼šåœ¨Unifiedå’ŒZ-Scoreæ¨¡å¼ä¸‹ï¼Œç™¾åˆ†ä½çº¿è®¾ä¸ºé€æ˜ï¼ˆä»…ç”¨äºæ¸å˜å¡«å……ï¼‰
percentile_line_transparency = show_percentile_lines ? (visual_line_mode == "Both" ? 85 : 70) : 100  // Unified/Z-Scoreæ¨¡å¼ä¸‹100%é€æ˜

p95_line = plot(rsi_p95, "P95 æç«¯è¶…ä¹°", color=color.new(color_bear, percentile_line_transparency), linewidth=1)
p90_line = plot(rsi_p90, "P90 è¶…ä¹°", color=color.new(color_bear, percentile_line_transparency), linewidth=1, style=plot.style_circles)
p75_line = plot(rsi_p75, "P75", color=color.new(color.gray, percentile_line_transparency), linewidth=1)
p50_line = plot(rsi_p50, "P50 ä¸­ä½æ•°", color=color.new(color.white, 50), linewidth=2, style=plot.style_stepline)  // P50 å§‹ç»ˆæ˜¾ç¤º
p25_line = plot(rsi_p25, "P25", color=color.new(color.gray, percentile_line_transparency), linewidth=1)
p10_line = plot(rsi_p10, "P10 è¶…å–", color=color.new(color_bull, percentile_line_transparency), linewidth=1, style=plot.style_circles)
p5_line  = plot(rsi_p5, "P5 æç«¯è¶…å–", color=color.new(color_bull, percentile_line_transparency), linewidth=1)

// RSI ä¸»çº¿
rsi_line = plot(rsi, "RSI", color=color_rsi, linewidth=2)

// æ¸å˜å¡«å…… - ç‹¬ç«‹æ§åˆ¶ï¼Œä¸å—é˜ˆå€¼çº¿æ¨¡å¼å½±å“
// ä¸ŠåŠéƒ¨åˆ†æ¸å˜ (ç†Šå¸‚åŒºåŸŸ)
fill(p95_line, p90_line, color=show_fill ? color.new(color_bear, 75) : na, title="æç«¯è¶…ä¹°åŒº")
fill(p90_line, p75_line, color=show_fill ? color.new(color_bear, 88) : na, title="è¶…ä¹°åŒº")
fill(p75_line, p50_line, color=show_fill ? color.new(color_bear, 95) : na, title="åå¼ºåŒº")

// ä¸‹åŠéƒ¨åˆ†æ¸å˜ (ç‰›å¸‚åŒºåŸŸ)
fill(p50_line, p25_line, color=show_fill ? color.new(color_bull, 95) : na, title="åå¼±åŒº")
fill(p25_line, p10_line, color=show_fill ? color.new(color_bull, 88) : na, title="è¶…å–åŒº")
fill(p10_line, p5_line, color=show_fill ? color.new(color_bull, 75) : na, title="æç«¯è¶…å–åŒº")

// å›ºå®šè¾¹ç•Œå‚è€ƒçº¿
hline(0, "0", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(100, "100", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(50, "50 å›ºå®šä¸­çº¿", color=color.new(color.gray, 90), linestyle=hline.style_dotted)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// åŸºç¡€ä¿¡å· - ä½¿ç”¨ Z-Score åˆ¤æ–­æç«¯åŒºåŸŸ
// æç«¯ä¿¡å·: Z-Score Â±2Ïƒ (ç»Ÿè®¡å­¦ä¸Šçº¦ 95% ç½®ä¿¡åŒºé—´å¤–ï¼ŒP2.3/P97.7)
// æ™®é€šä¿¡å·: ä½¿ç”¨ç”¨æˆ·é…ç½®çš„ normal_threshold (é»˜è®¤ Â±1.5Ïƒï¼Œçº¦ P6.7/P93.3)
raw_extreme_oversold = ta.crossunder(rsi_zscore, -2)
raw_extreme_overbought = ta.crossover(rsi_zscore, 2)
raw_normal_oversold = ta.crossunder(rsi_zscore, -normal_threshold) and not raw_extreme_oversold
raw_normal_overbought = ta.crossover(rsi_zscore, normal_threshold) and not raw_extreme_overbought

// åº”ç”¨å¤§å‘¨æœŸè¶‹åŠ¿ä¿æŠ¤
extreme_oversold = enable_trend_protection ? (raw_extreme_oversold and trend_allows_buy) : raw_extreme_oversold
extreme_overbought = enable_trend_protection ? (raw_extreme_overbought and trend_allows_sell) : raw_extreme_overbought
normal_oversold = enable_trend_protection ? (raw_normal_oversold and trend_allows_buy) : raw_normal_oversold
normal_overbought = enable_trend_protection ? (raw_normal_overbought and trend_allows_sell) : raw_normal_overbought

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL COOLDOWN MECHANISM / ä¿¡å·å†·å´æœºåˆ¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å†·å´æœŸè·Ÿè¸ªå˜é‡ï¼ˆè®°å½•æ¯ç±»ä¿¡å·æœ€åè§¦å‘çš„ bar_indexï¼‰
var int last_mtf_buy_bar = na
var int last_mtf_sell_bar = na
var int last_div_buy_bar = na
var int last_div_sell_bar = na
var int last_ext_buy_bar = na
var int last_ext_sell_bar = na
var int last_norm_buy_bar = na
var int last_norm_sell_bar = na

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ CONSOLIDATED SIGNALS (ä¼˜å…ˆçº§åˆå¹¶ä¿¡å·)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æç«¯åŒºåŸŸåˆ¤æ–­ - å½“å‰Kçº¿ (ä½¿ç”¨ Z-Score)
bool in_extreme_oversold = rsi_zscore < -2
bool in_extreme_overbought = rsi_zscore > 2

// æç«¯åŒºåŸŸåˆ¤æ–­ - èƒŒç¦»å‘ç”Ÿæ—¶ (div_lookback æ ¹Kçº¿å‰)
float zscore_at_div = rsi_stdev[div_lookback] != 0 ? (rsi[div_lookback] - rsi_mean[div_lookback]) / rsi_stdev[div_lookback] : 0
bool was_extreme_oversold = zscore_at_div < -2
bool was_extreme_overbought = zscore_at_div > 2

// åŸå§‹ä¿¡å·ï¼ˆæœªå»é‡ï¼‰
bool raw_sig_buy_mtf = enable_mtf and oversold_resonance and extreme_oversold
bool raw_sig_buy_div = enable_divergence and bullish_divergence and was_extreme_oversold and not raw_sig_buy_mtf
bool raw_sig_buy_extreme = extreme_oversold and not raw_sig_buy_mtf and not raw_sig_buy_div
bool raw_sig_buy_normal = normal_oversold and not raw_sig_buy_mtf and not raw_sig_buy_div and not raw_sig_buy_extreme

bool raw_sig_sell_mtf = enable_mtf and overbought_resonance and extreme_overbought
bool raw_sig_sell_div = enable_divergence and bearish_divergence and was_extreme_overbought and not raw_sig_sell_mtf
bool raw_sig_sell_extreme = extreme_overbought and not raw_sig_sell_mtf and not raw_sig_sell_div
bool raw_sig_sell_normal = normal_overbought and not raw_sig_sell_mtf and not raw_sig_sell_div and not raw_sig_sell_extreme

// åº”ç”¨å†·å´æœŸï¼ˆä»…å½“å¯ç”¨æ—¶ï¼‰
bool sig_buy_mtf = enable_signal_cooldown ? (raw_sig_buy_mtf and (na(last_mtf_buy_bar) or bar_index - last_mtf_buy_bar >= cooldown_bars)) : raw_sig_buy_mtf
bool sig_buy_div = enable_signal_cooldown ? (raw_sig_buy_div and (na(last_div_buy_bar) or bar_index - last_div_buy_bar >= cooldown_bars)) : raw_sig_buy_div
bool sig_buy_extreme = enable_signal_cooldown ? (raw_sig_buy_extreme and (na(last_ext_buy_bar) or bar_index - last_ext_buy_bar >= cooldown_bars)) : raw_sig_buy_extreme
bool sig_buy_normal = enable_signal_cooldown ? (raw_sig_buy_normal and (na(last_norm_buy_bar) or bar_index - last_norm_buy_bar >= cooldown_bars)) : raw_sig_buy_normal

bool sig_sell_mtf = enable_signal_cooldown ? (raw_sig_sell_mtf and (na(last_mtf_sell_bar) or bar_index - last_mtf_sell_bar >= cooldown_bars)) : raw_sig_sell_mtf
bool sig_sell_div = enable_signal_cooldown ? (raw_sig_sell_div and (na(last_div_sell_bar) or bar_index - last_div_sell_bar >= cooldown_bars)) : raw_sig_sell_div
bool sig_sell_extreme = enable_signal_cooldown ? (raw_sig_sell_extreme and (na(last_ext_sell_bar) or bar_index - last_ext_sell_bar >= cooldown_bars)) : raw_sig_sell_extreme
bool sig_sell_normal = enable_signal_cooldown ? (raw_sig_sell_normal and (na(last_norm_sell_bar) or bar_index - last_norm_sell_bar >= cooldown_bars)) : raw_sig_sell_normal

// æ›´æ–°å†·å´æœŸè®¡æ•°å™¨
if sig_buy_mtf
    last_mtf_buy_bar := bar_index
if sig_buy_div
    last_div_buy_bar := bar_index
if sig_buy_extreme
    last_ext_buy_bar := bar_index
if sig_buy_normal
    last_norm_buy_bar := bar_index

if sig_sell_mtf
    last_mtf_sell_bar := bar_index
if sig_sell_div
    last_div_sell_bar := bar_index
if sig_sell_extreme
    last_ext_sell_bar := bar_index
if sig_sell_normal
    last_norm_sell_bar := bar_index

// èƒŒç¦»å•ç‹¬æ˜¾ç¤º (èƒŒç¦»æ—¶ä¸åœ¨æç«¯åŒºåŸŸ)
bool sig_div_bull_only = enable_divergence and bullish_divergence and not was_extreme_oversold
bool sig_div_bear_only = enable_divergence and bearish_divergence and not was_extreme_overbought

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL QUALITY SCORING / ä¿¡å·è´¨é‡è¯„åˆ†
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// è®¡ç®—ä¹°å…¥ä¿¡å·è´¨é‡åˆ†æ•° (ç®€åŒ–æ ¸å¿ƒå› ç´  + å‡åˆ†æœºåˆ¶)
// åŸºç¡€åˆ†50 + åŠ åˆ†(æœ€é«˜+70) - å‡åˆ†(æœ€é«˜-45) = ç†è®ºèŒƒå›´ 5~120
f_buy_quality() =>
    score = 0

    // â•â•â• åŸºç¡€åˆ†ï¼šè¿›å…¥æç«¯åŒº â•â•â•
    if rsi_zscore < -2
        score := 50

    // â•â•â• åŠ åˆ†é¡¹ â•â•â•

    // æç«¯ç¨‹åº¦ (+20 if Z < -2.5, +10 if Z < -2)
    if rsi_zscore < -2.5
        score += 20
    else if rsi_zscore < -2
        score += 10

    // èƒŒç¦»æˆ–MTFå…±æŒ¯ (+25ï¼ŒäºŒé€‰ä¸€ä¸å åŠ )
    if bullish_divergence or oversold_resonance
        score += 25

    // å‘¨çº¿é¡ºåŠ¿ (+15)
    if weekly_uptrend
        score += 15

    // æ”¾é‡ç¡®è®¤ (+10)
    if volume_surge
        score += 10

    // â•â•â• å‡åˆ†é¡¹ â•â•â•

    // å‘¨çº¿é€†åŠ¿ (-20)
    if weekly_extreme_bearish
        score -= 20

    // ç¼©é‡ (-10)
    if volume_low
        score -= 10

    // å¥åº·åº¦å·® (-15ï¼Œä»»ä¸€å¥åº·æŒ‡æ ‡ä¸åˆæ ¼)
    if not health_sample_coverage or not health_distribution_spread or not health_stat_valid
        score -= 15

    math.max(score, 0)  // ç¡®ä¿åˆ†æ•°ä¸ä¸ºè´Ÿ

// è®¡ç®—å–å‡ºä¿¡å·è´¨é‡åˆ†æ•° (ç®€åŒ–æ ¸å¿ƒå› ç´  + å‡åˆ†æœºåˆ¶)
// åŸºç¡€åˆ†50 + åŠ åˆ†(æœ€é«˜+70) - å‡åˆ†(æœ€é«˜-45) = ç†è®ºèŒƒå›´ 5~120
f_sell_quality() =>
    score = 0

    // â•â•â• åŸºç¡€åˆ†ï¼šè¿›å…¥æç«¯åŒº â•â•â•
    if rsi_zscore > 2
        score := 50

    // â•â•â• åŠ åˆ†é¡¹ â•â•â•

    // æç«¯ç¨‹åº¦ (+20 if Z > 2.5, +10 if Z > 2)
    if rsi_zscore > 2.5
        score += 20
    else if rsi_zscore > 2
        score += 10

    // èƒŒç¦»æˆ–MTFå…±æŒ¯ (+25ï¼ŒäºŒé€‰ä¸€ä¸å åŠ )
    if bearish_divergence or overbought_resonance
        score += 25

    // å‘¨çº¿é¡ºåŠ¿ (+15)
    if weekly_downtrend
        score += 15

    // æ”¾é‡ç¡®è®¤ (+10)
    if volume_surge
        score += 10

    // â•â•â• å‡åˆ†é¡¹ â•â•â•

    // å‘¨çº¿é€†åŠ¿ (-20)
    if weekly_extreme_bullish
        score -= 20

    // ç¼©é‡ (-10)
    if volume_low
        score -= 10

    // å¥åº·åº¦å·® (-15ï¼Œä»»ä¸€å¥åº·æŒ‡æ ‡ä¸åˆæ ¼)
    if not health_sample_coverage or not health_distribution_spread or not health_stat_valid
        score -= 15

    math.max(score, 0)  // ç¡®ä¿åˆ†æ•°ä¸ä¸ºè´Ÿ

// å½“å‰ä¿¡å·è´¨é‡
current_buy_quality = f_buy_quality()
current_sell_quality = f_sell_quality()

// è´¨é‡ç­‰çº§è½¬æ¢ (ç®€åŒ–è¯„åˆ†ä½“ç³»ï¼Œæ›´æ˜“è¾¾åˆ°é«˜ç­‰çº§)
// A: â‰¥80 (é«˜è´¨é‡ä¿¡å·), B: â‰¥60, C: â‰¥40, D: <40
f_quality_grade(_score) =>
    _score >= 80 ? "A" : _score >= 60 ? "B" : _score >= 40 ? "C" : "D"

buy_quality_grade = f_quality_grade(current_buy_quality)
sell_quality_grade = f_quality_grade(current_sell_quality)

// å½“å‰æ´»è·ƒä¿¡å·çš„è´¨é‡ç­‰çº§ (åŒ…å«æŒç»­æç«¯åŒºçŠ¶æ€ï¼Œåˆ›é€ æ›´å¤šäº¤æ˜“ç©ºé—´)
active_signal_grade = sig_buy_mtf or sig_buy_div or sig_buy_extreme or sig_buy_normal ? buy_quality_grade :
                      sig_sell_mtf or sig_sell_div or sig_sell_extreme or sig_sell_normal ? sell_quality_grade :
                      in_extreme_oversold ? buy_quality_grade :
                      in_extreme_overbought ? sell_quality_grade : ""

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ STATISTICS CALCULATION (ä½¿ç”¨å®é™…è§¦å‘çš„ä¿¡å·)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if enable_stats and bar_index > stats_forward_bars
    forward_return_long = (close - close[stats_forward_bars]) / close[stats_forward_bars] * 100
    forward_return_short = (close[stats_forward_bars] - close) / close[stats_forward_bars] * 100
    
    // ä½¿ç”¨ UDT æ–¹æ³•è¿›è¡Œæ‰¹é‡æ›´æ–°
    mtf_buy_stats.update(sig_buy_mtf[stats_forward_bars], forward_return_long)
    mtf_sell_stats.update(sig_sell_mtf[stats_forward_bars], forward_return_short)
    
    div_buy_stats.update(sig_buy_div[stats_forward_bars], forward_return_long)
    div_sell_stats.update(sig_sell_div[stats_forward_bars], forward_return_short)
    
    ext_buy_stats.update(sig_buy_extreme[stats_forward_bars], forward_return_long)
    ext_sell_stats.update(sig_sell_extreme[stats_forward_bars], forward_return_short)
    
    norm_buy_stats.update(sig_buy_normal[stats_forward_bars], forward_return_long)
    norm_sell_stats.update(sig_sell_normal[stats_forward_bars], forward_return_short)


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL DISPLAY (ä¿¡å·æ˜¾ç¤º)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ä¹°å…¥ä¿¡å· (åº•éƒ¨)
plotshape(sig_buy_mtf, title="ğŸŒŸ MTF+æç«¯è¶…å–", style=shape.labelup, location=location.bottom, color=#00E676, size=size.normal, text="ğŸŒŸ", textcolor=color.white)
plotshape(sig_buy_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…å–", style=shape.labelup, location=location.bottom, color=#00BCD4, size=size.normal, text="ğŸ’", textcolor=color.white)
plotshape(sig_buy_extreme, title="ğŸ”¥ æç«¯è¶…å–", style=shape.triangleup, location=location.bottom, color=color_bull, size=size.small, text="ğŸ”¥")
plotshape(show_normal_signals and sig_buy_normal, title="â¬†ï¸ æ™®é€šè¶…å–", style=shape.circle, location=location.bottom, color=color.new(color_bull, 30), size=size.tiny, text="â¬†ï¸")

// å–å‡ºä¿¡å· (é¡¶éƒ¨)
plotshape(sig_sell_mtf, title="ğŸŒŸ MTF+æç«¯è¶…ä¹°", style=shape.labeldown, location=location.top, color=#FF5252, size=size.normal, text="ğŸŒŸ", textcolor=color.white)
plotshape(sig_sell_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…ä¹°", style=shape.labeldown, location=location.top, color=#FF9800, size=size.normal, text="ğŸ’", textcolor=color.white)
plotshape(sig_sell_extreme, title="â„ï¸ æç«¯è¶…ä¹°", style=shape.triangledown, location=location.top, color=color_bear, size=size.small, text="â„ï¸")
plotshape(show_normal_signals and sig_sell_normal, title="â¬‡ï¸ æ™®é€šè¶…ä¹°", style=shape.circle, location=location.top, color=color.new(color_bear, 30), size=size.tiny, text="â¬‡ï¸")

// èƒŒç¦»å•ç‹¬æ ‡è®° (ä¿¡å·å·²åœ¨ pivot ç¡®è®¤æ—¶è§¦å‘ï¼Œæ— éœ€é¢å¤– offset)
plotshape(sig_div_bull_only, title="â†—ï¸ çœ‹æ¶¨èƒŒç¦»", style=shape.circle, location=location.bottom, color=#00BCD4, size=size.tiny, text="â†—ï¸")
plotshape(sig_div_bear_only, title="â†˜ï¸ çœ‹è·ŒèƒŒç¦»", style=shape.circle, location=location.top, color=#FF9800, size=size.tiny, text="â†˜ï¸")

// èƒŒæ™¯è‰²é«˜äº®
bgcolor(rsi < rsi_p5 ? color.new(color_bull, 90) : rsi > rsi_p95 ? color.new(color_bear, 90) : na, title="æç«¯åŒºèƒŒæ™¯")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// MTF çŠ¶æ€è½¬æ–‡å­— (å®šä¹‰åœ¨ if å—å¤–éƒ¨)
f_status_text(_status) =>
    _status == 1 ? "ğŸŸ¢" : _status == -1 ? "ğŸ”´" : "âšª"

if show_dashboard
    // è®¡ç®—å½“å‰RSIåœ¨åˆ†å¸ƒä¸­çš„ä½ç½®
    rsi_percentile = 0.0
    if rsi <= rsi_p5
        rsi_percentile := 5.0
    else if rsi <= rsi_p10
        rsi_percentile := 10.0
    else if rsi <= rsi_p25
        rsi_percentile := 25.0
    else if rsi <= rsi_p50
        rsi_percentile := 50.0
    else if rsi <= rsi_p75
        rsi_percentile := 75.0
    else if rsi <= rsi_p90
        rsi_percentile := 90.0
    else if rsi <= rsi_p95
        rsi_percentile := 95.0
    else
        rsi_percentile := 99.0

    // çŠ¶æ€åˆ¤æ–­ (ä½¿ç”¨ Z-Score)
    status_text = rsi_zscore < -2 ? "ğŸŸ¢ EXTREME OVERSOLD" :
                  rsi_zscore < -1.5 ? "ğŸŸ¡ OVERSOLD" :
                  rsi_zscore > 2 ? "ğŸ”´ EXTREME OVERBOUGHT" :
                  rsi_zscore > 1.5 ? "ğŸŸ  OVERBOUGHT" : "âšª NEUTRAL"
    
    status_color = rsi_zscore < -1.5 ? color_bull : rsi_zscore > 1.5 ? color_bear : color.gray

    // å­—ä½“å¤§å°è½¬æ¢
    txt_size_title = dashboard_size == "Tiny" ? size.tiny : dashboard_size == "Small" ? size.small : dashboard_size == "Normal" ? size.normal : size.large
    txt_size_body = dashboard_size == "Tiny" ? size.tiny : dashboard_size == "Small" ? size.tiny : dashboard_size == "Normal" ? size.small : size.normal
    
    // èƒŒç¦»çŠ¶æ€
    div_text = bullish_divergence ? "ğŸŸ¢ BULL" : bearish_divergence ? "ğŸ”´ BEAR" : "â€”"
    div_color = bullish_divergence ? #00BCD4 : bearish_divergence ? #FF9800 : color.gray
    
    // å…±æŒ¯çŠ¶æ€ (ä½¿ç”¨åŠ¨æ€çš„æœ‰æ•ˆæ—¶é—´æ¡†æ¶æ•°)
    resonance_text = oversold_resonance ? str.format("ğŸŸ¢ {0}/{1}", oversold_count, valid_tf_count) : 
                     overbought_resonance ? str.format("ğŸ”´ {0}/{1}", overbought_count, valid_tf_count) : 
                     str.format("âšª {0}/{1}", math.max(oversold_count, overbought_count), valid_tf_count)
    resonance_color = oversold_resonance ? color_bull : overbought_resonance ? color_bear : color.gray

    // è®¡ç®—è¡Œæ•°: Mobileæ¨¡å¼3è¡Œ, Liteæ¨¡å¼6è¡Œ(å«Protection), Fullæ¨¡å¼æ ¹æ®å¯ç”¨åŠŸèƒ½è®¡ç®—
    mobile_rows = 3
    lite_rows = 6  // å¢åŠ äº† Protection è¡Œ
    full_rows = 6 + (enable_mtf and dashboard_mode == "Full" ? 2 : 0) + (enable_divergence and dashboard_mode == "Full" ? 1 : 0) + (enable_stats and dashboard_mode == "Full" ? 9 : 0)
    total_rows = dashboard_mode == "Mobile" ? mobile_rows : dashboard_mode == "Lite" ? lite_rows : full_rows

    // åˆ›å»ºè¡¨æ ¼ - æ·±è“ç°è‰²èƒŒæ™¯æ›´æ˜“è¯»
    var table dashboard = table.new(position.top_right, 2, 20,  // å¢åŠ åˆ°20è¡Œ 
                                     bgcolor=color.new(#1a1a2e, dashboard_transparency),
                                     border_width=1, border_color=color.new(#4a4a6a, 50))
    
    if barstate.islast
        row = 0
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Mobile æ¨¡å¼ (æç®€ 3 è¡Œ)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if dashboard_mode == "Mobile"
            // ç¬¬1è¡Œï¼šRSIå€¼
            table.cell(dashboard, 0, row, "RSI", text_color=color.gray, text_size=txt_size_body, bgcolor=color.new(#2962FF, dashboard_transparency))
            table.cell(dashboard, 1, row, str.tostring(rsi, "#.1"), text_color=color_rsi, text_size=txt_size_body, bgcolor=color.new(#2962FF, dashboard_transparency))
            row += 1
            
            // ç¬¬2è¡Œï¼šä¿¡å·emoji + è´¨é‡ç­‰çº§ (ä¼˜åŒ–ï¼šæ— æ–°ä¿¡å·æ—¶æ˜¾ç¤ºæŒç»­çŠ¶æ€)
            signal_text = "âšª"
            signal_color = color.gray

            // ä¼˜å…ˆçº§1: è§¦å‘çš„ä¿¡å· (äº‹ä»¶) - æ˜¾ç¤ºä¿¡å·emoji + ç­‰çº§
            if sig_buy_mtf
                signal_text := "ğŸŒŸ [" + buy_quality_grade + "]"
                signal_color := color_bull
            else if sig_buy_div
                signal_text := "ğŸ’ [" + buy_quality_grade + "]"
                signal_color := color_bull
            else if sig_buy_extreme
                signal_text := "ğŸ”¥ [" + buy_quality_grade + "]"
                signal_color := color_bull
            else if show_normal_signals and sig_buy_normal
                signal_text := "â¬†ï¸ [" + buy_quality_grade + "]"
                signal_color := color_bull
            else if sig_sell_mtf
                signal_text := "ğŸŒŸ [" + sell_quality_grade + "]"
                signal_color := color_bear
            else if sig_sell_div
                signal_text := "ğŸ’ [" + sell_quality_grade + "]"
                signal_color := color_bear
            else if sig_sell_extreme
                signal_text := "â„ï¸ [" + sell_quality_grade + "]"
                signal_color := color_bear
            else if show_normal_signals and sig_sell_normal
                signal_text := "â¬‡ï¸ [" + sell_quality_grade + "]"
                signal_color := color_bear
            else if sig_div_bull_only
                signal_text := "â†—ï¸ [" + buy_quality_grade + "]"
                signal_color := #00BCD4
            else if sig_div_bear_only
                signal_text := "â†˜ï¸ [" + sell_quality_grade + "]"
                signal_color := #FF9800
            // ä¼˜å…ˆçº§2: æŒç»­æç«¯çŠ¶æ€ (æ— æ–°ä¿¡å·ä½†ä»åœ¨æç«¯åŒºåŸŸ) - æ˜¾ç¤ºæŒç»­ + ç­‰çº§
            else if in_extreme_oversold
                signal_text := "ğŸ”¥æŒç»­ [" + buy_quality_grade + "]"
                signal_color := color.new(color_bull, 30)
            else if in_extreme_overbought
                signal_text := "â„ï¸æŒç»­ [" + sell_quality_grade + "]"
                signal_color := color.new(color_bear, 30)
            // ä¼˜å…ˆçº§3: æŒç»­æ™®é€šè¶…ä¹°/è¶…å–çŠ¶æ€ - ä¸æ˜¾ç¤ºç­‰çº§ (éä¿¡å·åŒº)
            else if rsi_zscore < -normal_threshold
                signal_text := "â¬†ï¸åŒº"
                signal_color := color.new(color_bull, 50)
            else if rsi_zscore > normal_threshold
                signal_text := "â¬‡ï¸åŒº"
                signal_color := color.new(color_bear, 50)

            table.cell(dashboard, 0, row, "ä¿¡å·", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, signal_text, text_color=signal_color, text_size=txt_size_body)
            row += 1
            
            // ç¬¬3è¡Œï¼šçŠ¶æ€
            status_mobile = rsi_zscore < -2 ? "ğŸŸ¢æå–" : rsi_zscore < -1.5 ? "ğŸŸ¡è¶…å–" : rsi_zscore > 2 ? "ğŸ”´æä¹°" : rsi_zscore > 1.5 ? "ğŸŸ è¶…ä¹°" : "âšªä¸­æ€§"
            
            table.cell(dashboard, 0, row, "çŠ¶æ€", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, status_mobile, text_color=status_color, text_size=txt_size_body)
            row += 1
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // æ ¸å¿ƒä¿¡æ¯ (Lite & Full å…±äº«)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        else
            // æ ‡é¢˜è¡Œ - ä»…æ˜¾ç¤ºRSIå€¼
            table.cell(dashboard, 0, row, "ADAPTIVE RSI", text_color=color.white, text_size=txt_size_title, bgcolor=color.new(#2962FF, dashboard_transparency))
            table.cell(dashboard, 1, row, str.tostring(rsi, "#.0"), text_color=color_rsi, text_size=txt_size_title, bgcolor=color.new(#2962FF, dashboard_transparency))
            row += 1
            
            // Z-Scoreè¡Œ - æ˜¾ç¤ºZå€¼å’Œå¯¹åº”çš„è¿‘ä¼¼ç™¾åˆ†ä½
            zscore_approx_pct = f_zscore_to_percentile(rsi_zscore)
            zscore_display = str.format("{0,number,#.2}Ïƒ (â‰ˆP{1,number,#})", rsi_zscore, zscore_approx_pct)
            table.cell(dashboard, 0, row, "Z-Score", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, zscore_display, text_color=status_color, text_size=txt_size_body)
            row += 1
            
            // ç™¾åˆ†ä½è¡Œ - æ˜¾ç¤ºç™¾åˆ†ä½å’Œå¯¹åº”çš„Z-ScoreèŒƒå›´
            pct_zscore_range = f_percentile_zscore_range(rsi_percentile)
            percentile_display = str.format("P{0,number,#}{1}", rsi_percentile, pct_zscore_range)
            table.cell(dashboard, 0, row, "Percentile", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, percentile_display, text_color=status_color, text_size=txt_size_body)
            row += 1
            
            // çŠ¶æ€ + ä¿¡å·è´¨é‡
            quality_display = active_signal_grade != "" ? str.format(" [{0}]", active_signal_grade) : ""
            table.cell(dashboard, 0, row, "Status", text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.format("{0}{1}", status_text, quality_display), text_color=status_color, text_size=txt_size_body)
            row += 1

            // å‘¨çº¿ä¿æŠ¤ + æˆäº¤é‡çŠ¶æ€
            weekly_rsi_display = str.format("W.RSI:{0,number,#}", weekly_rsi)
            vol_display = volume_surge ? "ğŸ“Šâ†‘" : volume_low ? "ğŸ“Šâ†“" : "ğŸ“Š"
            protection_color = trend_allows_buy and trend_allows_sell ? color.white :
                              trend_allows_buy or trend_allows_sell ? color.yellow : color.red
            table.cell(dashboard, 0, row, str.format("Protection [{0}]", protection_level), text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.format("{0} {1} {2}", protection_status, weekly_rsi_display, vol_display), text_color=protection_color, text_size=txt_size_body)
            row += 1

            // Lookback ä¿¡æ¯ (æ˜¾ç¤ºæ¨¡å¼å’Œå¥åº·åº¦)
            lookback_mode_display = lookback_mode == "Auto" ? "[Auto]" : "[Custom]"
            health_icons = (health_sample_coverage ? "âœ…" : "âš ï¸") + (health_distribution_spread ? "âœ…" : "âš ï¸") + (health_stat_valid ? "âœ…" : "âš ï¸")
            lookback_color = health_sample_coverage and health_distribution_spread and health_stat_valid ? color.white : color.yellow
            table.cell(dashboard, 0, row, str.format("Lookback {0}", lookback_mode_display), text_color=color.gray, text_size=txt_size_body)
            table.cell(dashboard, 1, row, str.format("{0} {1}", lookback, health_icons), text_color=lookback_color, text_size=txt_size_body)
            row += 1
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // Full æ¨¡å¼é¢å¤–ä¿¡æ¯
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            if dashboard_mode == "Full"
                // MTF éƒ¨åˆ† (ä½¿ç”¨æ ¼å¼åŒ–åçš„æ—¶é—´æ¡†æ¶åç§°)
                if enable_mtf
                    table.cell(dashboard, 0, row, str.format("MTF {0}|{1}|{2}", mtf_tf1_display, mtf_tf2_display, mtf_tf3_display), text_color=color.gray, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0}|{1}|{2}", f_status_text(status_tf1), f_status_text(status_tf2), f_status_text(status_tf3)), text_color=color.white, text_size=txt_size_body)
                    row += 1
                    
                    table.cell(dashboard, 0, row, "Resonance", text_color=color.gray, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, resonance_text, text_color=resonance_color, text_size=txt_size_body)
                    row += 1
                
                // èƒŒç¦»éƒ¨åˆ† (æ˜¾ç¤ºå½“å‰æ¨¡å¼å’Œå‚æ•°)
                if enable_divergence
                    div_mode_display = div_mode == "Auto" ? str.format("[{0}]", active_div_mode) : ""
                    table.cell(dashboard, 0, row, str.format("Divergence {0}", div_mode_display), text_color=color.gray, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0} ({1}/{2})", div_text, div_lookback, div_range), text_color=div_color, text_size=txt_size_body)
                    row += 1
                
                // ç»Ÿè®¡éƒ¨åˆ† (æ ¼å¼: ä¿¡å·å(æ¬¡æ•°) | æ”¶ç›Š% | èƒœç‡%)
                if enable_stats
                    table.cell(dashboard, 0, row, "â”€â”€ STATS â”€â”€", text_color=color.gray, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, "(" + str.tostring(stats_forward_bars) + " bars)", text_color=color.gray, text_size=txt_size_body)
                    row += 1
                    
                    // ğŸŒŸ MTF å…±æŒ¯
                    table.cell(dashboard, 0, row, str.format("ğŸŒŸ MTF Buy({0})", mtf_buy_stats.count), text_color=#FFD700, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}% | {1,number,#}%", mtf_buy_stats.get_avg(), mtf_buy_stats.get_winrate()), text_color=color_bull, text_size=txt_size_body)
                    row += 1
                    table.cell(dashboard, 0, row, str.format("ğŸŒŸ MTF Sell({0})", mtf_sell_stats.count), text_color=#FFD700, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}% | {1,number,#}%", mtf_sell_stats.get_avg(), mtf_sell_stats.get_winrate()), text_color=color_bear, text_size=txt_size_body)
                    row += 1
                    
                    // ğŸ’ èƒŒç¦»+æç«¯
                    table.cell(dashboard, 0, row, str.format("ğŸ’ Div Buy({0})", div_buy_stats.count), text_color=#00BCD4, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}% | {1,number,#}%", div_buy_stats.get_avg(), div_buy_stats.get_winrate()), text_color=color_bull, text_size=txt_size_body)
                    row += 1
                    table.cell(dashboard, 0, row, str.format("ğŸ’ Div Sell({0})", div_sell_stats.count), text_color=#00BCD4, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}% | {1,number,#}%", div_sell_stats.get_avg(), div_sell_stats.get_winrate()), text_color=color_bear, text_size=txt_size_body)
                    row += 1
                    
                    // ğŸ”¥ æç«¯
                    table.cell(dashboard, 0, row, str.format("ğŸ”¥ Ext Buy({0})", ext_buy_stats.count), text_color=color_bull, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}% | {1,number,#}%", ext_buy_stats.get_avg(), ext_buy_stats.get_winrate()), text_color=color_bull, text_size=txt_size_body)
                    row += 1
                    table.cell(dashboard, 0, row, str.format("â„ï¸ Ext Sell({0})", ext_sell_stats.count), text_color=color_bear, text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}% | {1,number,#}%", ext_sell_stats.get_avg(), ext_sell_stats.get_winrate()), text_color=color_bear, text_size=txt_size_body)
                    row += 1
                    
                    // æ™®é€šä¿¡å·
                    table.cell(dashboard, 0, row, str.format("â¬†ï¸ Norm Buy({0})", norm_buy_stats.count), text_color=color.new(color_bull, 30), text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}% | {1,number,#}%", norm_buy_stats.get_avg(), norm_buy_stats.get_winrate()), text_color=color_bull, text_size=txt_size_body)
                    row += 1
                    table.cell(dashboard, 0, row, str.format("â¬‡ï¸ Norm Sell({0})", norm_sell_stats.count), text_color=color.new(color_bear, 30), text_size=txt_size_body)
                    table.cell(dashboard, 1, row, str.format("{0,number,+#.1;-#.1}% | {1,number,#}%", norm_sell_stats.get_avg(), norm_sell_stats.get_winrate()), text_color=color_bear, text_size=txt_size_body)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SMART ALERT (V6 Unified Alert System)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ™ºèƒ½è­¦æŠ¥ï¼šè‡ªåŠ¨èšåˆæ‰€æœ‰ä¿¡å·åˆ°ä¸€æ¡å¯Œæ–‡æœ¬æ¶ˆæ¯
// ä½¿ç”¨ä¸Šå‡æ²¿æ£€æµ‹ï¼šåªåœ¨æœ‰æ–°ä¿¡å·å‡ºç°æ—¶è§¦å‘

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SMART ALERT (Aggregated Signals)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// æ™ºèƒ½è­¦æŠ¥ï¼šå•æ¡æ¶ˆæ¯æ±‡æ€»æ‰€æœ‰è§¦å‘çš„ä¿¡å·ï¼Œé¿å…é‡å¤é€šçŸ¥
// ä½¿ç”¨ä¸Šå‡æ²¿æ£€æµ‹ï¼šåªåœ¨æœ‰æ–°ä¿¡å·å‡ºç°æ—¶è§¦å‘

// varip: è¿½è¸ªå½“å‰Kçº¿å†…å·²å‘é€çš„æœ€é«˜ä¿¡å·ç­‰çº§ (Kçº¿æ”¶ç›˜æ—¶è‡ªåŠ¨é‡ç½®)
// ä¿¡å·ç­‰çº§: 0=æ— , 1=æ™®é€š, 2=æç«¯, 3=èƒŒç¦», 4=MTFå…±æŒ¯
// ä¼˜åŒ–ï¼šå½“å‡ºç°æ›´å¼ºä¿¡å·æ—¶ä¹Ÿä¼šè§¦å‘æ–°è­¦æŠ¥
varip int buy_alert_level_sent = 0
varip int sell_alert_level_sent = 0

// è®¡ç®—å½“å‰ä¿¡å·ç­‰çº§ (ä¼˜å…ˆçº§è¶Šé«˜å€¼è¶Šå¤§)
f_signal_level(_mtf, _div, _ext, _norm) =>
    _mtf ? 4 : _div ? 3 : _ext ? 2 : _norm ? 1 : 0

// æ–°Kçº¿å¼€å§‹æ—¶é‡ç½®
if barstate.isnew
    buy_alert_level_sent := 0
    sell_alert_level_sent := 0

if enable_smart_alert
    // ä¹°å…¥ä¿¡å·æ±‡æ€»
    has_buy_signal = sig_buy_mtf or sig_buy_div or sig_buy_extreme or sig_buy_normal
    has_buy_signal_prev = sig_buy_mtf[1] or sig_buy_div[1] or sig_buy_extreme[1] or sig_buy_normal[1]
    current_buy_level = f_signal_level(sig_buy_mtf, sig_buy_div, sig_buy_extreme, sig_buy_normal)
    
    // è§¦å‘æ¡ä»¶ï¼šæ–°ä¿¡å·å‡ºç°(ä¸Šå‡æ²¿) ä¸” (æœªå‘é€è¿‡ æˆ– å½“å‰ç­‰çº§æ›´é«˜)
    should_alert_buy = has_buy_signal and not has_buy_signal_prev and current_buy_level > buy_alert_level_sent
    
    if should_alert_buy
        msg = str.format("{0}: ğŸŸ¢ BUY SIGNALS â†’ ", syminfo.ticker)

        if sig_buy_mtf
            msg := msg + "ğŸŒŸMTFå…±æŒ¯ "
        if sig_buy_div
            msg := msg + "ğŸ’èƒŒç¦» "
        if sig_buy_extreme
            msg := msg + "ğŸ”¥æç«¯ "
        if sig_buy_normal
            msg := msg + "â¬†ï¸è¶…å– "

        // æ·»åŠ æ–°å¢è¯„åˆ†å› ç´ æç¤º
        if confirmation_buy
            msg := msg + "âœ“ç¡®è®¤ "
        if reversal_buy
            msg := msg + "â†©åè½¬ "
        if realtime_bullish_div
            msg := msg + "âš¡å®æ—¶èƒŒç¦» "

        zscore_pct = f_zscore_to_percentile(rsi_zscore)
        msg := msg + str.format("| RSI:{0,number,#.1} Z:{1,number,#.2}Ïƒ (â‰ˆP{2,number,#}) [{3}]", rsi, rsi_zscore, zscore_pct, buy_quality_grade)

        alert(msg, alert.freq_once_per_bar)
        buy_alert_level_sent := current_buy_level  // è®°å½•å·²å‘é€çš„æœ€é«˜ç­‰çº§
    
    // å–å‡ºä¿¡å·æ±‡æ€»
    has_sell_signal = sig_sell_mtf or sig_sell_div or sig_sell_extreme or sig_sell_normal
    has_sell_signal_prev = sig_sell_mtf[1] or sig_sell_div[1] or sig_sell_extreme[1] or sig_sell_normal[1]
    current_sell_level = f_signal_level(sig_sell_mtf, sig_sell_div, sig_sell_extreme, sig_sell_normal)
    
    // è§¦å‘æ¡ä»¶ï¼šæ–°ä¿¡å·å‡ºç°(ä¸Šå‡æ²¿) ä¸” (æœªå‘é€è¿‡ æˆ– å½“å‰ç­‰çº§æ›´é«˜)
    should_alert_sell = has_sell_signal and not has_sell_signal_prev and current_sell_level > sell_alert_level_sent
    
    if should_alert_sell
        msg = str.format("{0}: ğŸ”´ SELL SIGNALS â†’ ", syminfo.ticker)

        if sig_sell_mtf
            msg := msg + "ğŸŒŸMTFå…±æŒ¯ "
        if sig_sell_div
            msg := msg + "ğŸ’èƒŒç¦» "
        if sig_sell_extreme
            msg := msg + "â„ï¸æç«¯ "
        if sig_sell_normal
            msg := msg + "â¬‡ï¸è¶…ä¹° "

        // æ·»åŠ æ–°å¢è¯„åˆ†å› ç´ æç¤º
        if confirmation_sell
            msg := msg + "âœ“ç¡®è®¤ "
        if reversal_sell
            msg := msg + "â†©åè½¬ "
        if realtime_bearish_div
            msg := msg + "âš¡å®æ—¶èƒŒç¦» "

        zscore_pct = f_zscore_to_percentile(rsi_zscore)
        msg := msg + str.format("| RSI:{0,number,#.1} Z:{1,number,#.2}Ïƒ (â‰ˆP{2,number,#}) [{3}]", rsi, rsi_zscore, zscore_pct, sell_quality_grade)

        alert(msg, alert.freq_once_per_bar)
        sell_alert_level_sent := current_sell_level  // è®°å½•å·²å‘é€çš„æœ€é«˜ç­‰çº§
