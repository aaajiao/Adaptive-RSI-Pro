// MIT License - Feel free to use, modify, and share.
// Â© Adaptive RSI Pro - Dynamic Thresholds + MTF + Divergence + Statistics

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ EMOJI LEGEND / ä¿¡å·å›¾ä¾‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//
// â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
// â”‚ CHART SIGNALS / å›¾è¡¨ä¿¡å·                                                    â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ BUY / ä¹°å…¥ (æ˜¾ç¤ºåœ¨åº•éƒ¨)                                                     â”‚
// â”‚   ğŸŒŸ MTF Resonance + Extreme Oversold  å¤šå‘¨æœŸå…±æŒ¯+æç«¯è¶…å– (æœ€å¼ºä¹°å…¥ä¿¡å·)    â”‚
// â”‚   ğŸ’ Divergence + Extreme Oversold     èƒŒç¦»+æç«¯è¶…å– (å¼ºä¹°å…¥ä¿¡å·)            â”‚
// â”‚   ğŸ”¥ Extreme Oversold (P5)             æç«¯è¶…å– (ä¹°å…¥ä¿¡å·)                   â”‚
// â”‚   â¬†ï¸ Normal Oversold (P10)              æ™®é€šè¶…å– (å¼±ä¹°å…¥ï¼Œé»˜è®¤éšè—)          â”‚
// â”‚   â†—ï¸ Bullish Divergence Only            çœ‹æ¶¨èƒŒç¦» (æ½œåœ¨åº•éƒ¨ï¼Œéä¿¡å·)          â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ SELL / å–å‡º (æ˜¾ç¤ºåœ¨é¡¶éƒ¨)                                                    â”‚
// â”‚   ğŸŒŸ MTF Resonance + Extreme Overbought å¤šå‘¨æœŸå…±æŒ¯+æç«¯è¶…ä¹° (æœ€å¼ºå–å‡ºä¿¡å·)   â”‚
// â”‚   ğŸ’ Divergence + Extreme Overbought    èƒŒç¦»+æç«¯è¶…ä¹° (å¼ºå–å‡ºä¿¡å·)           â”‚
// â”‚   â„ï¸ Extreme Overbought (P95)           æç«¯è¶…ä¹° (å–å‡ºä¿¡å·)                  â”‚
// â”‚   â¬‡ï¸ Normal Overbought (P90)            æ™®é€šè¶…ä¹° (å¼±å–å‡ºï¼Œé»˜è®¤éšè—)          â”‚
// â”‚   â†˜ï¸ Bearish Divergence Only            çœ‹è·ŒèƒŒç¦» (æ½œåœ¨é¡¶éƒ¨ï¼Œéä¿¡å·)          â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ DASHBOARD STATUS / ä»ªè¡¨ç›˜çŠ¶æ€                                               â”‚
// â”‚   ğŸŸ¢ Bullish/Oversold  çœ‹æ¶¨/è¶…å–çŠ¶æ€                                        â”‚
// â”‚   ğŸ”´ Bearish/Overbought çœ‹è·Œ/è¶…ä¹°çŠ¶æ€                                       â”‚
// â”‚   ğŸŸ¡ Mild Oversold     è½»åº¦è¶…å–                                             â”‚
// â”‚   ğŸŸ  Mild Overbought   è½»åº¦è¶…ä¹°                                             â”‚
// â”‚   âšª Neutral           ä¸­æ€§çŠ¶æ€                                             â”‚
// â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
// â”‚ ALERTS / è­¦æŠ¥                                                               â”‚
// â”‚   ğŸ“ˆ Trend Shift Up    è¶‹åŠ¿å‘ä¸Š (RSIä¸Šç©¿P50)                                â”‚
// â”‚   ğŸ“‰ Trend Shift Down  è¶‹åŠ¿å‘ä¸‹ (RSIä¸‹ç©¿P50)                                â”‚
// â”‚   âš¡ Any Extreme       ä»»æ„æç«¯ä¿¡å·                                         â”‚
// â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
//
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

//@version=5
indicator("Adaptive RSI Pro", shorttitle="ARSI Pro", overlay=false, precision=2, max_lines_count=100, max_labels_count=100, max_bars_back=4500)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ INPUTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

grp_rsi = "â•â•â• RSI Settings / RSIè®¾ç½® â•â•â•"
rsi_length = input.int(14, "RSI Length / RSIå‘¨æœŸ", minval=2, group=grp_rsi)
rsi_source = input.source(close, "RSI Source / æ•°æ®æº", group=grp_rsi)

grp_adaptive = "â•â•â• Adaptive Settings / è‡ªé€‚åº”è®¾ç½® â•â•â•"
lookback_mode = input.string("Auto", "Lookback Mode / å›çœ‹æ¨¡å¼", options=["Auto", "Custom"], group=grp_adaptive, tooltip="Auto: æ ¹æ®æ—¶é—´æ¡†æ¶å’ŒRSIæ³¢åŠ¨ç‡è‡ªåŠ¨è®¡ç®—\nCustom: ä½¿ç”¨è‡ªå®šä¹‰å€¼")
lookback_custom = input.int(252, "Custom Lookback / è‡ªå®šä¹‰å›çœ‹", minval=50, maxval=2000, group=grp_adaptive, tooltip="ä»…åœ¨ Custom æ¨¡å¼ä¸‹ä½¿ç”¨ã€‚å»ºè®®ï¼šæ—¥çº¿252ï¼Œ4å°æ—¶500ï¼Œ1å°æ—¶750")
lookback_precision = input.string("Normal", "Precision / ç²¾åº¦", options=["High", "Normal", "Low"], group=grp_adaptive, tooltip="High(é«˜ç²¾åº¦): éœ€è¦æ›´å¤šæ•°æ®ï¼Œæ›´å‡†ç¡®\nNormal(å¹³è¡¡): æ¨èè®¾ç½®\nLow(å¿«é€‚åº”): æ›´å°‘æ•°æ®ï¼Œæ›´å¿«å“åº”")
vol_history_mode = input.string("1 Year", "History Depth / å†å²æ·±åº¦", options=["6 Months", "1 Year", "2 Years"], group=grp_adaptive, tooltip="æ³¢åŠ¨ç‡å‚è€ƒçš„å†å²æ—¶é—´é•¿åº¦\nè‡ªåŠ¨æ ¹æ®æ—¶é—´æ¡†æ¶è½¬æ¢ä¸ºKçº¿æ•°é‡")

grp_visual = "â•â•â• Visual Settings / è§†è§‰è®¾ç½® â•â•â•"
visual_line_mode = input.string("Unified", "Threshold Line Mode / é˜ˆå€¼çº¿æ¨¡å¼", options=["Unified", "Z-Score", "Percentile", "Both"], group=grp_visual, tooltip="Unified(æ¨è): Z-Scoreçº¿+ç™¾åˆ†ä½æ ‡æ³¨ï¼Œå…¼é¡¾ä¸¥è°¨æ€§å’Œç›´è§‚æ€§\nZ-Score: ä»…ç»Ÿè®¡å­¦é˜ˆå€¼çº¿(Â±2Ïƒ, Â±1.5Ïƒ)\nPercentile: ä»…ç™¾åˆ†ä½çº¿(P5-P95)\nBoth: åŒæ—¶æ˜¾ç¤ºä¸¤ç§")
show_fill = input.bool(true, "Show Gradient Fill / æ˜¾ç¤ºæ¸å˜å¡«å……", group=grp_visual)
show_dashboard = input.bool(true, "Show Dashboard / æ˜¾ç¤ºä»ªè¡¨ç›˜", group=grp_visual)
dashboard_mode = input.string("Full", "Dashboard Mode / é¢æ¿æ¨¡å¼", options=["Lite", "Full"], group=grp_visual, tooltip="Lite: ä»…æ ¸å¿ƒä¿¡æ¯(3è¡Œ) | Full: æ˜¾ç¤ºå…¨éƒ¨")
dashboard_size = input.string("Normal", "Dashboard Size / é¢æ¿å¤§å°", options=["Tiny", "Small", "Normal", "Large"], group=grp_visual)
dashboard_transparency = input.int(30, "Dashboard Transparency / é¢æ¿é€æ˜åº¦", minval=0, maxval=100, step=10, group=grp_visual)
color_bull = input.color(color.new(#00E676, 60), "Bullish Color / ç‰›å¸‚é¢œè‰²", group=grp_visual)
color_bear = input.color(color.new(#FF5252, 60), "Bearish Color / ç†Šå¸‚é¢œè‰²", group=grp_visual)
color_rsi = input.color(#FFEB3B, "RSI Line Color / RSIçº¿é¢œè‰²", group=grp_visual)

grp_alerts = "â•â•â• Alert Settings / è­¦æŠ¥è®¾ç½® â•â•â•"
enable_extreme_alerts = input.bool(true, "Extreme Alerts / æç«¯è­¦æŠ¥", group=grp_alerts, tooltip="è§¦å‘æ¡ä»¶: Z-Score Â±2Ïƒ\nç»Ÿè®¡æ„ä¹‰: 95%ç½®ä¿¡åŒºé—´å¤–\nå¯¹åº”ç™¾åˆ†ä½: â‰ˆ P2.3/P97.7\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nè½¬æ¢å¯¹ç…§:\n  Z=-2.5 â‰ˆ P0.6  | Z=+2.5 â‰ˆ P99.4\n  Z=-2.0 â‰ˆ P2.3  | Z=+2.0 â‰ˆ P97.7\n  Z=-1.5 â‰ˆ P6.7  | Z=+1.5 â‰ˆ P93.3\n  Z=-1.0 â‰ˆ P15.9 | Z=+1.0 â‰ˆ P84.1")
enable_normal_alerts = input.bool(false, "Normal Alerts / æ™®é€šè­¦æŠ¥", group=grp_alerts, tooltip="è§¦å‘æ¡ä»¶: è§ä¸‹æ–¹é˜ˆå€¼è®¾ç½®")
show_normal_signals = input.bool(false, "Show Normal Signals / æ˜¾ç¤ºæ™®é€šä¿¡å·", group=grp_alerts, tooltip="â¬†ï¸â¬‡ï¸ æ™®é€šè¶…ä¹°/è¶…å–ä¿¡å·ï¼Œé»˜è®¤å…³é—­")
normal_threshold = input.float(1.5, "Normal Signal Threshold / æ™®é€šä¿¡å·é˜ˆå€¼", minval=1.0, maxval=2.0, step=0.1, group=grp_alerts, tooltip="Z-Score é˜ˆå€¼\n1.5Ïƒ â‰ˆ P6.7/P93.3\n1.28Ïƒ â‰ˆ P10/P90")
enable_signal_cooldown = input.bool(true, "Enable Signal Cooldown / å¯ç”¨ä¿¡å·å†·å´", group=grp_alerts, tooltip="é˜²æ­¢åŒä¸€åŒºåŸŸé‡å¤ä¿¡å·æ±¡æŸ“ç»Ÿè®¡æ•°æ®")
cooldown_bars = input.int(5, "Cooldown Period (Bars) / å†·å´æœŸ(Kçº¿æ•°)", minval=1, maxval=20, group=grp_alerts, tooltip="åŒç±»ä¿¡å·è§¦å‘åçš„å†·å´æ—¶é—´")

grp_trend = "â•â•â• Trend Filter / è¶‹åŠ¿è¿‡æ»¤ â•â•â•"
enable_trend_filter = input.bool(false, "Enable Trend Filter / å¯ç”¨è¶‹åŠ¿è¿‡æ»¤", group=grp_trend, tooltip="ä»…åœ¨è¶‹åŠ¿æ–¹å‘è§¦å‘ä¿¡å·ï¼šä¸Šå‡è¶‹åŠ¿åªåšå¤šï¼Œä¸‹é™è¶‹åŠ¿åªåšç©º")
trend_filter_mode = input.string("Auto", "Filter Mode / è¿‡æ»¤æ¨¡å¼", options=["Auto", "Fixed 50", "Adaptive P50", "SMA(RSI)", "BB(RSI)"], group=grp_trend, tooltip="Auto: æ ¹æ®RSIæ³¢åŠ¨è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ¨¡å¼")

grp_mtf = "â•â•â• Multi-Timeframe / å¤šæ—¶é—´æ¡†æ¶ â•â•â•"
enable_mtf = input.bool(true, "Enable MTF RSI / å¯ç”¨å¤šæ—¶é—´æ¡†æ¶", group=grp_mtf)
mtf_tf1 = input.timeframe("60", "TF1 (é»˜è®¤1h) / æ—¶é—´æ¡†æ¶1", group=grp_mtf)
mtf_tf2 = input.timeframe("240", "TF2 (é»˜è®¤4h) / æ—¶é—´æ¡†æ¶2", group=grp_mtf)
mtf_tf3 = input.timeframe("D", "TF3 (é»˜è®¤D) / æ—¶é—´æ¡†æ¶3", group=grp_mtf)

grp_stats = "â•â•â• Signal Statistics / ä¿¡å·ç»Ÿè®¡ â•â•â•"
enable_stats = input.bool(true, "Enable Statistics / å¯ç”¨ç»Ÿè®¡", group=grp_stats)
stats_forward_bars = input.int(20, "Forward Bars / å‰ç»Kçº¿æ•°", minval=5, maxval=100, group=grp_stats, tooltip="ä¿¡å·è§¦å‘åå¤šå°‘æ ¹Kçº¿è®¡ç®—æ”¶ç›Š")

grp_divergence = "â•â•â• Divergence Settings / èƒŒç¦»è®¾ç½® â•â•â•"
enable_divergence = input.bool(true, "Enable Divergence Detection / å¯ç”¨èƒŒç¦»æ£€æµ‹", group=grp_divergence)
div_mode = input.string("Auto", "Divergence Mode / èƒŒç¦»æ¨¡å¼", options=["Auto", "Low Vol", "Normal", "High Vol", "Crypto", "Custom"], group=grp_divergence, tooltip="Auto: æ ¹æ®ATRè‡ªåŠ¨åˆ¤æ–­\nLow Vol: è“ç­¹/ETF\nNormal: ä¸€èˆ¬è‚¡ç¥¨\nHigh Vol: æˆé•¿/å°ç›˜\nCrypto: åŠ å¯†è´§å¸")
div_lookback_custom = input.int(5, "Custom Lookback / è‡ªå®šä¹‰å›çœ‹", minval=2, maxval=20, group=grp_divergence, tooltip="ä»…åœ¨ Custom æ¨¡å¼ä¸‹ä½¿ç”¨")
div_range_custom = input.int(60, "Custom Range / è‡ªå®šä¹‰èŒƒå›´", minval=20, maxval=200, group=grp_divergence, tooltip="ä»…åœ¨ Custom æ¨¡å¼ä¸‹ä½¿ç”¨")

// æ³¢åŠ¨æ€§æ£€æµ‹ (ç”¨äº Auto æ¨¡å¼)
// ä½¿ç”¨é•¿æœŸå¹³å‡æ³¢åŠ¨ç‡ç¡®ä¿æ¨¡å¼ç¨³å®š (simple int)
atr_20 = ta.atr(20)
avg_volatility = ta.sma(atr_20 / close * 100, 252)  // 252å‘¨æœŸå¹³å‡ç›¸å¯¹æ³¢åŠ¨ç‡

// æ ¹æ®é•¿æœŸå¹³å‡æ³¢åŠ¨ç‡åˆ¤æ–­æ ‡çš„ç±»å‹ (Auto æ¨¡å¼)
// ä½äº1%: ä½æ³¢åŠ¨ (è“ç­¹/ETF), 1-3%: æ­£å¸¸, 3-6%: é«˜æ³¢åŠ¨, è¶…è¿‡6%: åŠ å¯†è´§å¸çº§åˆ«
auto_vol_type = avg_volatility > 6 ? "Crypto" : avg_volatility > 3 ? "High Vol" : avg_volatility > 1 ? "Normal" : "Low Vol"

// å®é™…ä½¿ç”¨çš„æ¨¡å¼
active_div_mode = div_mode == "Auto" ? auto_vol_type : div_mode

// æ ¹æ®æ¨¡å¼è®¾ç½®å‚æ•° (é¢„è®¾å€¼)
// Low Vol: 3/40, Normal: 5/60, High Vol: 7/80, Crypto: 10/120
div_lookback = div_mode == "Custom" ? div_lookback_custom : active_div_mode == "Low Vol" ? 3 : active_div_mode == "Normal" ? 5 : active_div_mode == "High Vol" ? 7 : 10
div_range = div_mode == "Custom" ? div_range_custom : active_div_mode == "Low Vol" ? 40 : active_div_mode == "Normal" ? 60 : active_div_mode == "High Vol" ? 80 : 120

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ RSI CALCULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

rsi = ta.rsi(rsi_source, rsi_length)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ DYNAMIC LOOKBACK CALCULATION / åŠ¨æ€å›çœ‹å‘¨æœŸè®¡ç®—
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Step 1: Timeframe-normalized volatility periods
// æ ¹æ®æ—¶é—´æ¡†æ¶æ ‡å‡†åŒ–é•¿æœŸå‘¨æœŸï¼Œç¡®ä¿è¦†ç›–ç›¸åŒçš„æ—¶é—´è·¨åº¦
vol_short_period = rsi_length * 4  // çŸ­æœŸï¼š~56æ ¹Kçº¿ï¼ˆçº¦4ä¸ªRSIå‘¨æœŸï¼‰

// å°†å†å²æ·±åº¦é€‰é¡¹è½¬æ¢ä¸ºå¤©æ•°
vol_history_days = vol_history_mode == "6 Months" ? 126 : vol_history_mode == "1 Year" ? 252 : 504

// é•¿æœŸå‘¨æœŸæ ¹æ®æ—¶é—´æ¡†æ¶è°ƒæ•´ï¼ˆç›®æ ‡ï¼šè¦†ç›–ç›¸åŒå¤©æ•°ï¼‰
// æ—¥çº¿ç›´æ¥ç”¨ vol_history_daysï¼Œå…¶ä»–æ—¶é—´æ¡†æ¶æŒ‰Kçº¿/å¤©æ•°æ¢ç®—
bars_per_day = timeframe.isdaily or timeframe.isweekly or timeframe.ismonthly ? 1 :
               timeframe.period == "240" ? 6 :
               timeframe.period == "60" ? 24 :
               timeframe.isintraday and timeframe.multiplier <= 30 ? int(24 * 60 / timeframe.multiplier) : 96
vol_long_period = math.min(4500, vol_history_days * bars_per_day)  // ä¸Šé™4500ï¼ˆä¸max_bars_backåŒ¹é…ï¼‰

vol_short = nz(ta.stdev(rsi, vol_short_period), 10)  // è¿‘æœŸæ³¢åŠ¨
vol_long = nz(ta.stdev(rsi, vol_long_period), 10)    // é•¿æœŸæ³¢åŠ¨

// Step 2: Dynamic weighted combination
// åŠ¨æ€åŠ æƒç»„åˆï¼šä¸æ˜¯ç®€å•å–æœ€å¤§å€¼
// - åŸºç¡€ï¼š70%é•¿æœŸ + 30%è¿‘æœŸï¼ˆåå‘ç¨³å®šï¼‰
// - åŠ¨æ€è°ƒæ•´ï¼šå¦‚æœè¿‘æœŸ > é•¿æœŸï¼Œå¢åŠ è¿‘æœŸæƒé‡
vol_base = vol_long * 0.7 + vol_short * 0.3

// è¿‘æœŸæ³¢åŠ¨æ˜¾è‘—é«˜äºé•¿æœŸæ—¶ï¼ˆ>1.2å€ï¼‰ï¼ŒåŠ¨æ€åˆ‡æ¢åˆ°è¿‘æœŸä¸»å¯¼
recent_high = vol_short > vol_long * 1.2
vol_dynamic = recent_high ? (vol_short * 0.6 + vol_long * 0.4) : vol_base

// ç¡®ä¿ä¸ä½äºé•¿æœŸæ³¢åŠ¨ï¼ˆä¿å®ˆï¼‰
rsi_vol_bootstrap = math.max(vol_dynamic, vol_long * 0.8)

// Step 2: Statistical sample size formula: n = (Z Ã— Ïƒ / E)Â²
// ç»Ÿè®¡å­¦æ ·æœ¬é‡å…¬å¼ï¼šZ=1.96 (95%ç½®ä¿¡åº¦), E=5 (å¯æ¥å—è¯¯å·®)
// This is the THEORETICAL optimal lookback (for display/health check only)
stat_lookback = math.max(50, math.pow(1.96 * rsi_vol_bootstrap / 5, 2))

// Step 3: Use exact statistical formula n = (Z Ã— Ïƒ / E)Â²
// Z = 1.96 (95% confidence), Ïƒ = RSI stdev, E = acceptable error
// ä½¿ç”¨ç²¾ç¡®ç»Ÿè®¡å…¬å¼è®¡ç®—æ‰€éœ€æ ·æœ¬é‡
// E æ ¹æ®ç²¾åº¦è®¾ç½®ï¼šHigh=2.0, Normal=2.5, Low=3.5
stat_error = lookback_precision == "High" ? 2.0 : lookback_precision == "Normal" ? 2.5 : 3.5
stat_required = math.pow(1.96 * rsi_vol_bootstrap / stat_error, 2)

// Step 4: Apply limits (min 100, max 1000)
// è®¾ç½®åˆç†çš„ä¸Šä¸‹é™
auto_lookback = int(math.max(100, math.min(1000, stat_required)))

// Step 5: Apply mode selection
lookback = lookback_mode == "Custom" ? math.min(1000, lookback_custom) : auto_lookback

// Step 6: Health indicators / å¥åº·åº¦æŒ‡æ ‡
health_sample_coverage = bar_index >= lookback * 0.8  // æœ‰è¶³å¤Ÿå†å²æ•°æ®
health_stat_valid = lookback >= stat_required * 0.9   // å®é™…å€¼æ»¡è¶³ç»Ÿè®¡éœ€æ±‚

// Display values for dashboard
theoretical_lookback = int(math.max(100, math.min(2000, math.ceil(stat_lookback))))

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ ADAPTIVE PERCENTILE CALCULATION (Nearest Rank - More Accurate)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ä½¿ç”¨ percentile_nearest_rank è·å¾—æ›´ç²¾å‡†çš„åˆ†å¸ƒ (ä¿ç•™ç”¨äºè§†è§‰å‚è€ƒ)
rsi_p5  = ta.percentile_nearest_rank(rsi, lookback, 5)
rsi_p10 = ta.percentile_nearest_rank(rsi, lookback, 10)
rsi_p25 = ta.percentile_nearest_rank(rsi, lookback, 25)
rsi_p50 = ta.percentile_nearest_rank(rsi, lookback, 50)
rsi_p75 = ta.percentile_nearest_rank(rsi, lookback, 75)
rsi_p90 = ta.percentile_nearest_rank(rsi, lookback, 90)
rsi_p95 = ta.percentile_nearest_rank(rsi, lookback, 95)

// Health indicator: Distribution spread check / åˆ†å¸ƒå®½åº¦æ£€æŸ¥
health_distribution_spread = (rsi_p95 - rsi_p5) >= 15  // P95-P5 è‡³å°‘15ç‚¹

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ RSI Z-SCORE CALCULATION (ç»Ÿè®¡å­¦æ–¹æ³•)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Z-Score = (å½“å‰å€¼ - å¹³å‡å€¼) / æ ‡å‡†å·®
rsi_mean = ta.sma(rsi, lookback)
rsi_stdev = ta.stdev(rsi, lookback)
rsi_zscore = rsi_stdev != 0 ? (rsi - rsi_mean) / rsi_stdev : 0


// Z-Score åŠ¨æ€é˜ˆå€¼çº¿ (ç”¨äºç»˜å›¾)
zscore_upper_2 = rsi_mean + rsi_stdev * 2    // +2Ïƒ æç«¯è¶…ä¹°
zscore_upper_1_5 = rsi_mean + rsi_stdev * 1.5  // +1.5Ïƒ è¶…ä¹°
zscore_lower_1_5 = rsi_mean - rsi_stdev * 1.5  // -1.5Ïƒ è¶…å–
zscore_lower_2 = rsi_mean - rsi_stdev * 2    // -2Ïƒ æç«¯è¶…å–

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ Z-SCORE â†” PERCENTILE è½¬æ¢å·¥å…· / CONVERSION UTILITIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Z-Score â†’ è¿‘ä¼¼ç™¾åˆ†ä½ï¼ˆä½¿ç”¨æŸ¥æ‰¾è¡¨æ–¹æ³•ï¼‰
// Pine Script ä¸æ”¯æŒ math.erfï¼Œä½¿ç”¨æŸ¥æ‰¾è¡¨è¿‘ä¼¼
f_zscore_to_percentile(_zscore) =>
    // æŸ¥æ‰¾è¡¨ï¼šå¸¸è§ Z-Score å¯¹åº”çš„ç™¾åˆ†ä½
    _z = math.abs(_zscore)
    _pct = _z >= 3.0 ? 99.9 :
           _z >= 2.5 ? 99.4 :
           _z >= 2.0 ? 97.7 :
           _z >= 1.96 ? 97.5 :
           _z >= 1.5 ? 93.3 :
           _z >= 1.28 ? 90.0 :
           _z >= 1.0 ? 84.1 :
           _z >= 0.67 ? 75.0 :
           _z >= 0.5 ? 69.1 :
           _z >= 0.25 ? 59.9 : 50.0
    // æ ¹æ®æ­£è´Ÿè¿”å›å¯¹åº”ç™¾åˆ†ä½
    _zscore >= 0 ? _pct : 100 - _pct

// ç™¾åˆ†ä½èŒƒå›´ â†’ Z-ScoreåŒºé—´æ–‡æœ¬ï¼ˆç”¨äºDashboardæ˜¾ç¤ºï¼‰
f_percentile_zscore_range(_pct) =>
    _pct < 2.3 ? " (< âˆ’2Ïƒ)" : _pct <= 6.7 ? " (âˆ’1.5Ïƒ ~ âˆ’2Ïƒ)" : _pct <= 15.9 ? " (âˆ’1Ïƒ ~ âˆ’1.5Ïƒ)" : _pct >= 97.7 ? " (> +2Ïƒ)" : _pct >= 93.3 ? " (+1.5Ïƒ ~ +2Ïƒ)" : _pct >= 84.1 ? " (+1Ïƒ ~ +1.5Ïƒ)" : ""

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ TREND FILTER / è¶‹åŠ¿è¿‡æ»¤ (Auto-Adaptive)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// è®¡ç®—å„ç§è¿‡æ»¤åŸºå‡†çº¿
rsi_sma = ta.sma(rsi, 20)
rsi_bb_basis = ta.sma(rsi, 20)  // BB(RSI) ä¸­è½¨

// RSI æ³¢åŠ¨ç‡æ£€æµ‹ (ç”¨äºè‡ªåŠ¨æ¨¡å¼é€‰æ‹©)
rsi_volatility = ta.stdev(rsi, 50)

// è®¡ç®—æ³¢åŠ¨ç‡çš„å†å²åˆ†ä½æ•° (è‡ªé€‚åº”é˜ˆå€¼)
rsi_vol_p25 = ta.percentile_nearest_rank(rsi_volatility, 100, 25)  // ä½æ³¢åŠ¨é˜ˆå€¼
rsi_vol_p75 = ta.percentile_nearest_rank(rsi_volatility, 100, 75)  // é«˜æ³¢åŠ¨é˜ˆå€¼

// è‡ªåŠ¨æ¨¡å¼é€‰æ‹©é€»è¾‘ (å®Œå…¨è‡ªé€‚åº”):
// - ä½æ³¢åŠ¨ (< P25): Fixed 50 è¶³å¤Ÿç¨³å®š
// - ä¸­æ³¢åŠ¨ (P25-P75): Adaptive P50 é€‚åº”æ€§æ›´å¥½  
// - é«˜æ³¢åŠ¨ (> P75): BB(RSI) æ›´èƒ½å¤„ç†å‰§çƒˆæ³¢åŠ¨
auto_selected_mode = rsi_volatility < rsi_vol_p25 ? "Fixed 50" :
                     rsi_volatility > rsi_vol_p75 ? "BB(RSI)" : "Adaptive P50"

// å®é™…ä½¿ç”¨çš„æ¨¡å¼
active_mode = trend_filter_mode == "Auto" ? auto_selected_mode : trend_filter_mode

// æ ¹æ®æ´»åŠ¨æ¨¡å¼è®¡ç®—è¶‹åŠ¿æ–¹å‘
trend_up = active_mode == "Fixed 50" ? rsi > 50 :
           active_mode == "Adaptive P50" ? rsi > rsi_p50 :
           active_mode == "SMA(RSI)" ? rsi > rsi_sma :
           rsi > rsi_bb_basis  // BB(RSI)
trend_down = not trend_up

// æ˜¾ç¤ºæ–‡æœ¬ (åŒ…å«ä½¿ç”¨çš„æ¨¡å¼)
trend_mode_display = trend_filter_mode == "Auto" ? "[" + auto_selected_mode + "]" : ""
trend_text = trend_up ? "â†‘ UP " + trend_mode_display : "â†“ DOWN " + trend_mode_display
trend_color = trend_up ? color_bull : color_bear

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ MULTI-TIMEFRAME RSI / å¤šæ—¶é—´æ¡†æ¶RSI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// MTF RSI è®¡ç®—
f_rsi_mtf(_tf) =>
    request.security(syminfo.tickerid, _tf, rsi, lookahead=barmerge.lookahead_off)

f_percentiles_mtf(_tf) =>
    [request.security(syminfo.tickerid, _tf, rsi_p10, lookahead=barmerge.lookahead_off),
     request.security(syminfo.tickerid, _tf, rsi_p90, lookahead=barmerge.lookahead_off)]

rsi_tf1 = enable_mtf ? f_rsi_mtf(mtf_tf1) : na
rsi_tf2 = enable_mtf ? f_rsi_mtf(mtf_tf2) : na
rsi_tf3 = enable_mtf ? f_rsi_mtf(mtf_tf3) : na

// MTF percentiles - éœ€è¦åˆ†å¼€å¤„ç†å› ä¸º Pine Script ä¸æ”¯æŒä¸‰å…ƒæ“ä½œç¬¦è¿”å›å…ƒç»„
[p10_tf1_raw, p90_tf1_raw] = f_percentiles_mtf(mtf_tf1)
[p10_tf2_raw, p90_tf2_raw] = f_percentiles_mtf(mtf_tf2)
[p10_tf3_raw, p90_tf3_raw] = f_percentiles_mtf(mtf_tf3)

p10_tf1 = enable_mtf ? p10_tf1_raw : na
p90_tf1 = enable_mtf ? p90_tf1_raw : na
p10_tf2 = enable_mtf ? p10_tf2_raw : na
p90_tf2 = enable_mtf ? p90_tf2_raw : na
p10_tf3 = enable_mtf ? p10_tf3_raw : na
p90_tf3 = enable_mtf ? p90_tf3_raw : na

// è®¡ç®—å„æ—¶é—´æ¡†æ¶çŠ¶æ€
f_status(_rsi, _p10, _p90) =>
    _rsi < _p10 ? 1 : _rsi > _p90 ? -1 : 0  // 1=oversold, -1=overbought, 0=neutral

// æ—¶é—´æ¡†æ¶æ ¼å¼åŒ–å‡½æ•° (ç»Ÿä¸€æ˜¾ç¤ºä¸º 1h/4h/D ç­‰æ ¼å¼)
f_tf_display(_tf) =>
    switch _tf
        "1" => "1m"
        "3" => "3m"
        "5" => "5m"
        "15" => "15m"
        "30" => "30m"
        "45" => "45m"
        "60" => "1h"
        "120" => "2h"
        "180" => "3h"
        "240" => "4h"
        "360" => "6h"
        "480" => "8h"
        "720" => "12h"
        "D" => "D"
        "1D" => "D"
        "W" => "W"
        "1W" => "W"
        "M" => "M"
        "1M" => "M"
        => _tf

// æ ¼å¼åŒ–åçš„æ—¶é—´æ¡†æ¶æ˜¾ç¤º
mtf_tf1_display = f_tf_display(mtf_tf1)
mtf_tf2_display = f_tf_display(mtf_tf2)
mtf_tf3_display = f_tf_display(mtf_tf3)
current_tf_display = f_tf_display(timeframe.period)

status_tf1 = f_status(rsi_tf1, p10_tf1, p90_tf1)
status_tf2 = f_status(rsi_tf2, p10_tf2, p90_tf2)
status_tf3 = f_status(rsi_tf3, p10_tf3, p90_tf3)
status_current = f_status(rsi, rsi_p10, rsi_p90)

// å…±æŒ¯æ£€æµ‹ (è·³è¿‡ä¸å½“å‰å›¾è¡¨é‡å¤çš„æ—¶é—´æ¡†æ¶)
// æ¯”è¾ƒæ ¼å¼åŒ–åçš„æ—¶é—´æ¡†æ¶ï¼Œé¿å… "60" vs "1h" çš„é—®é¢˜
tf1_is_current = mtf_tf1_display == current_tf_display
tf2_is_current = mtf_tf2_display == current_tf_display
tf3_is_current = mtf_tf3_display == current_tf_display

// è®¡ç®—æœ‰æ•ˆçš„æ—¶é—´æ¡†æ¶æ•°é‡ (ä¸åŒ…æ‹¬å½“å‰å›¾è¡¨é‡å¤çš„)
valid_tf_count = 1 + (tf1_is_current ? 0 : 1) + (tf2_is_current ? 0 : 1) + (tf3_is_current ? 0 : 1)

// è¶…å–/è¶…ä¹°è®¡æ•° (è·³è¿‡é‡å¤çš„æ—¶é—´æ¡†æ¶)
oversold_count = (status_current == 1 ? 1 : 0) + 
                 (not tf1_is_current and status_tf1 == 1 ? 1 : 0) + 
                 (not tf2_is_current and status_tf2 == 1 ? 1 : 0) + 
                 (not tf3_is_current and status_tf3 == 1 ? 1 : 0)
overbought_count = (status_current == -1 ? 1 : 0) + 
                   (not tf1_is_current and status_tf1 == -1 ? 1 : 0) + 
                   (not tf2_is_current and status_tf2 == -1 ? 1 : 0) + 
                   (not tf3_is_current and status_tf3 == -1 ? 1 : 0)

// å…±æŒ¯æ¡ä»¶: è‡³å°‘ 3/4 æˆ–è€…æ‰€æœ‰æœ‰æ•ˆæ—¶é—´æ¡†æ¶éƒ½å¤„äºåŒä¸€çŠ¶æ€
oversold_resonance = oversold_count >= 3 or (valid_tf_count <= 3 and oversold_count == valid_tf_count)
overbought_resonance = overbought_count >= 3 or (valid_tf_count <= 3 and overbought_count == valid_tf_count)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL STATISTICS / ä¿¡å·ç»Ÿè®¡ (åˆ†å±‚ç»Ÿè®¡)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ğŸŒŸ MTF å…±æŒ¯ä¿¡å·ç»Ÿè®¡ (æœ€å¼º)
var int mtf_buy_count = 0
var float mtf_buy_return = 0.0
var int mtf_buy_wins = 0
var int mtf_sell_count = 0
var float mtf_sell_return = 0.0
var int mtf_sell_wins = 0

// ğŸ’ èƒŒç¦»+æç«¯ä¿¡å·ç»Ÿè®¡ (å¼º)
var int div_buy_count = 0
var float div_buy_return = 0.0
var int div_buy_wins = 0
var int div_sell_count = 0
var float div_sell_return = 0.0
var int div_sell_wins = 0

// ğŸ”¥ æç«¯ä¿¡å·ç»Ÿè®¡ (åŸºç¡€)
var int ext_buy_count = 0
var float ext_buy_return = 0.0
var int ext_buy_wins = 0
var int ext_sell_count = 0
var float ext_sell_return = 0.0
var int ext_sell_wins = 0

// â¬†ï¸â¬‡ï¸ æ™®é€šä¿¡å·ç»Ÿè®¡ (å¼±)
var int norm_buy_count = 0
var float norm_buy_return = 0.0
var int norm_buy_wins = 0
var int norm_sell_count = 0
var float norm_sell_return = 0.0
var int norm_sell_wins = 0

// å¹³å‡æ”¶ç›Šå’Œèƒœç‡è®¡ç®— (å£°æ˜å˜é‡ï¼Œç¨ååœ¨ä¿¡å·å®šä¹‰åè®¡ç®—)
var float mtf_buy_avg = 0.0
var float mtf_sell_avg = 0.0
var float div_buy_avg = 0.0
var float div_sell_avg = 0.0
var float ext_buy_avg = 0.0
var float ext_sell_avg = 0.0
var float norm_buy_avg = 0.0
var float norm_sell_avg = 0.0
var float mtf_buy_winrate = 0.0
var float mtf_sell_winrate = 0.0
var float div_buy_winrate = 0.0
var float div_sell_winrate = 0.0
var float ext_buy_winrate = 0.0
var float ext_sell_winrate = 0.0
var float norm_buy_winrate = 0.0
var float norm_sell_winrate = 0.0


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ DIVERGENCE DETECTION / èƒŒç¦»æ£€æµ‹
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Pivot æ£€æµ‹
price_pivot_low = ta.pivotlow(low, div_lookback, div_lookback)
price_pivot_high = ta.pivothigh(high, div_lookback, div_lookback)
rsi_pivot_low = ta.pivotlow(rsi, div_lookback, div_lookback)
rsi_pivot_high = ta.pivothigh(rsi, div_lookback, div_lookback)

// å­˜å‚¨ä¸Šä¸€ä¸ª Pivot ç‚¹
var float prev_price_low = na
var float prev_rsi_low = na
var int prev_low_bar = na
var float prev_price_high = na
var float prev_rsi_high = na
var int prev_high_bar = na

// èƒŒç¦»ä¿¡å·
var bool bullish_divergence = false
var bool bearish_divergence = false

if enable_divergence
    // æ£€æµ‹æ–°çš„ä½ç‚¹
    if not na(price_pivot_low) and not na(rsi_pivot_low)
        current_bar = bar_index - div_lookback
        if not na(prev_price_low) and not na(prev_rsi_low)
            bars_since = current_bar - prev_low_bar
            // çœ‹æ¶¨èƒŒç¦»: ä»·æ ¼åˆ›æ–°ä½ï¼ŒRSIæœªåˆ›æ–°ä½
            if bars_since <= div_range and low[div_lookback] < prev_price_low and rsi[div_lookback] > prev_rsi_low
                bullish_divergence := true
            else
                bullish_divergence := false
        else
            bullish_divergence := false
        prev_price_low := low[div_lookback]
        prev_rsi_low := rsi[div_lookback]
        prev_low_bar := current_bar
    else
        bullish_divergence := false
    
    // æ£€æµ‹æ–°çš„é«˜ç‚¹
    if not na(price_pivot_high) and not na(rsi_pivot_high)
        current_bar = bar_index - div_lookback
        if not na(prev_price_high) and not na(prev_rsi_high)
            bars_since = current_bar - prev_high_bar
            // çœ‹è·ŒèƒŒç¦»: ä»·æ ¼åˆ›æ–°é«˜ï¼ŒRSIæœªåˆ›æ–°é«˜
            if bars_since <= div_range and high[div_lookback] > prev_price_high and rsi[div_lookback] < prev_rsi_high
                bearish_divergence := true
            else
                bearish_divergence := false
        else
            bearish_divergence := false
        prev_price_high := high[div_lookback]
        prev_rsi_high := rsi[div_lookback]
        prev_high_bar := current_bar
    else
        bearish_divergence := false

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ VISUAL PLOTTING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æ ¹æ®ç”¨æˆ·é€‰æ‹©å†³å®šæ˜¾ç¤ºå“ªç§é˜ˆå€¼çº¿
show_unified = visual_line_mode == "Unified"
show_zscore_lines = visual_line_mode == "Z-Score" or visual_line_mode == "Both"
show_percentile_lines = visual_line_mode == "Percentile" or visual_line_mode == "Both"

// Unifiedæ¨¡å¼ï¼šZ-Scoreçº¿ä¸Šç›´æ¥æ ‡æ³¨å¯¹åº”ç™¾åˆ†ä½ï¼ˆä½¿ç”¨æ¡ä»¶è¡¨è¾¾å¼è€Œéifå—ï¼‰
plot(show_unified ? zscore_upper_2 : na, "Â±2Ïƒ (â‰ˆP98)", color=color.new(color_bear, 50), linewidth=2, style=plot.style_line)
plot(show_unified ? zscore_upper_1_5 : na, "Â±1.5Ïƒ (â‰ˆP93)", color=color.new(color_bear, 60), linewidth=1, style=plot.style_circles)
plot(show_unified ? zscore_lower_1_5 : na, "Â±1.5Ïƒ (â‰ˆP7)", color=color.new(color_bull, 60), linewidth=1, style=plot.style_circles)
plot(show_unified ? zscore_lower_2 : na, "Â±2Ïƒ (â‰ˆP2)", color=color.new(color_bull, 50), linewidth=2, style=plot.style_line)

// Z-Score é˜ˆå€¼çº¿ (ç»Ÿè®¡å­¦æ ‡å‡† - ä»…åœ¨Z-Score/Bothæ¨¡å¼ä¸‹æ˜¾ç¤º)
zscore_extreme_color = show_zscore_lines ? (visual_line_mode == "Both" ? 50 : 70) : 100
zscore_normal_color = show_zscore_lines ? (visual_line_mode == "Both" ? 60 : 80) : 100

plot(show_zscore_lines ? zscore_upper_2 : na, "Â±2Ïƒ æç«¯è¶…ä¹°", color=color.new(color_bear, zscore_extreme_color), linewidth=2, style=plot.style_line)
plot(show_zscore_lines ? zscore_upper_1_5 : na, "Â±1.5Ïƒ è¶…ä¹°", color=color.new(color_bear, zscore_normal_color), linewidth=1, style=plot.style_circles)
plot(show_zscore_lines ? zscore_lower_1_5 : na, "Â±1.5Ïƒ è¶…å–", color=color.new(color_bull, zscore_normal_color), linewidth=1, style=plot.style_circles)
plot(show_zscore_lines ? zscore_lower_2 : na, "Â±2Ïƒ æç«¯è¶…å–", color=color.new(color_bull, zscore_extreme_color), linewidth=2, style=plot.style_line)

// ç™¾åˆ†ä½çº¿ (ä½œä¸ºè¾…åŠ©å‚è€ƒ)
// æ³¨æ„ï¼šåœ¨Unifiedå’ŒZ-Scoreæ¨¡å¼ä¸‹ï¼Œç™¾åˆ†ä½çº¿è®¾ä¸ºé€æ˜ï¼ˆä»…ç”¨äºæ¸å˜å¡«å……ï¼‰
percentile_line_transparency = show_percentile_lines ? (visual_line_mode == "Both" ? 85 : 70) : 100  // Unified/Z-Scoreæ¨¡å¼ä¸‹100%é€æ˜

p95_line = plot(rsi_p95, "P95 æç«¯è¶…ä¹°", color=color.new(color_bear, percentile_line_transparency), linewidth=1)
p90_line = plot(rsi_p90, "P90 è¶…ä¹°", color=color.new(color_bear, percentile_line_transparency), linewidth=1, style=plot.style_circles)
p75_line = plot(rsi_p75, "P75", color=color.new(color.gray, percentile_line_transparency), linewidth=1)
p50_line = plot(rsi_p50, "P50 ä¸­ä½æ•°", color=color.new(color.white, 50), linewidth=2, style=plot.style_stepline)  // P50 å§‹ç»ˆæ˜¾ç¤º
p25_line = plot(rsi_p25, "P25", color=color.new(color.gray, percentile_line_transparency), linewidth=1)
p10_line = plot(rsi_p10, "P10 è¶…å–", color=color.new(color_bull, percentile_line_transparency), linewidth=1, style=plot.style_circles)
p5_line  = plot(rsi_p5, "P5 æç«¯è¶…å–", color=color.new(color_bull, percentile_line_transparency), linewidth=1)

// RSI ä¸»çº¿
rsi_line = plot(rsi, "RSI", color=color_rsi, linewidth=2)

// æ¸å˜å¡«å…… - ç‹¬ç«‹æ§åˆ¶ï¼Œä¸å—é˜ˆå€¼çº¿æ¨¡å¼å½±å“
// ä¸ŠåŠéƒ¨åˆ†æ¸å˜ (ç†Šå¸‚åŒºåŸŸ)
fill(p95_line, p90_line, color=show_fill ? color.new(color_bear, 75) : na, title="æç«¯è¶…ä¹°åŒº")
fill(p90_line, p75_line, color=show_fill ? color.new(color_bear, 88) : na, title="è¶…ä¹°åŒº")
fill(p75_line, p50_line, color=show_fill ? color.new(color_bear, 95) : na, title="åå¼ºåŒº")

// ä¸‹åŠéƒ¨åˆ†æ¸å˜ (ç‰›å¸‚åŒºåŸŸ)
fill(p50_line, p25_line, color=show_fill ? color.new(color_bull, 95) : na, title="åå¼±åŒº")
fill(p25_line, p10_line, color=show_fill ? color.new(color_bull, 88) : na, title="è¶…å–åŒº")
fill(p10_line, p5_line, color=show_fill ? color.new(color_bull, 75) : na, title="æç«¯è¶…å–åŒº")

// å›ºå®šè¾¹ç•Œå‚è€ƒçº¿
hline(0, "0", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(100, "100", color=color.new(color.gray, 80), linestyle=hline.style_dotted)
hline(50, "50 å›ºå®šä¸­çº¿", color=color.new(color.gray, 90), linestyle=hline.style_dotted)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL DETECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// åŸºç¡€ä¿¡å· - ä½¿ç”¨ Z-Score åˆ¤æ–­æç«¯åŒºåŸŸ
// æç«¯ä¿¡å·: Z-Score Â±2Ïƒ (ç»Ÿè®¡å­¦ä¸Šçº¦ 95% ç½®ä¿¡åŒºé—´å¤–ï¼ŒP2.3/P97.7)
// æ™®é€šä¿¡å·: ä½¿ç”¨ç”¨æˆ·é…ç½®çš„ normal_threshold (é»˜è®¤ Â±1.5Ïƒï¼Œçº¦ P6.7/P93.3)
raw_extreme_oversold = ta.crossunder(rsi_zscore, -2)
raw_extreme_overbought = ta.crossover(rsi_zscore, 2)
raw_normal_oversold = ta.crossunder(rsi_zscore, -normal_threshold) and not raw_extreme_oversold
raw_normal_overbought = ta.crossover(rsi_zscore, normal_threshold) and not raw_extreme_overbought

// åº”ç”¨è¶‹åŠ¿è¿‡æ»¤
extreme_oversold = enable_trend_filter ? (raw_extreme_oversold and trend_down) : raw_extreme_oversold
extreme_overbought = enable_trend_filter ? (raw_extreme_overbought and trend_up) : raw_extreme_overbought
normal_oversold = enable_trend_filter ? (raw_normal_oversold and trend_down) : raw_normal_oversold
normal_overbought = enable_trend_filter ? (raw_normal_overbought and trend_up) : raw_normal_overbought

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL COOLDOWN MECHANISM / ä¿¡å·å†·å´æœºåˆ¶
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// å†·å´æœŸè·Ÿè¸ªå˜é‡ï¼ˆè®°å½•æ¯ç±»ä¿¡å·æœ€åè§¦å‘çš„ bar_indexï¼‰
var int last_mtf_buy_bar = na
var int last_mtf_sell_bar = na
var int last_div_buy_bar = na
var int last_div_sell_bar = na
var int last_ext_buy_bar = na
var int last_ext_sell_bar = na
var int last_norm_buy_bar = na
var int last_norm_sell_bar = na

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ CONSOLIDATED SIGNALS (ä¼˜å…ˆçº§åˆå¹¶ä¿¡å·)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æç«¯åŒºåŸŸåˆ¤æ–­ - å½“å‰Kçº¿ (ä½¿ç”¨ Z-Score)
bool in_extreme_oversold = rsi_zscore < -2
bool in_extreme_overbought = rsi_zscore > 2

// æç«¯åŒºåŸŸåˆ¤æ–­ - èƒŒç¦»å‘ç”Ÿæ—¶ (div_lookback æ ¹Kçº¿å‰)
float zscore_at_div = rsi_stdev[div_lookback] != 0 ? (rsi[div_lookback] - rsi_mean[div_lookback]) / rsi_stdev[div_lookback] : 0
bool was_extreme_oversold = zscore_at_div < -2
bool was_extreme_overbought = zscore_at_div > 2

// åŸå§‹ä¿¡å·ï¼ˆæœªå»é‡ï¼‰
bool raw_sig_buy_mtf = enable_mtf and oversold_resonance and extreme_oversold
bool raw_sig_buy_div = enable_divergence and bullish_divergence and was_extreme_oversold and not raw_sig_buy_mtf
bool raw_sig_buy_extreme = extreme_oversold and not raw_sig_buy_mtf and not raw_sig_buy_div
bool raw_sig_buy_normal = normal_oversold and not raw_sig_buy_mtf and not raw_sig_buy_div and not raw_sig_buy_extreme

bool raw_sig_sell_mtf = enable_mtf and overbought_resonance and extreme_overbought
bool raw_sig_sell_div = enable_divergence and bearish_divergence and was_extreme_overbought and not raw_sig_sell_mtf
bool raw_sig_sell_extreme = extreme_overbought and not raw_sig_sell_mtf and not raw_sig_sell_div
bool raw_sig_sell_normal = normal_overbought and not raw_sig_sell_mtf and not raw_sig_sell_div and not raw_sig_sell_extreme

// åº”ç”¨å†·å´æœŸï¼ˆä»…å½“å¯ç”¨æ—¶ï¼‰
bool sig_buy_mtf = enable_signal_cooldown ? (raw_sig_buy_mtf and (na(last_mtf_buy_bar) or bar_index - last_mtf_buy_bar >= cooldown_bars)) : raw_sig_buy_mtf
bool sig_buy_div = enable_signal_cooldown ? (raw_sig_buy_div and (na(last_div_buy_bar) or bar_index - last_div_buy_bar >= cooldown_bars)) : raw_sig_buy_div
bool sig_buy_extreme = enable_signal_cooldown ? (raw_sig_buy_extreme and (na(last_ext_buy_bar) or bar_index - last_ext_buy_bar >= cooldown_bars)) : raw_sig_buy_extreme
bool sig_buy_normal = enable_signal_cooldown ? (raw_sig_buy_normal and (na(last_norm_buy_bar) or bar_index - last_norm_buy_bar >= cooldown_bars)) : raw_sig_buy_normal

bool sig_sell_mtf = enable_signal_cooldown ? (raw_sig_sell_mtf and (na(last_mtf_sell_bar) or bar_index - last_mtf_sell_bar >= cooldown_bars)) : raw_sig_sell_mtf
bool sig_sell_div = enable_signal_cooldown ? (raw_sig_sell_div and (na(last_div_sell_bar) or bar_index - last_div_sell_bar >= cooldown_bars)) : raw_sig_sell_div
bool sig_sell_extreme = enable_signal_cooldown ? (raw_sig_sell_extreme and (na(last_ext_sell_bar) or bar_index - last_ext_sell_bar >= cooldown_bars)) : raw_sig_sell_extreme
bool sig_sell_normal = enable_signal_cooldown ? (raw_sig_sell_normal and (na(last_norm_sell_bar) or bar_index - last_norm_sell_bar >= cooldown_bars)) : raw_sig_sell_normal

// æ›´æ–°å†·å´æœŸè®¡æ•°å™¨
if sig_buy_mtf
    last_mtf_buy_bar := bar_index
if sig_buy_div
    last_div_buy_bar := bar_index
if sig_buy_extreme
    last_ext_buy_bar := bar_index
if sig_buy_normal
    last_norm_buy_bar := bar_index

if sig_sell_mtf
    last_mtf_sell_bar := bar_index
if sig_sell_div
    last_div_sell_bar := bar_index
if sig_sell_extreme
    last_ext_sell_bar := bar_index
if sig_sell_normal
    last_norm_sell_bar := bar_index

// èƒŒç¦»å•ç‹¬æ˜¾ç¤º (èƒŒç¦»æ—¶ä¸åœ¨æç«¯åŒºåŸŸ)
bool sig_div_bull_only = enable_divergence and bullish_divergence and not was_extreme_oversold
bool sig_div_bear_only = enable_divergence and bearish_divergence and not was_extreme_overbought

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ STATISTICS CALCULATION (ä½¿ç”¨å®é™…è§¦å‘çš„ä¿¡å·)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

if enable_stats and bar_index > stats_forward_bars
    forward_return_long = (close - close[stats_forward_bars]) / close[stats_forward_bars] * 100
    forward_return_short = (close[stats_forward_bars] - close) / close[stats_forward_bars] * 100
    
    // ğŸŒŸ MTF å…±æŒ¯ä¹°å…¥
    if sig_buy_mtf[stats_forward_bars]
        mtf_buy_count := mtf_buy_count + 1
        mtf_buy_return := mtf_buy_return + forward_return_long
        if forward_return_long > 0
            mtf_buy_wins := mtf_buy_wins + 1
    
    // ğŸŒŸ MTF å…±æŒ¯å–å‡º
    if sig_sell_mtf[stats_forward_bars]
        mtf_sell_count := mtf_sell_count + 1
        mtf_sell_return := mtf_sell_return + forward_return_short
        if forward_return_short > 0
            mtf_sell_wins := mtf_sell_wins + 1
    
    // ğŸ’ èƒŒç¦»+æç«¯ä¹°å…¥
    if sig_buy_div[stats_forward_bars]
        div_buy_count := div_buy_count + 1
        div_buy_return := div_buy_return + forward_return_long
        if forward_return_long > 0
            div_buy_wins := div_buy_wins + 1
    
    // ğŸ’ èƒŒç¦»+æç«¯å–å‡º
    if sig_sell_div[stats_forward_bars]
        div_sell_count := div_sell_count + 1
        div_sell_return := div_sell_return + forward_return_short
        if forward_return_short > 0
            div_sell_wins := div_sell_wins + 1
    
    // ğŸ”¥ æç«¯ä¹°å…¥
    if sig_buy_extreme[stats_forward_bars]
        ext_buy_count := ext_buy_count + 1
        ext_buy_return := ext_buy_return + forward_return_long
        if forward_return_long > 0
            ext_buy_wins := ext_buy_wins + 1
    
    // ğŸ”¥ æç«¯å–å‡º
    if sig_sell_extreme[stats_forward_bars]
        ext_sell_count := ext_sell_count + 1
        ext_sell_return := ext_sell_return + forward_return_short
        if forward_return_short > 0
            ext_sell_wins := ext_sell_wins + 1
    
    // â¬†ï¸ æ™®é€šä¹°å…¥
    if sig_buy_normal[stats_forward_bars]
        norm_buy_count := norm_buy_count + 1
        norm_buy_return := norm_buy_return + forward_return_long
        if forward_return_long > 0
            norm_buy_wins := norm_buy_wins + 1
    
    // â¬‡ï¸ æ™®é€šå–å‡º
    if sig_sell_normal[stats_forward_bars]
        norm_sell_count := norm_sell_count + 1
        norm_sell_return := norm_sell_return + forward_return_short
        if forward_return_short > 0
            norm_sell_wins := norm_sell_wins + 1

// è®¡ç®—å¹³å‡æ”¶ç›Šå’Œèƒœç‡
mtf_buy_avg := mtf_buy_count > 0 ? mtf_buy_return / mtf_buy_count : 0.0
mtf_sell_avg := mtf_sell_count > 0 ? mtf_sell_return / mtf_sell_count : 0.0
div_buy_avg := div_buy_count > 0 ? div_buy_return / div_buy_count : 0.0
div_sell_avg := div_sell_count > 0 ? div_sell_return / div_sell_count : 0.0
ext_buy_avg := ext_buy_count > 0 ? ext_buy_return / ext_buy_count : 0.0
ext_sell_avg := ext_sell_count > 0 ? ext_sell_return / ext_sell_count : 0.0
norm_buy_avg := norm_buy_count > 0 ? norm_buy_return / norm_buy_count : 0.0
norm_sell_avg := norm_sell_count > 0 ? norm_sell_return / norm_sell_count : 0.0

mtf_buy_winrate := mtf_buy_count > 0 ? mtf_buy_wins / mtf_buy_count * 100 : 0.0
mtf_sell_winrate := mtf_sell_count > 0 ? mtf_sell_wins / mtf_sell_count * 100 : 0.0
div_buy_winrate := div_buy_count > 0 ? div_buy_wins / div_buy_count * 100 : 0.0
div_sell_winrate := div_sell_count > 0 ? div_sell_wins / div_sell_count * 100 : 0.0
ext_buy_winrate := ext_buy_count > 0 ? ext_buy_wins / ext_buy_count * 100 : 0.0
ext_sell_winrate := ext_sell_count > 0 ? ext_sell_wins / ext_sell_count * 100 : 0.0
norm_buy_winrate := norm_buy_count > 0 ? norm_buy_wins / norm_buy_count * 100 : 0.0
norm_sell_winrate := norm_sell_count > 0 ? norm_sell_wins / norm_sell_count * 100 : 0.0


// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ SIGNAL DISPLAY (ä¿¡å·æ˜¾ç¤º)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ä¹°å…¥ä¿¡å· (åº•éƒ¨)
plotshape(sig_buy_mtf, title="ğŸŒŸ MTF+æç«¯è¶…å–", style=shape.labelup, location=location.bottom, color=#00E676, size=size.normal, text="ğŸŒŸ", textcolor=color.white)
plotshape(sig_buy_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…å–", style=shape.labelup, location=location.bottom, color=#00BCD4, size=size.normal, text="ğŸ’", textcolor=color.white)
plotshape(sig_buy_extreme, title="ğŸ”¥ æç«¯è¶…å–", style=shape.triangleup, location=location.bottom, color=color_bull, size=size.small, text="ğŸ”¥")
plotshape(show_normal_signals and sig_buy_normal, title="â¬†ï¸ æ™®é€šè¶…å–", style=shape.circle, location=location.bottom, color=color.new(color_bull, 30), size=size.tiny, text="â¬†ï¸")

// å–å‡ºä¿¡å· (é¡¶éƒ¨)
plotshape(sig_sell_mtf, title="ğŸŒŸ MTF+æç«¯è¶…ä¹°", style=shape.labeldown, location=location.top, color=#FF5252, size=size.normal, text="ğŸŒŸ", textcolor=color.white)
plotshape(sig_sell_div, title="ğŸ’ èƒŒç¦»+æç«¯è¶…ä¹°", style=shape.labeldown, location=location.top, color=#FF9800, size=size.normal, text="ğŸ’", textcolor=color.white)
plotshape(sig_sell_extreme, title="â„ï¸ æç«¯è¶…ä¹°", style=shape.triangledown, location=location.top, color=color_bear, size=size.small, text="â„ï¸")
plotshape(show_normal_signals and sig_sell_normal, title="â¬‡ï¸ æ™®é€šè¶…ä¹°", style=shape.circle, location=location.top, color=color.new(color_bear, 30), size=size.tiny, text="â¬‡ï¸")

// èƒŒç¦»å•ç‹¬æ ‡è®° (ä¿¡å·å·²åœ¨ pivot ç¡®è®¤æ—¶è§¦å‘ï¼Œæ— éœ€é¢å¤– offset)
plotshape(sig_div_bull_only, title="â†—ï¸ çœ‹æ¶¨èƒŒç¦»", style=shape.circle, location=location.bottom, color=#00BCD4, size=size.tiny, text="â†—ï¸")
plotshape(sig_div_bear_only, title="â†˜ï¸ çœ‹è·ŒèƒŒç¦»", style=shape.circle, location=location.top, color=#FF9800, size=size.tiny, text="â†˜ï¸")

// èƒŒæ™¯è‰²é«˜äº®
bgcolor(rsi < rsi_p5 ? color.new(color_bull, 90) : rsi > rsi_p95 ? color.new(color_bear, 90) : na, title="æç«¯åŒºèƒŒæ™¯")

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// MTF çŠ¶æ€è½¬æ–‡å­— (å®šä¹‰åœ¨ if å—å¤–éƒ¨)
f_status_text(_status) =>
    _status == 1 ? "ğŸŸ¢" : _status == -1 ? "ğŸ”´" : "âšª"

if show_dashboard
    // è®¡ç®—å½“å‰RSIåœ¨åˆ†å¸ƒä¸­çš„ä½ç½®
    rsi_percentile = 0.0
    if rsi <= rsi_p5
        rsi_percentile := 5.0
    else if rsi <= rsi_p10
        rsi_percentile := 10.0
    else if rsi <= rsi_p25
        rsi_percentile := 25.0
    else if rsi <= rsi_p50
        rsi_percentile := 50.0
    else if rsi <= rsi_p75
        rsi_percentile := 75.0
    else if rsi <= rsi_p90
        rsi_percentile := 90.0
    else if rsi <= rsi_p95
        rsi_percentile := 95.0
    else
        rsi_percentile := 99.0

    // çŠ¶æ€åˆ¤æ–­ (ä½¿ç”¨ Z-Score)
    status_text = rsi_zscore < -2 ? "ğŸŸ¢ EXTREME OVERSOLD" :
                  rsi_zscore < -1.5 ? "ğŸŸ¡ OVERSOLD" :
                  rsi_zscore > 2 ? "ğŸ”´ EXTREME OVERBOUGHT" :
                  rsi_zscore > 1.5 ? "ğŸŸ  OVERBOUGHT" : "âšª NEUTRAL"
    
    status_color = rsi_zscore < -1.5 ? color_bull : rsi_zscore > 1.5 ? color_bear : color.gray

    // å­—ä½“å¤§å°è½¬æ¢
    txt_size_title = dashboard_size == "Tiny" ? size.tiny : dashboard_size == "Small" ? size.small : dashboard_size == "Normal" ? size.normal : size.large
    txt_size_body = dashboard_size == "Tiny" ? size.tiny : dashboard_size == "Small" ? size.tiny : dashboard_size == "Normal" ? size.small : size.normal
    
    // èƒŒç¦»çŠ¶æ€
    div_text = bullish_divergence ? "ğŸŸ¢ BULL" : bearish_divergence ? "ğŸ”´ BEAR" : "â€”"
    div_color = bullish_divergence ? #00BCD4 : bearish_divergence ? #FF9800 : color.gray
    
    // å…±æŒ¯çŠ¶æ€ (ä½¿ç”¨åŠ¨æ€çš„æœ‰æ•ˆæ—¶é—´æ¡†æ¶æ•°)
    resonance_text = oversold_resonance ? "ğŸŸ¢ " + str.tostring(oversold_count) + "/" + str.tostring(valid_tf_count) : 
                     overbought_resonance ? "ğŸ”´ " + str.tostring(overbought_count) + "/" + str.tostring(valid_tf_count) : 
                     "âšª " + str.tostring(math.max(oversold_count, overbought_count)) + "/" + str.tostring(valid_tf_count)
    resonance_color = oversold_resonance ? color_bull : overbought_resonance ? color_bear : color.gray

    // è®¡ç®—è¡Œæ•°: Liteæ¨¡å¼4è¡Œ(å«Lookback), Fullæ¨¡å¼æ ¹æ®å¯ç”¨åŠŸèƒ½è®¡ç®—
    lite_rows = 4
    full_rows = 4 + (enable_mtf and dashboard_mode == "Full" ? 2 : 0) + (enable_divergence and dashboard_mode == "Full" ? 1 : 0) + (enable_stats and dashboard_mode == "Full" ? 9 : 0)
    total_rows = dashboard_mode == "Lite" ? lite_rows : full_rows

    // åˆ›å»ºè¡¨æ ¼ - æ·±è“ç°è‰²èƒŒæ™¯æ›´æ˜“è¯»
    var table dashboard = table.new(position.top_right, 2, 17, 
                                     bgcolor=color.new(#1a1a2e, dashboard_transparency),
                                     border_width=1, border_color=color.new(#4a4a6a, 50))
    
    if barstate.islast
        row = 0
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // æ ¸å¿ƒä¿¡æ¯ (Lite & Full å…±äº«)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // æ ‡é¢˜è¡Œ - ä»…æ˜¾ç¤ºRSIå€¼
        table.cell(dashboard, 0, row, "ADAPTIVE RSI", text_color=color.white, text_size=txt_size_title, bgcolor=color.new(#2962FF, dashboard_transparency))
        table.cell(dashboard, 1, row, str.tostring(rsi, "#.0"), text_color=color_rsi, text_size=txt_size_title, bgcolor=color.new(#2962FF, dashboard_transparency))
        row += 1
        
        // Z-Scoreè¡Œ - æ˜¾ç¤ºZå€¼å’Œå¯¹åº”çš„è¿‘ä¼¼ç™¾åˆ†ä½
        zscore_approx_pct = f_zscore_to_percentile(rsi_zscore)
        zscore_display = str.tostring(rsi_zscore, "#.2") + "Ïƒ (â‰ˆP" + str.tostring(zscore_approx_pct, "#") + ")"
        table.cell(dashboard, 0, row, "Z-Score", text_color=color.gray, text_size=txt_size_body)
        table.cell(dashboard, 1, row, zscore_display, text_color=status_color, text_size=txt_size_body)
        row += 1
        
        // ç™¾åˆ†ä½è¡Œ - æ˜¾ç¤ºç™¾åˆ†ä½å’Œå¯¹åº”çš„Z-ScoreèŒƒå›´
        pct_zscore_range = f_percentile_zscore_range(rsi_percentile)
        percentile_display = "P" + str.tostring(rsi_percentile, "#") + pct_zscore_range
        table.cell(dashboard, 0, row, "Percentile", text_color=color.gray, text_size=txt_size_body)
        table.cell(dashboard, 1, row, percentile_display, text_color=status_color, text_size=txt_size_body)
        row += 1
        
        // çŠ¶æ€ + è¶‹åŠ¿
        table.cell(dashboard, 0, row, "Status", text_color=color.gray, text_size=txt_size_body)
        table.cell(dashboard, 1, row, status_text + " " + trend_text, text_color=status_color, text_size=txt_size_body)
        row += 1
        
        // Lookback ä¿¡æ¯ (æ˜¾ç¤ºæ¨¡å¼å’Œå¥åº·åº¦)
        lookback_mode_display = lookback_mode == "Auto" ? "[Auto]" : "[Custom]"
        health_icons = (health_sample_coverage ? "âœ…" : "âš ï¸") + (health_distribution_spread ? "âœ…" : "âš ï¸") + (health_stat_valid ? "âœ…" : "âš ï¸")
        lookback_color = health_sample_coverage and health_distribution_spread and health_stat_valid ? color.white : color.yellow
        table.cell(dashboard, 0, row, "Lookback " + lookback_mode_display, text_color=color.gray, text_size=txt_size_body)
        table.cell(dashboard, 1, row, str.tostring(lookback) + " " + health_icons, text_color=lookback_color, text_size=txt_size_body)
        row += 1
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Full æ¨¡å¼é¢å¤–ä¿¡æ¯
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        if dashboard_mode == "Full"
            // MTF éƒ¨åˆ† (ä½¿ç”¨æ ¼å¼åŒ–åçš„æ—¶é—´æ¡†æ¶åç§°)
            if enable_mtf
                table.cell(dashboard, 0, row, "MTF " + mtf_tf1_display + "|" + mtf_tf2_display + "|" + mtf_tf3_display, text_color=color.gray, text_size=txt_size_body)
                table.cell(dashboard, 1, row, f_status_text(status_tf1) + "|" + f_status_text(status_tf2) + "|" + f_status_text(status_tf3), text_color=color.white, text_size=txt_size_body)
                row += 1
                
                table.cell(dashboard, 0, row, "Resonance", text_color=color.gray, text_size=txt_size_body)
                table.cell(dashboard, 1, row, resonance_text, text_color=resonance_color, text_size=txt_size_body)
                row += 1
            
            // èƒŒç¦»éƒ¨åˆ† (æ˜¾ç¤ºå½“å‰æ¨¡å¼å’Œå‚æ•°)
            if enable_divergence
                div_mode_display = div_mode == "Auto" ? "[" + active_div_mode + "]" : ""
                table.cell(dashboard, 0, row, "Divergence " + div_mode_display, text_color=color.gray, text_size=txt_size_body)
                table.cell(dashboard, 1, row, div_text + " (" + str.tostring(div_lookback) + "/" + str.tostring(div_range) + ")", text_color=div_color, text_size=txt_size_body)
                row += 1
            
            // ç»Ÿè®¡éƒ¨åˆ† (æ ¼å¼: ä¿¡å·å(æ¬¡æ•°) | æ”¶ç›Š% | èƒœç‡%)
            if enable_stats
                table.cell(dashboard, 0, row, "â”€â”€ STATS â”€â”€", text_color=color.gray, text_size=txt_size_body)
                table.cell(dashboard, 1, row, "(" + str.tostring(stats_forward_bars) + " bars)", text_color=color.gray, text_size=txt_size_body)
                row += 1
                
                // ğŸŒŸ MTF å…±æŒ¯
                table.cell(dashboard, 0, row, "ğŸŒŸ MTF Buy(" + str.tostring(mtf_buy_count) + ")", text_color=#FFD700, text_size=txt_size_body)
                table.cell(dashboard, 1, row, str.tostring(mtf_buy_avg, "+#.1;-#.1") + "% | " + str.tostring(mtf_buy_winrate, "#") + "%", text_color=color_bull, text_size=txt_size_body)
                row += 1
                table.cell(dashboard, 0, row, "ğŸŒŸ MTF Sell(" + str.tostring(mtf_sell_count) + ")", text_color=#FFD700, text_size=txt_size_body)
                table.cell(dashboard, 1, row, str.tostring(mtf_sell_avg, "+#.1;-#.1") + "% | " + str.tostring(mtf_sell_winrate, "#") + "%", text_color=color_bear, text_size=txt_size_body)
                row += 1
                
                // ğŸ’ èƒŒç¦»+æç«¯
                table.cell(dashboard, 0, row, "ğŸ’ Div Buy(" + str.tostring(div_buy_count) + ")", text_color=#00BCD4, text_size=txt_size_body)
                table.cell(dashboard, 1, row, str.tostring(div_buy_avg, "+#.1;-#.1") + "% | " + str.tostring(div_buy_winrate, "#") + "%", text_color=color_bull, text_size=txt_size_body)
                row += 1
                table.cell(dashboard, 0, row, "ğŸ’ Div Sell(" + str.tostring(div_sell_count) + ")", text_color=#00BCD4, text_size=txt_size_body)
                table.cell(dashboard, 1, row, str.tostring(div_sell_avg, "+#.1;-#.1") + "% | " + str.tostring(div_sell_winrate, "#") + "%", text_color=color_bear, text_size=txt_size_body)
                row += 1
                
                // ğŸ”¥ æç«¯
                table.cell(dashboard, 0, row, "ğŸ”¥ Ext Buy(" + str.tostring(ext_buy_count) + ")", text_color=color_bull, text_size=txt_size_body)
                table.cell(dashboard, 1, row, str.tostring(ext_buy_avg, "+#.1;-#.1") + "% | " + str.tostring(ext_buy_winrate, "#") + "%", text_color=color_bull, text_size=txt_size_body)
                row += 1
                table.cell(dashboard, 0, row, "â„ï¸ Ext Sell(" + str.tostring(ext_sell_count) + ")", text_color=color_bear, text_size=txt_size_body)
                table.cell(dashboard, 1, row, str.tostring(ext_sell_avg, "+#.1;-#.1") + "% | " + str.tostring(ext_sell_winrate, "#") + "%", text_color=color_bear, text_size=txt_size_body)
                row += 1
                
                // æ™®é€šä¿¡å·
                table.cell(dashboard, 0, row, "â¬†ï¸ Norm Buy(" + str.tostring(norm_buy_count) + ")", text_color=color.new(color_bull, 30), text_size=txt_size_body)
                table.cell(dashboard, 1, row, str.tostring(norm_buy_avg, "+#.1;-#.1") + "% | " + str.tostring(norm_buy_winrate, "#") + "%", text_color=color_bull, text_size=txt_size_body)
                row += 1
                table.cell(dashboard, 0, row, "â¬‡ï¸ Norm Sell(" + str.tostring(norm_sell_count) + ")", text_color=color.new(color_bear, 30), text_size=txt_size_body)
                table.cell(dashboard, 1, row, str.tostring(norm_sell_avg, "+#.1;-#.1") + "% | " + str.tostring(norm_sell_winrate, "#") + "%", text_color=color_bear, text_size=txt_size_body)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â–¶ ALERTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// æç«¯è­¦æŠ¥
alertcondition(extreme_oversold and enable_extreme_alerts, 
               title="ğŸŸ¢ Extreme Oversold / æç«¯è¶…å–", 
               message="{{ticker}}: RSI crossed below P5 ({{plot_0}}). Extreme oversold condition detected!")

alertcondition(extreme_overbought and enable_extreme_alerts, 
               title="ğŸ”´ Extreme Overbought / æç«¯è¶…ä¹°", 
               message="{{ticker}}: RSI crossed above P95 ({{plot_0}}). Extreme overbought condition detected!")

// æ™®é€šè­¦æŠ¥
alertcondition(normal_oversold and enable_normal_alerts, 
               title="ğŸŸ¡ Oversold / è¶…å–", 
               message="{{ticker}}: RSI crossed below P10 ({{plot_0}}). Oversold condition detected.")

alertcondition(normal_overbought and enable_normal_alerts, 
               title="ğŸŸ  Overbought / è¶…ä¹°", 
               message="{{ticker}}: RSI crossed above P90 ({{plot_0}}). Overbought condition detected.")

// ç»¼åˆè­¦æŠ¥
alertcondition(extreme_oversold or extreme_overbought, 
               title="âš¡ Any Extreme Signal / ä»»æ„æç«¯ä¿¡å·", 
               message="{{ticker}}: Extreme RSI signal detected at {{plot_0}}")

// MTF å…±æŒ¯è­¦æŠ¥
alertcondition(enable_mtf and oversold_resonance and raw_extreme_oversold, 
               title="ğŸŒŸ MTF Oversold Resonance / å¤šå‘¨æœŸè¶…å–å…±æŒ¯", 
               message="{{ticker}}: Multiple timeframes showing oversold condition - Strong buy signal!")

alertcondition(enable_mtf and overbought_resonance and raw_extreme_overbought, 
               title="ğŸŒŸ MTF Overbought Resonance / å¤šå‘¨æœŸè¶…ä¹°å…±æŒ¯", 
               message="{{ticker}}: Multiple timeframes showing overbought condition - Strong sell signal!")

// èƒŒç¦»è­¦æŠ¥
alertcondition(enable_divergence and bullish_divergence, 
               title="ğŸ’ Bullish Divergence / çœ‹æ¶¨èƒŒç¦»", 
               message="{{ticker}}: RSI bullish divergence detected - Price making lower low but RSI making higher low")

alertcondition(enable_divergence and bearish_divergence, 
               title="ğŸ’ Bearish Divergence / çœ‹è·ŒèƒŒç¦»", 
               message="{{ticker}}: RSI bearish divergence detected - Price making higher high but RSI making lower high")

// è¶‹åŠ¿å˜åŒ–è­¦æŠ¥
alertcondition(ta.crossover(rsi, rsi_p50), 
               title="ğŸ“ˆ Trend Shift Bullish / è¶‹åŠ¿è½¬å¤š", 
               message="{{ticker}}: RSI crossed above adaptive median (P50) - Trend shift to bullish")

alertcondition(ta.crossunder(rsi, rsi_p50), 
               title="ğŸ“‰ Trend Shift Bearish / è¶‹åŠ¿è½¬ç©º", 
               message="{{ticker}}: RSI crossed below adaptive median (P50) - Trend shift to bearish")
